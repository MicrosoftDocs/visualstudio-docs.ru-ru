---
title: Измерение использования памяти в приложениях
description: С помощью встроенного в отладчик средства диагностики вы можете находить утечки памяти и выявлять ее неэффективное использование.
ms.custom: seodec18
ms.date: 04/25/2018
ms.topic: tutorial
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: ef2ddd4011f807099c6bc82447f888b56f151e72
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99969416"
---
# <a name="measure-memory-usage-in-visual-studio"></a>Измерение использования памяти в Visual Studio

С помощью встроенного в отладчик средства диагностики **Использование памяти** вы сможете находить утечки памяти и выявлять ее неэффективное использование. С помощью средства "Использование памяти" можно сделать один или несколько *снимков* управляемой и собственной памяти в куче, чтобы понять влияние использования памяти типов объектов. Анализировать использование памяти также можно без подключения отладчика — нужно просто указать выполняющееся приложение. Дополнительные сведения см. в разделе [Запуск средств профилирования с отладчиком или без него](../profiling/running-profiling-tools-with-or-without-the-debugger.md).

Хотя с помощью средства **Использование памяти** можно делать снимки памяти в любой момент, для управления выполнением приложения во время анализа ошибок производительности вы можете использовать отладчик Visual Studio. Задание точек останова, пошаговое выполнение, всеобщее прерывание и другие действия отладчика могут помочь вам сосредоточиться на анализе производительности при обращении к наиболее важным ветвям кода. Выполняя эти действия, когда приложение запущено, вы сможете исключить влияние не интересующего вас кода и значительно ускорить диагностику проблем.

> [!Important]
> Средства диагностики, интегрированные в отладчик, поддерживаются для разработки приложений .NET в Visual Studio, включая ASP.NET и ASP.NET Core, машинного кода или кода C++ и смешанных программ (на основе .NET и машинного кода). Для запуска средств профилирования с отладчиком (окно **Средства диагностики**) требуется Windows 8 и более поздние версии.

В этом руководстве рассмотрены следующие задачи:

> [!div class="checklist"]
> * Создание моментальных снимков с данными об использовании памяти
> * Анализ данных использования памяти

Если средство **Использование памяти** не предоставляет необходимые данные, можно воспользоваться другими средствами профилирования в [Профилировщике производительности](../profiling/profiling-feature-tour.md#post_mortem), предоставляющими другие виды информации, которая может оказаться полезной. Как правило, проблемы производительности приложения могут вызываться другими компонентами помимо памяти, такими как ЦП, отрисовка пользовательского интерфейса или время запроса сети.

> [!NOTE]
> **Поддержка пользовательского распределителя**. Профилировщик внутренней памяти работает путем сбора данных событий [ETW](/windows-hardware/drivers/devtest/event-tracing-for-windows--etw-) выделения памяти, создаваемых во время выполнения.  Распределители в CRT и пакете Windows SDK аннотированы на уровне исходного кода, что позволяет регистрировать их данные выделения. Если вы создаете собственные распределители, любые функции, возвращающие указатель на только что выделенную память в куче, можно декорировать с использованием [__declspec](/cpp/cpp/declspec)(allocator), как показано в этом примере для myMalloc:
>
> `__declspec(allocator) void* myMalloc(size_t size)`

## <a name="collect-memory-usage-data"></a>Сбор данных об использовании памяти

1. Откройте проект для отладки в Visual Studio и установите точку останова в приложении в точке, где вы хотите начать проверку использования памяти.

    Если вы подозреваете, что в определенной области памяти может возникнуть проблема, задайте первую точку останова до ее возникновения.

    > [!TIP]
    > Так как из-за изменений в объеме выделяемой памяти создание профиля памяти для интересующей вас операции может быть затруднительно, разместите точки останова в начале и в конце операции или пройдите по ней, чтобы попробовать найти точку, в которой объем памяти изменился.

2. Установите вторую точку останова в конце функции или области кода, который требуется проанализировать, либо после возникновения предполагаемой проблемы с памятью.

3. Окно **Средства диагностики** появится автоматически, если вы не отключали эту функцию. Чтобы снова открыть окно, щелкните **Отладка** > **Окна** > **Показать средства диагностики**.

4. На панели инструментов выберите **Использование памяти**, применяя параметр **Выбор средств**.

     ![Показать средства диагностики](../profiling/media/diag-tools-select-tool-2.png "DiagToolsSelectTool")

5. Щелкните **Отладка | Начать отладку** (**Запустить** на панели инструментов или **F5**).

     По завершении загрузки приложения отображается представление "Сводка" средств диагностики.

     ![Вкладка "Сводка средств диагностики"](../profiling/media/diag-tools-summary-tab-2.png "DiagToolsSummaryTab")

     > [!NOTE]
     > Поскольку сбор данных об использовании памяти может повлиять на производительность отладки приложений, основанных на машинном коде, а также смешанных программ, по умолчанию снимки памяти выключены. Чтобы включить моментальные снимки для приложений на базе машинного кода или для смешанных программ, начните сеанс отладки (клавиша: **F5**). Когда отобразится окно **Средства диагностики**, перейдите на вкладку **Использование памяти** и выберите **Профилирование кучи**.
     >
     >  ![Включить снимки](../profiling/media/dbgdiag_mem_mixedtoolbar_enablesnapshot.png "DBGDIAG_MEM_MixedToolbar_EnableSnapshot")
     >
     >  Остановите (сочетание клавиш: **SHIFT**+**F5**) и перезапустите отладку.

6. Чтобы сделать моментальный снимок в начале сеанса отладки, на сокращенной панели инструментов **Использование памяти** выберите команду **Сделать снимок**. (Таким образом здесь также можно задать точку останова.)

    ![Сделать снимок](../profiling/media/dbgdiag_mem_mixedtoolbar_takesnapshot.png "DBGDIAG_MEM_MixedToolbar_TakeSnapshot")

     > [!TIP]
     > Чтобы получить базовые показатели для сравнения состояния памяти, сделайте снимок в начале сеанса отладки.

6. Запустите сценарий, который вызвал срабатывание первой точки останова.

7. После приостановки отладчика на первой точке останова на сокращенной панели инструментов **Использование памяти** выберите команду **Сделать снимок**.

8. Нажмите клавишу **F5**, чтобы запустить приложение до второй точки останова.

9. Теперь создайте еще один моментальный снимок.

     На этом этапе можно начать анализировать данные.

## <a name="analyze-memory-usage-data"></a>Анализ данных использования памяти
В строках сводной таблицы "Использование памяти" приводятся моментальные снимки, сделанные во время сеанса отладки, и ссылки на дополнительные подробные представления.

![Сводная таблица памяти](../profiling/media/dbgdiag_mem_summarytable.png "DBGDIAG_MEM_SummaryTable")

 Имена столбцов зависят от режима отладки, выбранного в параметрах проекта: .NET, отладка машинного кода или смешанная отладка (для .NET и машинного кода).

- В столбцах **Объекты (разн.)** и **Выделения (разл.)** указывается число объектов в .NET и внутренней памяти на момент создания моментального снимка.

- В столбце **Размер кучи (разн.)** указывается число байтов в куче .NET и в собственных кучах.

Если сделать несколько снимков, в каждой строке сводной таблицы будет отображаться разница значений с предыдущим снимком.

Чтобы выполнить анализ данных об использовании памяти, щелкните одну из ссылок, которая позволяет открыть подробный отчет об использовании памяти:

- Чтобы отобразить подробности об изменении текущего моментального снимка по сравнению с предыдущим, щелкните ссылку разницы слева от стрелки (![Увеличение объема используемой памяти](../profiling/media/prof-tour-mem-usage-up-arrow.png "Увеличение показателя использования памяти")). Красная стрелка обозначает, что объем используемой памяти увеличился, а зеленая — что он снизился.

> [!TIP]
> Чтобы быстрее выявить проблемы с памятью, типы объектов в отчетах об изменениях можно отсортировать по наибольшему увеличению общего объема (щелкните ссылку "Изменения" в столбце **Объекты (разн.)** ) или по наибольшему увеличению размера кучи (щелкните ссылку "Изменения" в столбце **Размер кучи (разн.)** ).

- Чтобы отобразить подробности только для выбранного моментального снимка, щелкните ссылку "Без изменений".

   Отчет отображается в новом окне.

### <a name="managed-types-reports"></a>Отчеты об управляемых типах
 Щелкните текущее значение в столбце **Объекты (разн.)** или **Выделения (разл.)** в сводной таблице "Использование памяти".

 ![Отчет отладчика об управляемых типах — пути к корневой папке](../profiling/media/dbgdiag_mem_managedtypesreport_pathstoroot.png "DBGDIAG_MEM_ManagedTypesReport_PathsToRoot")

 В верхней области показываются число и размер типов, зарегистрированных снимком, включая размер всех объектов, на которые ссылаются типы (**Инклюзивный размер**).

 В дереве **Пути к корню** в нижней области отображаются объекты, на которые ссылается тип, выбранный в верхней области. Сборщик мусора .NET очищает память для объекта только при освобождении последнего типа, ссылавшегося на него.

 В дереве **Объекты, на которые указывает ссылка** отображаются ссылки, активные для выбранного в верхней области типа.

 ![Представление отчета об управляемых объектах, на которые указывают ссылки](../profiling/media/dbgdiag_mem_managedtypesreport_referencedtypes.png "DBGDIAG_MEM_ManagedTypesReport_ReferencedTypes")

 Чтобы отобразить экземпляры типа, выбранного в верхней области, щелкните значок ![Значок экземпляра](../profiling/media/dbgdiag_mem_instanceicon.png "DBGDIAG_MEM_InstanceIcon").

 ![Снимок экрана: представление экземпляров в средстве использования памяти Visual Studio, в котором показана панель "Экземпляры" и панель "Пути к корню" и "Объекты, на которые указывает ссылка".](../profiling/media/dbgdiag_mem_managedtypesreport_instances.png "DBGDIAG_MEM_ManagedTypesReport_Instances")

 На панели **Экземпляры** , которая открывается в верхней области, отображаются экземпляры выбранного объекта текущего снимка. На панелях **Пути к корню** и **Объекты, на которые указывает ссылка** отображаются объекты, которые ссылаются на выбранный экземпляр, а также типы, на которые ссылается выбранный экземпляр. Если создать снимок после остановки отладчика и навести указатель мыши на ячейку в столбце **Значение**, во всплывающей подсказке отобразятся значения объекта.

### <a name="native-type-reports"></a>Отчеты о собственных типах
 Щелкните текущее значение в столбце **Выделения (разл.)** или **Размер кучи (разн.)** в сводной таблице "Использование памяти", отображаемой в окне **Средства диагностики**.

 ![Представление собственного типа](../profiling/media/dbgdiag_mem_native_typesview.png "DBGDIAG_MEM_Native_TypesView")

 В режиме **Представление типов** отображается число и размер типов, зарегистрированных снимком.

- Чтобы отобразить информацию об объектах выбранного типа, зарегистрированных снимком, щелкните значок "Экземпляры" (![Значок "Экземпляры" в столбце "Тип объекта"](../profiling/media/dbg_mma_instancesicon.png "DBG_MMA_InstancesIcon")).

     В окне **Экземпляры** отображаются все экземпляры выбранного типа. При выборе экземпляра на панели **Стек вызовов выделений** отображается стек вызовов, использованный для создания этого экземпляра.

     ![Снимок экрана: представление экземпляров в средстве использования памяти Visual Studio, в котором показана панель "Экземпляры" и панель "Стек вызовов выделений".](../profiling/media/dbgdiag_mem_native_instances.png "DBGDIAG_MEM_Native_Instances")

- Чтобы отобразить стек вызовов для выбранного типа, в раскрывающемся меню **Режим просмотра** выберите пункт **Представление стеков** .

     ![Представление стеков](../profiling/media/dbgdiag_mem_native_stacksview.png "DBGDIAG_MEM_Native_StacksView")

### <a name="change-diff-reports"></a>Отчеты об изменениях

- В окне **Средства диагностики** щелкните в необходимой ячейке сводной таблицы **Использование памяти** разницу в значениях.

   ![Выбор отчета об изменениях &#40;diff&#41;](../profiling/media/dbgdiag_mem_choosediffreport.png "DBGDIAG_MEM_ChooseDiffReport")

- Выберите моментальный снимок в списке **Сравнить с** , в котором отображаются управляемые или собственные отчеты.

   ![Выбор моментального снимка из списка "Сравнить с"](../profiling/media/dbgdiag_mem_choosecompareto.png "DBGDIAG_MEM_ChooseCompareTo")

С помощью отчета об изменениях в основной отчет можно добавить столбцы, помеченные надписью **(Разн.)** , в которых будет отображаться разница между двумя выбранными снимками. Отчет об изменениях собственных типов может выглядеть следующим образом.

![Представление собственных типов Diff](../profiling/media/dbgdiag_mem_native_typesviewdiff.png "DBGDIAG_MEM_Native_TypesViewDiff")

## <a name="blogs-and-videos"></a>Блоги и видео

[Анализ ресурсов ЦП и памяти во время отладки](https://devblogs.microsoft.com/visualstudio/analyze-cpu-memory-while-debugging/)

[Блог по Visual C++. Профилирование памяти в Visual C++ 2015](https://devblogs.microsoft.com/cppblog/memory-profiling-in-visual-c-2015/)

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы узнали, как собирать и анализировать данные об использовании памяти. Если вы уже ознакомились с [общими сведениями о профилировщике](../profiling/profiling-feature-tour.md), можно перейти к анализу данных об использовании ЦП в приложениях.

> [!div class="nextstepaction"]
> [Анализ использования ЦП](../profiling/beginners-guide-to-performance-profiling.md)
