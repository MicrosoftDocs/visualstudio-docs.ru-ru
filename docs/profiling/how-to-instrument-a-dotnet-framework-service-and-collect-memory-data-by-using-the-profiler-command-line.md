---
title: Командная строка профилировщика — инструментирование службы .NET, получение данных об использовании памяти
description: Узнайте, как использовать программы командной строки Средств профилирования Visual Studio, чтобы собирать данные о выделении памяти и сведения о времени существования объектов для службы .NET Framework.
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: how-to
ms.assetid: 2fa072fc-05fe-4420-99c0-51d2ea3ac4ce
author: mikejo5000
ms.author: mikejo
manager: jmartens
monikerRange: vs-2017
ms.workload:
- dotnet
ms.openlocfilehash: 80ca26f0f68a4c717d94055d0886a8085931c900
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99942676"
---
# <a name="how-to-instrument-a-net-framework-service-and-collect-memory-data-by-using-the-profiler-command-line"></a>Практическое руководство. Инструментирование службы .NET Framework и сбор данных об использовании памяти с помощью командной строки профилировщика

Эта статья описывает использование программ командной строки для Средств профилирования [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)] с целью инструментирования службы .NET Framework и сбора данных об использовании памяти. Вы можете собирать данные о выделении памяти или данные как о времени существования объекта, так и о выделении памяти.

> [!NOTE]
> Возможности расширенной безопасности в Windows 8 и Windows Server 2012 требовали значительных изменений в способе, которым профилировщик Visual Studio собирает данные на этих платформах. Для приложений универсальной платформы Windows также требуются новые методы сбора. См. раздел [Средства производительности в приложениях Windows 8 и Windows Server 2012](../profiling/performance-tools-on-windows-8-and-windows-server-2012-applications.md).
>
> [!NOTE]
> Вы не можете профилировать службу с помощью метода инструментирования, если ее невозможно перезапустить после запуска компьютера, например, если она запускается при запуске операционной системы.
>
> Сведения о пути к средствам профилирования см. в статье [Указание пути к программам командной строки средств профилирования](../profiling/specifying-the-path-to-profiling-tools-command-line-tools.md). На 64-разрядных компьютерах доступны 64- и 32-разрядные версии этих программ. Для использования программ командной строки профилировщика необходимо добавить путь к программам в переменную среды PATH окна командной строки или в саму команду.

## <a name="start-the-profiling-session"></a>Запуск сеанса профилирования
 Для сбора данных производительности из службы .NET Framework нужно воспользоваться средством [VSPerfCLREnv.cmd](../profiling/vsperfclrenv.md), чтобы инициализировать соответствующие переменные среды, и средством [VSInstr.exe](../profiling/vsinstr.md), чтобы создать инструментированную копию двоичного файла службы.

 Чтобы настроить компьютер, где размещается служба, для профилирования, нужно перезагрузить его. Кроме того, нужно вручную запустить службу из диспетчера служб. После этого запустите профилировщик, а затем — службу .NET Framework.

 При выполнении инструментированного компонента данные о памяти автоматически собираются в файл данных. Вы можете приостановить и возобновить сбор данных в ходе сеанса профилирования.

 Чтобы завершить сеанс профилирования, закройте службу и явным образом завершите работу профилировщика. В большинстве случаев рекомендуется сбрасывать переменные среды профилирования в конце сеанса.

#### <a name="to-begin-profiling-a-net-framework-service"></a>Начало профилирования службы .NET Framework

1. Откройте окно командной строки.

2. Используйте средство **VSInstr**, чтобы создать инструментированную версию двоичного файла службы.

3. Используйте диспетчер служб, чтобы заменить исходный двоичный файл инструментированной версией. Убедитесь, что для службы установлен ручной тип запуска.

4. Инициализируйте переменные среды профилирования. Тип:

    **VSPerfClrEnv** { **/globaltracegc** &#124; **/globaltracegclife**}

   - **/globaltracegc** и **/globaltracegclife** обеспечивают сбор данных о выделении памяти и времени существования объектов.

       |Параметр|Описание|
       |------------|-----------------|
       |**/globaltracegc**|Собирает только данные о выделении памяти.|
       |**/globaltracegclife**|Собирает данные о выделении памяти и времени существования объектов.|

5. Перезагрузите компьютер.

6. Откройте окно командной строки.

7. Запуск профилировщика. Тип:

    **VSPerfCmd**  [/start](../profiling/start.md) **:trace**  [/output](../profiling/output.md) **:** `OutputFile` [`Options`]

   - Параметр **/start: contention** инициализирует профилировщик.

   - Параметр **/output**`OutputFile` является обязательным при использовании параметра **/start**. `OutputFile` указывает имя и расположение файла данных профилирования (VSP-файла).

     С параметром **/start:sample** можно использовать любой из следующих параметров.

   > [!NOTE]
   > Параметры **/user** и **/crosssession** обычно являются обязательными для служб.

   | Параметр | Описание |
   | - | - |
   | [/user](../profiling/user-vsperfcmd.md) **:**[`Domain`**\\**]`UserName` | Указывает домен и имя пользователя учетной записи, которая является владельцем рабочего процесса ASP.NET. Этот параметр является обязательным, если процесс выполняется от имени пользователя, отличного от вошедшего в систему. Владелец процесса указан в столбце "Имя пользователя" на вкладке "Процессы" диспетчера задач Windows. |
   | [/crossession](../profiling/crosssession.md) | Включает профилирование процессов в других сеансах входа. Этот параметр является обязательным, если приложение ASP.NET выполняется в другом сеансе. Идентификатор сеанса указан в столбце **Идентификатор сеанса** на вкладке **Процессы** диспетчера задач Windows. **/CS** можно указать как краткую версию **/crosssession**. |
   | [/waitstart](../profiling/waitstart.md)[ **:** `Interval`] | Задает интервал ожидания инициализации профилировщика до возвращения ошибки (в секундах). Если значение `Interval` не указано, профилировщик ожидает в течение неограниченного срока. По умолчанию параметр **/start** возвращает ошибку немедленно. |
   | [/globaloff](../profiling/globalon-and-globaloff.md) | Для запуска профилировщика с приостановкой сбора данных добавьте параметр **/globaloff** в командную строку **/start**. Используйте параметр **/globalon** для возобновления профилирования. |
   | [/counter](../profiling/counter.md) **:** `Config` | Собирает данные из счетчика производительности процессора, указанного в файле конфигурации. Сведения счетчика добавляются в данные, собранные для каждого события профилирования. |
   | [/wincounter](../profiling/wincounter.md) **:** `WinCounterPath` | Задает счетчик производительности Windows, данные которого будут собираться во время профилирования. |
   | [/automark](../profiling/automark.md) **:** `Interval` | Используется с только с параметром **/wincounter**. Указывает время (в миллисекундах) между событиями сбора счетчика производительности Windows. Значение по умолчанию — 500 мс. |
   | [/events](../profiling/events-vsperfcmd.md) **:** `Config` | Задает события трассировки событий для Windows (ETW), собираемые во время профилирования. События трассировки событий Windows собираются в отдельный *ETL*-файл. |

8. При необходимости запустите службу.

9. Подключите профилировщик к службе. Тип:

     **VSPerfCmd /attach:** `PID`&#124;`ProcessName`

    - Указывает идентификатор процесса или имя процесса службы. Просмотреть идентификаторы и имена всех запущенных процессов можно в диспетчере задач Windows.

## <a name="control-data-collection"></a>Управление сбором данных
 Пока служба выполняется, вы можете управлять сбором данных, запуская и останавливая запись данных в файл с помощью параметров *VSPerfCmd.exe*. Управление сбором данных позволяет собирать данные на конкретных этапах выполнения программы, например при запуске или завершении работы приложения.

#### <a name="to-start-and-stop-data-collection"></a>Запуск и остановка сбора данных

- Следующие пары параметров **VSPerfCmd** запускают и останавливают сбор данных. Каждый параметр необходимо указывать в отдельной командной строке. Сбор данных можно включать и отключать несколько раз.

    |Параметр|Описание|
    |------------|-----------------|
    |[/globalon /globaloff](../profiling/globalon-and-globaloff.md)|Запускает (**/globalon**) или останавливает (**/globaloff**) сбор данных для всех процессов.|
    |[/processon](../profiling/processon-and-processoff.md) **:** `PID` [/processoff](../profiling/processon-and-processoff.md) **:** `PID`|Запускает ( **/processon**) или останавливает ( **/processoff**) сбор данных для процесса с указанным идентификатором процесса (`PID`).|
    |[/threadon](../profiling/threadon-and-threadoff.md) **:** `TID` [/threadoff](../profiling/threadon-and-threadoff.md) **:** `TID`|Запускает ( **/threadon**) или останавливает ( **/threadoff**) сбор данных для потока с указанным идентификатором потока (`TID`).|

## <a name="end-the-profiling-session"></a>Завершение сеанса профилирования
 Для завершения сеанса профилирования закройте приложение, в котором выполняется инструментированный компонент, а затем запустите **VSPerfCmd** [/shutdown](../profiling/shutdown.md), чтобы выключить профилировщик и закрыть файл данных профилирования. Команда **VSPerfClrEnv /globaloff** удаляет переменные среды, используемые для профилирования.

#### <a name="to-end-a-profiling-session"></a>Завершение сеанса профилирования

1. Остановите службу из диспетчера служб.

2. Завершите работу профилировщика. Тип:

     **VSPerfCmd /shutdown**

3. После завершения всего профилирования очистите переменные среды профилирования. Тип:

     **VSPerfClrEnv /globaloff**

     Замените инструментированный модуль исходным. При необходимости измените тип запуска службы.

4. Перезагрузите компьютер.

## <a name="see-also"></a>См. также
- [Профилирование служб](../profiling/command-line-profiling-of-services.md)
- [Представления данных в памяти .NET](../profiling/dotnet-memory-data-views.md)
