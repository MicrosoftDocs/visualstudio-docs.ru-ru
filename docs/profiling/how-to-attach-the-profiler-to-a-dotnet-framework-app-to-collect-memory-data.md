---
title: Присоединение профилировщика к .NET для сбора данных по использованию памяти
description: Сведения о том, как использовать средства профилирования Visual Studio из командной строки для подключения профилировщика к запущенному автономному (клиентскому) приложению .NET Framework и сбора данных об использовании памяти.
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: how-to
author: mikejo5000
ms.author: mikejo
manager: jmartens
monikerRange: vs-2017
ms.workload:
- dotnet
ms.openlocfilehash: e882806096696ac0d3b57c6d9916570d0e03da7e
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99958873"
---
# <a name="how-to-attach-the-profiler-to-a-net-framework-stand-alone-application-to-collect-memory-data-by-using-the-command-line"></a>Практическое руководство. Присоединение профилировщика к автономному приложению .NET Framework для сбора данных об использовании памяти с помощью командной строки

В этой статье описано, как использовать средства профилирования Visual Studio из командной строки для подключения профилировщика к запущенному автономному (клиентскому) приложению .NET Framework и сбора данных об использовании памяти.

> [!NOTE]
> Сведения о пути к средствам профилирования см. в статье [Указание пути к программам командной строки средств профилирования](../profiling/specifying-the-path-to-profiling-tools-command-line-tools.md). На 64-разрядных компьютерах доступны 64- и 32-разрядные версии этих программ. Для использования программ командной строки профилировщика необходимо добавить путь к программам в переменную среды PATH окна командной строки или в саму команду.

Для подключения к приложению .NET Framework и сбора данных по использованию памяти нужно воспользоваться программой [VSPerfCLREnv.cmd](../profiling/vsperfclrenv.md), чтобы инициализировать соответствующие переменные среды перед запуском целевого приложения. Когда профилировщик подключен к приложению, можно использовать программу *VSPerfCmd.exe* для приостановки и возобновления сбора данных.

Для завершения сеанса профилирования профилировщик необходимо отключить от всех профилируемых процессов, кроме того, необходимо явным образом завершить его работу. В большинстве случаев рекомендуется сбрасывать переменные среды профилирования в конце сеанса.

## <a name="attach-the-profiler"></a>Присоединение профилировщика

### <a name="to-attach-the-profiler-to-a-running-net-framework-application"></a>Присоединение профилировщика к выполняющемуся приложению .NET Framework

1. Откройте окно командной строки.

2. Инициализируйте переменные среды профилирования. Тип:

     **VSPerfClrEnv** {**/samplegc** &#124; **/samplegclife**} [**/samplelineoff**]

    - Параметры **/samplegc** и **/samplegclife** позволяют указать, нужно ли собирать только данные по выделению памяти или же следует собирать данные как по выделению памяти, так и по времени существования объектов. Задать нужно один и только один параметр.

        |Параметр|Описание|
        |------------|------------------|
        |**/samplegc**|Сбор данных исключительно по выделению памяти.|
        |**/samplegclife**|Сбор данных о выделении памяти и времени существования объекта.|

    - Параметр **/samplelineoff** отключает сбор сведений о номерах строк исходного кода.

3. Запуск профилировщика. Тип:

     **VSPerfCmd /start:sample /output:** `OutputFile` [`Options`]

   - Параметр [/start](../profiling/start.md)**:sample** инициализирует профилировщик.

   - Параметр [/output](../profiling/output.md)**:**`OutputFile` является обязательным для параметра **/start**. `OutputFile` указывает имя и расположение файла данных профилирования (VSP-файла).

     С параметром **/start:sample** можно использовать любой из следующих параметров.

     | Параметр | Описание |
     | - | - |
     | [/user](../profiling/user-vsperfcmd.md) **:**[`Domain`**\\**]`UserName` | Указывает домен и имя пользователя учетной записи, которая является владельцем профилируемого процесса. Этот параметр является обязательным только в том случае, если процесс выполняется в качестве пользователя, отличного от пользователя, вошедшего в систему. Владелец процесса указан в столбце "Имя пользователя" на вкладке "Процессы" диспетчера задач Windows. |
     | [/crosssession &#124; /cs](../profiling/crosssession.md) | Включает профилирование процессов в других сеансах. Этот параметр является обязательным, если приложение выполняется в другом сеансе. Идентификатор сеанса указан в столбце "Идентификатор сеанса" на вкладке "Процессы" диспетчера задач Windows. **/CS** можно указать как краткую версию **/crosssession**. |
     | [/wincounter](../profiling/wincounter.md) **:** `WinCounterPath` | Задает счетчик производительности Windows, данные которого будут собираться во время профилирования. |
     | [/automark](../profiling/automark.md) **:** `Interval` | Используется с только с параметром **/wincounter**. Указывает время (в миллисекундах) между событиями сбора счетчика производительности Windows. Значение по умолчанию — 500 мс. |

4. При необходимости запустите целевое приложение обычным образом.

5. Присоедините профилировщик к целевому приложению. Тип:

     **VSPerfCmd**  [/attach](../profiling/attach.md) **:**{`PID`&#124;`ProcName`} [[/targetclr](../profiling/targetclr.md)**:**`Version`]

    - `PID` указывает идентификатор процесса целевого приложения. `ProcessName` указывает имя процесса. Обратите внимание, что при наличии нескольких процессов с одинаковыми именами использование `ProcessName` приводит к непредсказуемым результатам. Идентификаторы всех запущенных процессов можно просмотреть в диспетчере задач Windows.

    - **/targetclr:** `Version` указывает версию профилируемой среды CLR, если в приложении загружено несколько версий среды выполнения. Необязательный элемент.

## <a name="control-data-collection"></a>Управление сбором данных

Пока целевое приложение выполняется, вы можете управлять сбором данных путем запуска и остановки записи данных в файл, используя параметры *VSPerfCmd.exe*. Управление сбором данных позволяет собирать данные на конкретных этапах выполнения программы, например при запуске или завершении работы приложения.

### <a name="to-start-and-stop-data-collection"></a>Запуск и остановка сбора данных

- Следующие пары параметров запускают и останавливают сбор данных. Каждый параметр необходимо указывать в отдельной командной строке. Сбор данных можно включать и отключать несколько раз.

    |Параметр|Описание|
    |------------|-----------------|
    |[/globalon /globaloff](../profiling/globalon-and-globaloff.md)|Запускает (**/globalon**) или останавливает (**/globaloff**) сбор данных для всех процессов.|
    |[/processon](../profiling/processon-and-processoff.md) **:** `PID` [/processoff](../profiling/processon-and-processoff.md) **:** `PID`|Запускает (**/processon**) или останавливает (**/processoff**) сбор данных для процесса, который указан в `PID`.|
    |[/attach](../profiling/attach.md) **:**{`PID`&#124;`ProcName`} [/detach](../profiling/detach.md)[**:**{`PID`&#124;`ProcName`}]|**/attach** запускает сбор данных для процесса с указанным идентификатором `PID` или именем процесса (ProcName). **/detach** останавливает сбор данных для указанного процесса или для всех процессов, если конкретный процесс не задан.|

## <a name="end-the-profiling-session"></a>Завершение сеанса профилирования

Для завершения сеанса профилирования профилировщик необходимо отключить от всех профилируемых процессов, кроме того, необходимо явным образом завершить его работу. Вы можете отключить профилировщик от приложения, профилируемого с помощью метода выборки, закрыв приложение или вызвав параметр **VSPerfCmd /detach**. Затем можно вызвать параметр **VSPerfCmd /shutdown**, чтобы завершить работу профилировщика и закрыть файл данных профилирования. Команда **VSPerfClrEnv /off** сбрасывает переменные среды профилирования.

### <a name="to-end-a-profiling-session"></a>Завершение сеанса профилирования

1. Выполните одно из следующих действий, чтобы отключить профилировщик от целевого приложения.

    - Введите команду **VSPerfCmd /detach**.

         -или-

    - Закройте целевое приложение.

2. Завершите работу профилировщика. Тип:

     **VSPerfCmd**  [/shutdown](../profiling/shutdown.md)

3. (Необязательно) Сбросьте переменные среды профилирования. Тип:

     **VSPerfCmd /off**

## <a name="see-also"></a>См. также

[Профилирование автономных приложений](../profiling/command-line-profiling-of-stand-alone-applications.md)
[Представления данных в памяти .NET](../profiling/dotnet-memory-data-views.md)
