---
title: Анализ данных о загрузке ЦП (ASP.NET Core)
description: Измерение производительности в приложениях ASP.NET Core с помощью средства диагностики "Загрузка ЦП"
ms.custom: mvc
ms.date: 02/14/2020
ms.topic: quickstart
helpviewer_keywords:
- Profiling Tools, quick start
- Diagnostics Tools, CPU Usage
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.workload:
- aspnet
ms.openlocfilehash: 7170983732ff1350061629e1e8aa4ec88fad3fa1
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99952841"
---
# <a name="quickstart-analyze-cpu-usage-data-in-visual-studio-aspnet-core"></a>Краткое руководство. Анализ данных по использованию ЦП в Visual Studio (ASP.NET Core)

Visual Studio предоставляет множество эффективных возможностей для анализа проблем с производительностью приложения. В этой статье вы ознакомитесь с некоторыми основными возможностями. Мы рассмотрим средство, позволяющее выявлять узкие места производительности, возникающие из-за высокой загрузки ЦП. Средства диагностики поддерживаются для разработки приложений .NET в Visual Studio, включая ASP.NET, и для разработки машинного кода или кода C++.

Центр диагностики предоставляет различные возможности по запуску сеансов диагностики и управлению ими. Если описываемое здесь средство **Загрузка ЦП** не предоставляет необходимые данные, можно воспользоваться [другими средствами профилирования](../profiling/profiling-feature-tour.md), предоставляющими другие виды информации, которая может оказаться полезной. Как правило, проблемы производительности приложения могут вызываться другими компонентами помимо ЦП, такими как память, отрисовка пользовательского интерфейса или время запроса сети. Кроме того, используя еще одно встроенное в отладчик средство профилирования [PerfTips](../profiling/perftips.md), вы можете пошагово выполнить код и узнать, сколько времени требуется для завершения работы определенных функций или выполнения блоков кода.

Для запуска средств профилирования с отладчиком (окно **Средства диагностики**) требуется Windows 8 и более поздние версии. В Windows 7 и более поздних версиях можно использовать средство последующего анализа [Профилировщик производительности](../profiling/profiling-feature-tour.md).

## <a name="create-a-project"></a>Создание проекта

1. Откройте Visual Studio и создайте проект.

   ::: moniker range="vs-2017"
   В верхней строке меню последовательно выберите **Файл** > **Создать** > **Проект**.

   В диалоговом окне **Новый проект** слева разверните узел **Visual C#** и выберите **Веб**. В средней области выберите **Веб-приложение ASP.NET Core (.NET Core)** . Назовите проект *MyProfilingApp_MVC*.

   > [!NOTE]
   > Если шаблон проекта **Простое веб-приложение ASP.NET (.NET Core)** отсутствует, щелкните ссылку **Открыть Visual Studio Installer** в левой области диалогового окна **Создать проект**. Запускается Visual Studio Installer. Выберите рабочую нагрузку **ASP.NET и разработка веб-приложений**, а затем щелкните **Изменить**.

   В открывшемся диалоговом окне выберите в средней области **MVC**, а затем нажмите кнопку **ОК**.
   ::: moniker-end
   ::: moniker range="vs-2019"
   Если окно запуска не открыто, выберите **Файл** > **Окно запуска**.

   На начальном экране выберите **Создать проект**.

   В поле поиска окна **Создание проекта** введите *asp.net*. Затем выберите **C#** в списке языков и **Windows** в списке платформ.

   Применив фильтры языка и платформы, выберите шаблон **Веб-приложение ASP.NET (.NET Core)** и нажмите кнопку **Далее**.

   > [!NOTE]
   > Если шаблон **Веб-приложение ASP.NET (.NET Core)** отсутствует, его можно установить из окна **Создание проекта**. В сообщении **Не нашли то, что искали?** выберите ссылку **Установка других средств и компонентов**. После этого в Visual Studio Installer выберите рабочую нагрузку **ASP.NET и разработка веб-приложений**.

   В поле **Имя проекта** окна **Настроить новый проект** введите *MyProfilingApp_MVC*. Затем нажмите **Создать**.

   В появившемся окне выберите **Веб-приложение (модель — представление — контроллер)** , а затем выберите **Создать**.

   ::: moniker-end

   Новый проект открывается в Visual Studio.

1. В обозревателе решений щелкните папку Models правой кнопкой мыши и выберите команду **Добавить** > **Класс**.

1. Назовите новый класс `Data.cs` и нажмите кнопку **Добавить**.

1. В обозревателе решений откройте файл `Models/Data.cs` и добавьте в его начало следующий оператор `using`:

    ```csharp
    using System.Threading;
    ```

1. В файле Data.cs замените код

    ```csharp
    public class Data
    {
    }
    ```

    следующим кодом:

    ```csharp
    public class ServerClass
    {
        const int MIN_ITERATIONS = int.MaxValue / 1000;
        const int MAX_ITERATIONS = MIN_ITERATIONS + 10000;

        long m_totalIterations = 0;
        readonly object m_totalItersLock = new object();
        // The method that will be called when the thread is started.
        public void GenerateData()
        {
            Console.WriteLine(
                "ServerClass.InstanceMethod is running on another thread.");

            var x = GetNumber();
        }

        private int GetNumber()
        {
            var rand = new Random();
            var iters = rand.Next(MIN_ITERATIONS, MAX_ITERATIONS);
            var result = 0;
            lock (m_totalItersLock)
            {
                m_totalIterations += iters;
            }
            // we're just spinning here
            // and using Random to frustrate compiler optimizations
            for (var i = 0; i < iters; i++)
            {
                result = rand.Next();
            }
            return result;
        }
    }

    public class Simple
    {
        int numberOfThreads = 200;

        public Simple()
        {
            for (int i = 0; i < numberOfThreads; i++)
            {
                CreateThreads();
            }
        }
        public static void CreateThreads()
        {
            ServerClass serverObject = new ServerClass();

            Thread InstanceCaller = new Thread(new ThreadStart(serverObject.GenerateData));
            // Start the thread.
            InstanceCaller.Start();

            Console.WriteLine("The Main() thread calls this after "
                + "starting the new InstanceCaller thread.");

        }

        public int GetData()
        {
            // Not returning any meaningful data.
            return numberOfThreads;
        }
    }
    ```

1. В обозревателе решений откройте файл *Controller/HomeControllers.cs* и замените код:

   ::: moniker range="vs-2017"

    ```csharp
    public ActionResult About()
    {
        ViewBag.Message = "Your application description page.";

        return View();
    }
    ```

    следующим кодом:

    ```csharp
    public ActionResult About()
    {
        Models.Simple s = new Models.Simple();

        ViewBag.Message = "Your application description page.";

        return View(s.GetData());
    }
    ```

    ::: moniker-end
    ::: moniker range="vs-2019"

    ```csharp
    public IActionResult Privacy()
    {
        return View();
    }
    ```

    следующим кодом:

    ```csharp
    public IActionResult Privacy()
    {
        Models.Simple s = new Models.Simple();

        return View(s.GetData());
    }
    ```

    ::: moniker-end


## <a name="step-1-collect-profiling-data"></a>Шаг 1. Сбор данных профилирования

1. Сначала установите точку останова в приложении в следующей строке кода в конструкторе `Simple`:

    `for (int i = 0; i < 200; i++)`

    Чтобы установить точку останова, щелкните во внешнем поле слева от строки кода.

1. Затем установите вторую точку останова в закрывающей фигурной скобке в конце конструктора `Simple`:

     ![Установка точек останова для профилирования](../profiling/media/quickstart-cpu-usage-breakpoints-aspnet.png)

    С помощью двух точек останова можно ограничить сбор данных частями кода, которые требуется проанализировать.

1. Окно **Средства диагностики** должно отображаться, если вы не отключали эту функцию. Чтобы снова открыть окно, щелкните **Отладка** > **Окна** > **Показать средства диагностики**.

1. Щелкните **Отладка** > **Начать отладку** (**Запустить** на панели инструментов или **F5**).

1. По завершении загрузки приложения щелкните соответствующую ссылку в верхней части веб-страницы, чтобы запустить новый код.

   ::: moniker range="vs-2017"
   В Visual Studio 2017 щелкните ссылку **Сведения**, чтобы выполнить код.
   ::: moniker-end
   ::: moniker range="vs-2019"
   В Visual Studio 2019 щелкните ссылку **Конфиденциальность**, чтобы выполнить код.
   ::: moniker-end

1. Просмотрите появившееся представление **Сводка** Средств диагностики.

1. Приостановив отладчик, включите сбор данных по загрузке ЦП, выбрав параметр **Запись профиля ЦП**, а затем откройте вкладку **Загрузка ЦП**.

     ![Средства диагностики, "Включить профилирование ЦП"](../profiling/media/quickstart-cpu-usage-summary.png)

     Когда сбор данных включен, на кнопке записи отображается красный кружок.

     При выборе параметра **Запись профиля ЦП** Visual Studio начнет записывать функции и сведения о времени их выполнения, а также будет выводить временной график, с помощью которого можно сосредоточить внимание на определенных частях сеанса профилирования. Эти собранные данные можно просматривать только в том случае, если приложение останавливается в точке останова.

6. Нажмите клавишу F5, чтобы запустить приложение до второй точки останова.

     Теперь у вас есть данные о производительности приложения именно для той области кода, которая выполняется между двумя точками останова.

     Профилировщик начинает подготавливать данные потока. Дождитесь завершения этой операции.

     Средство "Загрузка ЦП" выведет отчет на вкладке **Загрузка ЦП**.

     На этом этапе можно начать анализировать данные.

## <a name="step-2-analyze-cpu-usage-data"></a>Шаг 2. Анализ данных о загрузке ЦП

Мы рекомендуем начать анализ данных с проверки списка функций на вкладке "Загрузка ЦП" и выявления функций, выполняющих основную часть работы, а затем подробно рассмотреть каждую из этих функций.

1. В списке функций изучите функции, которые выполняют большую часть работы.

     ![Вкладка "Загрузка ЦП" в средствах диагностики](../profiling/media/quickstart-cpu-usage-cpu-aspnet.png)

    > [!TIP]
    > Функции перечисляются, начиная с тех, которые выполняют большую часть работы (а не в порядке вызова). Это позволяет быстро находить функции, которые выполнялись дольше всего.

2. В списке функций дважды щелкните функцию `MyProfilingApp_MVC.Models.ServerClass::GetNumber`.

    В левой области откроется представление **Вызывающий/вызываемый**.

    ![Представление "Вызывающий/вызываемый" в средствах диагностики](../profiling/media/quickstart-cpu-usage-caller-callee-aspnet.png)

    В этом представлении выбранная функция отображается в заголовке и в поле **Текущая функция** (в этом примере `ServerClass::GetNumber`). Функция, вызывавшая текущую функцию, отображается в левой части окна в разделе **Вызывающая функция**, а все функции, вызываемые текущей функцией, отображаются в поле **Вызываемые функции** справа. (Можно выбрать любое поле, чтобы изменить текущую функцию.)

    В этом представлении показано общее время (мс) и доля общего времени выполнения приложения, затраченного на выполнение функции.

    В поле **Тело функции** также показан общий объем времени (и доля времени), затраченного в теле функции за исключением времени, затраченного в вызываемых и вызывающих функциях. (В этом примере в теле функции затрачено 2220 из 2235 мс, а остальное время (меньше 20 мс) затрачено во внешнем коде, вызванном этой функцией.) Фактические значения будут отличаться в зависимости от среды.

    > [!TIP]
    > Высокие значения в поле **Тело функции** могут свидетельствовать о проблемах производительности внутри самой функции.

## <a name="next-steps"></a>Следующие шаги

- [Анализируйте использование памяти](../profiling/memory-usage.md) для выявления узких мест производительности.
- [Анализируйте загрузку ЦП](../profiling/cpu-usage.md) для получения более подробных сведений о загрузке ЦП.
- Анализируйте загрузку ЦП без подключения отладчика или путем указания выполняющегося приложения. Дополнительные сведения см. в разделе [Сбор данных профилирования без отладки](../profiling/running-profiling-tools-with-or-without-the-debugger.md#collect-profiling-data-without-debugging) и в статье [Выполнение средств профилирования с отладчиком и без него](../profiling/running-profiling-tools-with-or-without-the-debugger.md).

## <a name="see-also"></a>См. также

- [Профилирование в Visual Studio](../profiling/index.yml)
- [Первое знакомство со средствами профилирования](../profiling/profiling-feature-tour.md)
