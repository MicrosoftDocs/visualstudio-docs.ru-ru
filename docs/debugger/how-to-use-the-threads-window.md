---
title: Отладка многопоточного приложения
description: Отладка с помощью окна "Потоки" и панели инструментов "Место отладки" в Visual Studio
ms.date: 02/14/2020
ms.topic: how-to
dev_langs:
- CSharp
- VB
- FSharp
- C++
helpviewer_keywords:
- multithreaded debugging, tutorial
- tutorials, multithreaded debugging
ms.assetid: adfbe002-3d7b-42a9-b42a-5ac0903dfc25
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: cbde477e076203625e35ebf0109ed344679563f8
ms.sourcegitcommit: 5654b7a57a9af111a6f29239212d76086bc745c9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101683310"
---
# <a name="walkthrough-debug-a-multithreaded-app-using-the-threads-window-c-visual-basic-c"></a>Пошаговое руководство. Отладка многопоточного приложения с помощью окна "Потоки" (C#, Visual Basic, C++)

Несколько элементов пользовательского интерфейса Visual Studio позволяют отлаживать многопоточные приложения. В этой статье представлены функции многопотоковой отладки в окне редактора кода, на панели инструментов **Место отладки** и в окне **Потоки**. Дополнительные сведения о других средствах отладки многопоточных приложений см. в разделе [Начало отладки многопоточных приложений](../debugger/get-started-debugging-multithreaded-apps.md).

Выполнение этого учебника занимает всего несколько минут, в ходе которых вы ознакомитесь с основами отладки многопоточных приложений.

## <a name="create-a-multithreaded-app-project"></a>Создание проекта многопоточного приложения

Создайте следующий проект многопоточного приложения для использования в этом учебнике:

1. Откройте Visual Studio и создайте новый проект.

   ::: moniker range=">=vs-2019"

   Если окно запуска не открыто, выберите **Файл** > **Окно запуска**.

   На начальном экране выберите **Создать проект**.

   В поле поиска окна **Создание проекта** введите *консоль*. Затем выберите **C#** или **C++** в списке языков и **Windows** в списке платформ. 

   Применив фильтры по языку и платформе, выберите шаблон **Консольное приложение** для .NET Core или C++ и щелкните **Далее**.

   > [!NOTE]
   > Если нужный шаблон проекта отсутствует, перейдите в меню **Сервис** > **Получить средства и компоненты...** , после чего запустится Visual Studio Installer. Выберите рабочую нагрузку **Кроссплатформенная разработка .NET Core** или **Разработка классических приложений на C++** и щелкните **Изменить**.

   В поле **Имя проекта** окна **Настроить новый проект** введите *MyThreadWalkthroughApp*. Затем щелкните **Далее** или **Создать** в зависимости от того, какой вариант доступен.

   Для .NET Core выберите рекомендуемую версию целевой платформы (.NET Core 3.1) или .NET 5 и щелкните **Создать**.

   ::: moniker-end
   ::: moniker range="vs-2017"
   В верхней строке меню последовательно выберите **Файл**  > **Создать**  > **Проект**. В левой области диалогового окна **Создание проекта** выберите следующие элементы.

   - Для приложения C# в разделе **Visual C#** выберите **Рабочий стол Windows**, а затем в средней области выберите **Консольное приложение (.NET Framework)** .
   - Для приложения C++ в разделе **Visual C++** выберите **Рабочий стол Windows**, а затем выберите **Консольное приложение Windows**.

   Если вы не видите шаблон **Консольное приложение (.NET Framework)** или (для C++) **Консольное приложение**, выберите **Сервис** > **Получить средства и компоненты**, после чего запустится Visual Studio Installer. Выберите рабочую нагрузку **Разработка классических приложений .NET** или **Разработка классических приложений на C++** , а затем нажмите кнопку **Изменить**.

   Введите имя, например *MyThreadWalkthroughApp*, и нажмите **ОК**.

   Нажмите кнопку **ОК**.
   ::: moniker-end

   Появится новый проект консольного приложения. Когда проект будет создан, откроется файл исходного кода. В зависимости от выбранного языка файл исходного кода может называться *Program.cs*, *MyThreadWalkthroughApp.cpp* или *Module1.vb*.

1. Замените код в исходном файле на пример кода C# или C++ из раздела [Начало отладки многопоточных приложений](../debugger/get-started-debugging-multithreaded-apps.md).

1. Нажмите **Файл** > **Сохранить все**.

## <a name="start-debugging"></a>Начать отладку

1. Найдите следующие строки в исходном коде:

   ```csharp
   Thread.Sleep(3000);
   Console.WriteLine();
   ```

   ```C++
   Thread::Sleep(3000);
   Console.WriteLine();
   ```

1. Установите точку останова на строке `Console.WriteLine();`, щелкнув в левом поле или выбрав строку и нажав клавишу **F9**.

   Точка останова отображается как красный кружок в левом поле рядом со строкой кода.

1. Выберите **Отладка** > **Начать отладку** или нажмите клавишу **F5**.

   Приложение запускается в режиме отладки и останавливается в точке останова.

1. В режиме приостановки откройте окно **Потоки**, выбрав **Отладка** > **Windows** > **Потоки**. Чтобы открыть или просмотреть окно **Потоки** и другие окна отладки, необходимо находиться в сеансе отладки.

## <a name="examine-thread-markers"></a>Проверка маркеров потоков

1. В исходном коде найдите строку `Console.WriteLine();`.

   1. Щелкните правой кнопкой мыши в окне **Потоки** и в меню выберите **Показывать потоки в источнике** ![Показывать потоки в источнике](../debugger/media/dbg-multithreaded-show-threads.png "ThreadMarker").

   В поле рядом со строкой исходного кода будет отображаться значок *маркера потока* ![Маркер потока](../debugger/media/dbg-thread-marker.png "Маркер потока"). маркер потока указывает, что некий поток остановлен в этом месте. Если в расположении больше одного остановленного потока, появляется значок ![несколько потоков](../debugger/media/dbg-multithreaded-show-threads.png "несколько потоков").

1. Наведите указатель мыши на маркер потока. Подсказка сообщает имя и идентификационный номер каждого остановившегося тут потока. Имена потоков могут иметь значение `<No Name>`.

   >[!TIP]
   >Чтобы различать безымянные потоки, их можно переименовать в окне **Потоки**. Щелкните поток правой кнопкой мыши и выберите пункт **Переименовать**.

1. Щелкните маркер потока в исходном коде правой кнопкой мыши, чтобы просмотреть доступные параметры в контекстном меню.

## <a name="flag-and-unflag-threads"></a>Установка и снятие отметки для потока

Вы можете помечать требующие внимания потоки, чтобы следить за ними.

Устанавливайте и снимайте метки потоков в редакторе исходного кода или в окне **Потоки**. Выберите, следует ли отображать только помеченные потоки или все потоки, в окне **Место отладки** или **Потоки**. Выбор, сделанный из любого расположения, влияет на все расположения.

### <a name="flag-and-unflag-threads-in-source-code"></a>Установка и снятие метки для потоков в исходном коде

1. Чтобы открыть панель инструментов **Место отладки**, выберите **Вид** > **Панели инструментов** > **Место отладки**. Можно также щелкнуть правой кнопкой мыши в области панели инструментов и выбрать **Место отладки**.

1. Панель инструментов **Место отладки** содержит три поля: **Процесс**, **Поток** и **Кадр стека**. Откройте раскрывающийся список **Поток** и обратите внимание на количество потоков. В списке **Поток** выполняющийся в данный момент поток помечается символом **>** .

1. В окне исходного кода наведите указатель мыши на значок маркера потока в поле и выберите значок флага (или один из пустых значков флагов) в подсказке. Значок флага становится красным.

   Можно также щелкнуть правой кнопкой мыши значок маркера потока, навести курсор на **Флаг**, а затем выбрать поток для пометки в контекстном меню.

1. На панели инструментов **Место отладки** нажмите значок **Показывать только помеченные потоки** ![Показывать помеченные потоки](../debugger/media/dbg-threads-show-flagged.png "Отобразить помеченные потоки") справа от поля **Поток**. Значок неактивен, если ни один поток не помечен.

   Теперь в раскрывающемся списке **Поток** на панели инструментов отображается только помеченный поток. Нажмите кнопку **Показывать только помеченные потоки** еще раз, чтобы снова отображались все потоки.

   >[!TIP]
   >Пометив несколько потоков, поместите курсор в редакторе кода, щелкните правой кнопкой мыши и выберите **Запустить помеченные потоки до курсора**. Обязательно выберите код, которого достигнут все потоки. **Запустить помеченные потоки до курсора** — потоки будут приостановлены в выбранной строке кода, что упрощает управление порядком выполнения путем [замораживания и размораживания потоков](#bkmk_freeze).

1. Чтобы снять или установить метку текущего выполняющегося потока, выберите флаг **Переключить состояние пометки текущего потока** слева от кнопки **Показывать только помеченные потоки**. Помечать текущий поток удобно для поиска текущего потока, когда отображаются только помеченные потоки.

1. Чтобы снять метку с потока, наведите указатель мыши на маркер потока в исходном коде и выберите значок красного флажка, чтобы удалить его, или щелкните правой кнопкой мыши маркер потока и выберите **Снять метку**.

### <a name="flag-and-unflag-threads-in-the-threads-window"></a>Установка и снятие меток для потоков в окне "Потоки"

В окне **Потоки** рядом с помеченными потоками стоит значок красного флажка, а у непомеченных потоков нет значков.

![Окно потоков](../debugger/media/dbg-threads-window.png "Окно потоков")

Выберите значок флага, чтобы изменить состояние потока на "помечено" или "не помечено" в зависимости от его текущего состояния.

Можно также щелкнуть правой кнопкой мыши строку и выбрать **Пометить**, **Снять метку** или **Снять метку для всех потоков** из контекстного меню.

На панели инструментов в окне **Потоки** также есть кнопка **Показывать только помеченные потоки** (правая из двух значков с флагом). Она работает так же, как кнопка на панели инструментов **Место отладки**, и обе кнопки управляют отображением в обоих расположениях.

### <a name="other-threads-window-features"></a>Другие функции окна "Потоки"

В окне **Потоки** выберите заголовок любого столбца, чтобы отсортировать потоки по этому столбцу. Щелкните еще раз, чтобы изменить порядок сортировки. Если отображаются все потоки, то при выборе столбца со значком флага выполняется сортировка потоков по наличию метки.

Вторым столбцом окна **Потоки** (без заголовка) является столбец **Текущий поток**. Желтая стрелка в этом столбце отмечает текущую точку выполнения.

В столбце **Расположение** показано, где каждый поток отображается в исходном коде. Щелкните стрелку "Развернуть" рядом с пунктом **Расположение** или наведите указатель мыши на пункт, чтобы отобразить частичный стек вызовов для этого потока.

>[!TIP]
>Для графического представления стеков вызовов для потоков используйте окно [Параллельные стеки](../debugger/using-the-parallel-stacks-window.md). Чтобы открыть это окно, во время отладки выберите **Отладка**> **Окна** > **Параллельные стеки**.

Помимо пунктов **Пометить**, **Снять метку** и **Снять метку для всех потоков**, в контекстном меню для окна **Поток** есть следующие элементы.

- Кнопка **Показать потоки в исходном коде**.
- **Шестнадцатеричное отображение**, которое изменяет **идентификатор потока** в окне **Потоки** с десятичного на шестнадцатеричный формат.
- [Переключиться на поток](#switch-to-another-thread) — немедленное переключение на выполнение этого потока.
- **Переименовать** — изменение имени потока.
- Команды [Замораживание и размораживание](#bkmk_freeze).

## <a name="freeze-and-thaw-thread-execution"></a><a name="bkmk_freeze"></a> Замораживание и размораживание выполнения потоков

Вы можете замораживать и размораживать (приостанавливать и возобновлять) потоки для управления порядком их выполнения. Замораживание и размораживание потоков поможет устранить проблемы параллелизма, такие как взаимоблокировки и состояния гонки.

> [!TIP]
> Для отслеживания одного потока без замораживания других потоков, что также является распространенным сценарием отладки, см. раздел [Начало отладки многопоточных приложений](../debugger/get-started-debugging-multithreaded-apps.md#bkmk_follow_a_thread).

**Закрепление и снятие закрепления потоков:**

1. В окне **Потоки** щелкните правой кнопкой мыши любой поток и нажмите **Заморозить**. Значок **паузы** в столбце **Текущий поток** указывает, что поток заморожен.

1. Выберите **Столбцы** на панели инструментов окна **Потоки**, а затем выберите **Число приостановок**, чтобы отобразить столбец **Число приостановок**. Значение числа приостановок для замороженного потока равно **1**.

1. Щелкните правой кнопкой мыши замороженный поток и выберите **Разморозить**.

   Значок **паузы** исчезает, а значение **числа приостановок** меняется на **0**.

## <a name="switch-to-another-thread"></a>Переключение на другой поток

При попытке переключиться на другой поток может появиться окно **Приложение находится в режиме приостановки выполнения**. В этом окне сообщается, что у потока нет кода, который может быть отображен текущим отладчиком. Например, вы можете выполнять отладку управляемого кода, но поток является машинным кодом. В окне предлагаются решения этой проблемы.

**Переключение на другой поток**

1. В окне **Потоки** запишите идентификатор текущего потока, который выделен желтой стрелкой в столбце **Текущий поток**. Переключитесь обратно на этот поток, чтобы продолжить работу приложения.

1. Щелкните другой поток правой кнопкой мыши и выберите **Переключиться на поток** из контекстного меню.

1. Обратите внимание, что положение желтой стрелки в окне **Потоки** изменилось. Исходный маркер текущего потока также остается в виде контура.

   Взгляните на подсказку маркера потока в редакторе исходного кода и список в раскрывающемся меню **Поток** на панели инструментов **Место отладки**. Обратите внимание, что указанный там текущий поток также изменился.

1. На панели инструментов **Место отладки** выберите другой поток из списка **Поток**. Обратите внимание, что текущий поток изменяется и в других двух расположениях.

1. В редакторе исходного кода щелкните правой кнопкой мыши маркер потока, наведите курсор на пункт **Переключиться на поток** и выберите другой поток из списка. Обратите внимание, что текущий поток изменяется во всех трех расположениях.

С помощью маркера потока в исходном коде можно переключаться только на потоки, остановленные в этом расположении. С помощью окна **Потоки** и панели инструментов **Место отладки** можно переключиться на любой поток.

Вы познакомились с основами отладки многопоточных приложений. Вы можете отслеживать, помечать и снимать метки, а также замораживать и размораживать потоки, используя окно **Потоки**, список **Поток** на панели инструментов **Место отладки** или маркеры потоков в редакторе исходного кода.

## <a name="see-also"></a>См. также
- [Отладка многопоточных приложений](../debugger/debug-multithreaded-applications-in-visual-studio.md)
- [Практическое руководство. Переключение на другой поток при отладке](../debugger/how-to-switch-to-another-thread-while-debugging.md)
