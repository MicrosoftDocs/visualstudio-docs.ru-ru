---
title: Удаленная отладка ASP.NET Core в службах IIS и Azure | Документация Майкрософт
description: Узнайте, как установить и настроить приложение ASP.NET Core в Visual Studio, развернуть его в службах IIS с помощью Azure и присоединить удаленный отладчик из Visual Studio.
ms.custom: remotedebugging
ms.date: 05/06/2020
ms.topic: conceptual
ms.assetid: a6c04b53-d1b9-4552-a8fd-3ed6f4902ce6
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.workload:
- aspnet
- dotnetcore
- azure
ms.openlocfilehash: 3ce27c692e96423bbec89914caeab3afd3e62ba4
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99947923"
---
# <a name="remote-debug-aspnet-core-on-iis-in-azure-in-visual-studio"></a>Удаленная отладка ASP.NET Core в IIS в Azure в Visual Studio

В этом руководстве вы узнаете, как установить и настроить приложение ASP.NET Core в Visual Studio, развернуть его в службах IIS с помощью Azure и присоединить удаленный отладчик из Visual Studio.

Рекомендуемый способ удаленной отладки в Azure зависит от вашего сценария:

* Сведения об отладке ASP.NET Core в Службе приложений Azure см. в статье [Отладка приложений Azure с помощью Snapshot Debugger](../debugger/debug-live-azure-applications.md). Рекомендуем использовать этот метод.
* Чтобы выполнить отладку ASP.NET Core в Службе приложений Azure с помощью более традиционных функций отладки, следуйте инструкциям в этом разделе (см. раздел [Удаленная отладка в Службе приложений Azure](#remote_debug_azure_app_service)).

    В этом сценарии необходимо развернуть приложение из Visual Studio в Azure, но не нужно вручную устанавливать или настраивать службы IIS или удаленный отладчик (эти компоненты представлены пунктирными линиями), как показано на следующем рисунке.

    ![Экран "Схема, показывающая связь между Visual Studio, Службой приложений Azure и приложением ASP.NET. Службы IIS и удаленный отладчик представлены пунктирными линиями."](../debugger/media/remote-debugger-azure-app-service.png)

* Чтобы выполнить отладку служб IIS на виртуальной машине Azure, следуйте инструкциям в этом разделе (см. раздел [Удаленная отладка на виртуальной машине Azure](#remote_debug_azure_vm)). Это позволяет использовать настроенную конфигурацию IIS, но шаги по установке и развертыванию являются более сложными.

    Для виртуальной машины Azure необходимо развернуть приложение из Visual Studio в Azure, а также вручную установить роль IIS и удаленный отладчик, как показано на следующем рисунке.

    ![Экран "Схема, показывающая связь между Visual Studio, виртуальной машиной Azure и приложением ASP.NET. Службы IIS и удаленный отладчик представлены сплошными линиями".](../debugger/media/remote-debugger-azure-vm.png)

* Сведения об отладке ASP.NET Core в Azure Service Fabric см. в разделе [Отладка удаленного приложения Service Fabric](/azure/service-fabric/service-fabric-debugging-your-application#debug-a-remote-service-fabric-application).

> [!WARNING]
> Не забудьте удалить созданные ресурсы Azure после выполнения действий, описанных в этом учебнике. Таким образом можно избежать ненужных расходов.

## <a name="prerequisites"></a>Предварительные требования

::: moniker range=">=vs-2019"
Для Visual Studio 2019 требуется выполнить действия, описанные в этой статье.
::: moniker-end
::: moniker range="vs-2017"
Для Visual Studio 2017 требуется выполнить действия, описанные в этой статье.
::: moniker-end

### <a name="network-requirements"></a>Требования к сети

Отладка между двумя компьютерами, подключенными через прокси-сервер, не поддерживается. Отладка через подключение с высокой задержкой или низкой пропускной способностью, например при подключении к Интернету по коммутируемой линии или при размещении компьютеров в разных странах, может приводить к сбоям или работать недопустимо медленно и поэтому не рекомендуется. Полный список требований см. в разделе [Требования](../debugger/remote-debugging.md#requirements_msvsmon).

## <a name="create-the-aspnet-core-application-on-the-visual-studio-computer"></a>Создание приложения ASP.NET Core на компьютере с Visual Studio

1. Создайте новое приложение ASP.NET Core.

    ::: moniker range=">=vs-2019"
    В Visual Studio 2019 нажмите **CTRL+Q**, чтобы открыть поле поиска, введите **asp.net**, выберите **Шаблоны**, а затем **Создание проекта веб-приложения ASP.NET Core**. В появившемся диалоговом окне введите имя проекта **MyASPApp** и нажмите **Создать**. Затем выберите **Веб-приложение (модель — представление — контроллер)** и нажмите **Создать**.
    ::: moniker-end
    ::: moniker range="vs-2017"
    В Visual Studio 2017 выберите **Файл > Создать > Проект**, а затем пункты **Visual C# > Веб > Веб-приложение ASP.NET Core**. В разделе шаблонов ASP.NET Core выберите **Веб-приложение (модель — представление — контроллер)** . Убедитесь, что выбрана версия ASP.NET Core 2.1, не выбран пункт **Включить поддержку Docker** и для параметра **Проверка подлинности** установлено значение **Без проверки подлинности**. Назовите проект **MyASPApp**.
    ::: moniker-end

1. Откройте файл About.cshtml.cs и установите точку останова в методе `OnGet` (в старых шаблонах откройте HomeController.cs, а затем установите точку останова в методе `About()`).

## <a name="remote-debug-aspnet-core-on-an-azure-app-service"></a><a name="remote_debug_azure_app_service"></a> Удаленная отладка ASP.NET Core в Службе приложений Azure

В Visual Studio можно быстро опубликовать и отладить приложение на полностью подготовленном экземпляре служб IIS. Однако конфигурация IIS предустановлена и ее нельзя настроить. Подробные инструкции см. в разделе [Развертывание веб-приложения ASP.NET Core в Azure с помощью Visual Studio](/aspnet/core/tutorials/publish-to-azure-webapp-using-vs). (Если вам нужна возможность настройки IIS, попробуйте выполнить отладку на [виртуальной машине Azure](#remote_debug_azure_vm).)

#### <a name="to-deploy-the-app-and-remote-debug-using-cloud-explorer"></a>Развертывание приложения и удаленная отладка с помощью Cloud Explorer

1. В Visual Studio щелкните правой кнопкой мыши узел проекта и нажмите **Опубликовать**.

    Если ранее вы настроили какие-либо профили публикации, появится панель **Опубликовать**. Щелкните **Новый профиль**.

1. Выберите **Служба приложений Azure** в диалоговом окне **Опубликовать**, нажмите **Создать** и следуйте инструкциям на экране, чтобы создать профиль.

    Подробные инструкции см. в разделе [Развертывание веб-приложения ASP.NET Core в Azure с помощью Visual Studio](/aspnet/core/tutorials/publish-to-azure-webapp-using-vs).

    ![Публикация в службу приложений Azure](../debugger/media/remotedbg_azure_app_service_profile.png)

1. В окне "Опубликовать" выберите **Изменить конфигурацию**, перейдите в конфигурацию отладки, а затем выберите **Опубликовать**.

   Для отладки приложения требуется конфигурация отладки.

1. Откройте **Cloud Explorer** (**Вид** > **Cloud Explorer**), щелкните правой кнопкой мыши экземпляр Службы приложений и выберите **Подключить отладчик**.

   Если Cloud Explorer недоступен, откройте вместо него обозреватель сервера. Затем щелкните правой кнопкой мыши экземпляр Службы приложений в обозревателе сервера и выберите **Подключить отладчик**.

1. В работающем приложении ASP.NET щелкните ссылку на страницу **Сведения**.

    В Visual Studio должна быть достигнута точка останова.

    Вот и все! Остальные шаги в этом разделе применимы к удаленной отладке на виртуальной машине Azure.

## <a name="remote-debug-aspnet-core-on-an-azure-vm"></a><a name="remote_debug_azure_vm"></a> Удаленная отладка ASP.NET Core на виртуальной машине Azure

Вы можете создать виртуальную машину Azure для Windows Server, а затем установить и настроить службы IIS и другие необходимые программные компоненты. Это занимает больше времени, чем развертывание в службе приложений Azure, и требует выполнения остальных действий в этом учебнике.

Эти процедуры были протестированы в следующих конфигурациях сервера.
* Windows Server 2012 R2 и IIS 8
* Windows Server 2016 и IIS 10
* Windows Server 2019 и IIS 10

### <a name="app-already-running-in-iis-on-the-azure-vm"></a>Приложение уже выполняется в службах IIS на виртуальной машине Azure?

Эта статья содержит инструкции по настройке базовой конфигурации IIS в Windows Server и развертыванию приложения из Visual Studio. Эти шаги помогают убедиться, что на сервере установлены необходимые компоненты, приложение работает корректно и вы готовы к удаленной отладке.

* Если приложение выполняется в службах IIS и требуется загрузить удаленный отладчик и начать отладку, перейдите на страницу [Загрузка и установка средств удаленной отладки на Windows Server](#BKMK_msvsmon).

* Если вы хотите убедиться, что приложение настроено, развернуто и правильно работает в службах IIS, чтобы можно было выполнить отладку, выполните все действия, описанные в этом разделе.

  * Прежде чем начать, выполните все действия, описанные в разделе [Установка и запуск IIS](/azure/virtual-machines/windows/quick-create-portal).

  * При открытии порта 80 в группе безопасности сети также откройте [правильный порт](#bkmk_openports) для удаленного отладчика (4024 или 4022). Таким образом вам не придется открывать его позже. Если вы используете веб-развертывание, также необходимо открыть порт 8172.

### <a name="update-browser-security-settings-on-windows-server"></a>Обновление параметров безопасности браузера в Windows Server

Если в Internet Explorer включена усиленная конфигурация безопасности (включена по умолчанию), возможно, потребуется добавить некоторые домены в качестве доверенных сайтов, чтобы можно было загрузить некоторые из компонентов веб-сервера. Добавьте доверенные сайты в разделе **Свойства обозревателя > Безопасность > Надежные сайты > Сайты**. Добавьте следующие домены.

- microsoft.com
- go.microsoft.com
- download.microsoft.com
- iis.net

При скачивании программного обеспечения вы можете получать запросы на предоставление разрешений для разных скриптов и ресурсов веб-сайта. Некоторые из этих ресурсов не являются обязательными, но для упрощения процесса щелкните **Добавить** при появлении запроса.

### <a name="install-aspnet-core-on-windows-server"></a>Установка ASP.NET Core на Windows Server

1. Установите пакет размещения .NET Core в размещающей системе. В составе пакета устанавливаются среда выполнения .NET Core, библиотека .NET Core и модуль ASP.NET Core. Более подробные инструкции см. в статье [Публикация в IIS](/aspnet/core/publishing/iis?tabs=aspnetcore2x#iis-configuration).

    Для .NET Core 3 установите [пакет размещения .NET Core](https://dotnet.microsoft.com/permalink/dotnetcore-current-windows-runtime-bundle-installer).
    Для .NET Core 2 установите [пакет размещения .NET Core для Windows Server](https://aka.ms/dotnetcore-2-windowshosting).

    > [!NOTE]
    > Если система не подключена к Интернету, перед установкой пакета размещения .NET Core для Windows Server получите и установите *[Распространяемый компонент Microsoft Visual C++ 2015](https://www.microsoft.com/download/details.aspx?id=53840)* .

3. Перезапустите систему (или выполните в командной строке команду **net stop was /y**, а затем команду **net start w3svc**, чтобы изменение системной переменной PATH вступило в силу).

## <a name="choose-a-deployment-option"></a>Выбор способа развертывания

Если вам нужна помощь в развертывании приложения в службах IIS, рассмотрите следующие варианты.

* Выполните развертывание, создав файл параметров публикации в IIS и импортировав параметры в Visual Studio. В некоторых сценариях этот способ позволяет быстро развертывать приложения. При создании файла параметров публикации разрешения автоматически настраиваются в службах IIS.

* Выполните развертывание путем публикации в локальной папке и копирования выходных данных предпочтительным методом в подготовленную папку приложения в службах IIS.

## <a name="optional-deploy-using-a-publish-settings-file"></a>(Дополнительно) Выполните развертывание с помощью файла параметров публикации

С помощью этого параметра можно создать файл параметров публикации и импортировать его в Visual Studio.

> [!NOTE]
> В этом методе используется компонент веб-развертывания, который должен быть установлен на сервере. Если вы хотите настроить веб-развертывание вручную вместо импорта параметров, можно установить веб-развертывание 3.6 вместо веб-развертывания 3.6 для серверов размещения. Однако если вы настраиваете веб-развертывание вручную, то необходимо убедиться, что папка приложения на сервере настроена с правильными значениями и разрешениями (см. [Настройка веб-сайта ASP.NET](#BKMK_deploy_asp_net)).

### <a name="configure-the-aspnet-core-web-site"></a>Настройка веб-сайта ASP.NET Core

1. В левой области диспетчера IIS в разделе **Подключения** выберите **Пулы приложений**. Откройте **DefaultAppPool** и выберите для параметра **Версия CLR .NET** значение **Без управляемого кода**. Для ASP.NET Core это обязательно. Веб-сайт по умолчанию использует DefaultAppPool.

2. Остановите и снова запустите DefaultAppPool.

### <a name="install-and-configure-web-deploy-for-hosting-servers-on-windows-server"></a>Установка и настройка веб-развертывания для серверов размещения в Windows Server

[!INCLUDE [install-web-deploy-with-hosting-server](../deployment/includes/install-web-deploy-with-hosting-server.md)]

### <a name="create-the-publish-settings-file-in-iis-on-windows-server"></a>Создание файла параметров публикации в IIS в Windows Server

[!INCLUDE [install-web-deploy-with-hosting-server](../deployment/includes/create-publish-settings-iis.md)]

### <a name="import-the-publish-settings-in-visual-studio-and-deploy"></a>Импорт параметров публикации в Visual Studio и развертывание

[!INCLUDE [install-web-deploy-with-hosting-server](../deployment/includes/import-publish-settings-vs.md)]

> [!NOTE]
> При перезапуске виртуальной машины Azure IP-адрес может измениться.

После успешного развертывания приложение должно запускаться автоматически. Если приложение не запускается из Visual Studio, запустите его в IIS, чтобы проверить корректность его выполнения. Для ASP.NET Core также необходимо убедиться, что в поле "Пул приложений" для **DefaultAppPool** задано значение **Без управляемого кода**.

1. В диалоговом окне **Параметры** включите отладку, нажав кнопку **Далее**, выберите конфигурацию **Отладка**, а затем выберите **Удалить дополнительные файлы в пункте назначения** в параметрах **Публикация файла**.

    > [!IMPORTANT]
    > Если вы выбираете конфигурацию выпуска, отладку можно отключить при публикации в файле *web.config*.

1. Щелкните **Сохранить**, а затем повторно опубликуйте приложение.

## <a name="optional-deploy-by-publishing-to-a-local-folder"></a>(Дополнительно) Развертывание путем публикации в локальной папке

Этот параметр можно использовать для развертывания приложения, если требуется скопировать приложение в IIS с помощью PowerShell или RoboCopy или скопировать файлы вручную.

### <a name="configure-the-aspnet-core-web-site-on-the-windows-server-computer"></a><a name="BKMK_deploy_asp_net"></a> Настройка веб-сайта ASP.NET Core на компьютере Windows Server

При импорте параметров публикации этот раздел можно пропустить.

1. Откройте **Диспетчер служб IIS** и перейдите к разделу **Сайты**.

2. Щелкните правой кнопкой мыши узел **Веб-сайт по умолчанию** и выберите команду **Добавить приложение**.

3. В поле **Псевдоним** задайте значение **MyASPApp**, а в поле "Пул приложений" — значение **Без управляемого кода**. В поле **Физический путь** укажите значение **C:\Publish** (сюда вы позднее развернете проект ASP.NET Core).

4. Выбрав сайт в диспетчере служб IIS, нажмите **Изменить разрешения** и убедитесь, что IUSR, IIS_IUSRS или пользователь, настроенный для пула приложений, является полномочным пользователем с правами на чтение и выполнение.

    Если вы не видите пользователей с доступом, выполните действия, чтобы добавить учетную запись IUSR в качестве пользователя с правами на чтение и выполнение.

### <a name="optional-publish-and-deploy-the-app-by-publishing-to-a-local-folder-from-visual-studio"></a>(Необязательно) Публикация и развертывание приложения путем публикации в локальной папке из Visual Studio

Если вы не используете веб-развертывание, необходимо опубликовать и развернуть приложение с помощью файловой системы или других средств. Можно начать с создания пакета с помощью файловой системы, а затем либо развернуть пакет вручную, либо использовать другие средства, такие как PowerShell, Robocopy или XCopy. В этом разделе предполагается, что вы вручную копируете пакет, если не используете веб-развертывание.

[!INCLUDE [remote-debugger-deploy-app-local](../debugger/includes/remote-debugger-deploy-app-local.md)]

### <a name="download-and-install-the-remote-tools-on-windows-server"></a><a name="BKMK_msvsmon"></a> Загрузка и установка инструментов удаленной отладки в Windows Server

Загрузите версию удаленных инструментов, которая соответствует вашей версии Visual Studio.

[!INCLUDE [remote-debugger-download](../debugger/includes/remote-debugger-download.md)]

### <a name="set-up-the-remote-debugger-on-windows-server"></a><a name="BKMK_setup"></a> Настройка удаленного отладчика в Windows Server

[!INCLUDE [remote-debugger-configuration](../debugger/includes/remote-debugger-configuration.md)]

> [!NOTE]
> Если вам нужно добавить разрешения для дополнительных пользователей, изменить режим проверки подлинности или настроить номер порта для удаленного отладчика, воспользуйтесь инструкциями по [настройке удаленного отладчика](../debugger/remote-debugging.md#configure_msvsmon).

### <a name="attach-to-the-aspnet-application-from-the-visual-studio-computer"></a><a name="BKMK_attach"></a> Подключение к приложению ASP.NET с компьютера с Visual Studio

1. На компьютере Visual Studio откройте решение, которое вы пытаетесь отладить (в этой статье мы используем **MyASPApp**).
2. В Visual Studio выберите пункт **Отладка > Присоединить к процессу** (CTRL+ALT+P).

    > [!TIP]
    > В Visual Studio 2017 и более поздних версиях можно повторно присоединиться к тому же процессу, выбрав **Отладка > Присоединиться к процессу повторно...** (SHIFT + ALT + P).

3. В поле "Квалификатор" задайте значение **\<remote computer name>** и нажмите клавишу **ВВОД**.

    Убедитесь, что Visual Studio добавляет требуемый порт в имя компьютера, которое отображается в формате **\<remote computer name>:порт**.

    ::: moniker range=">=vs-2019"
    В Visual Studio 2019 должно отображаться **\<remote computer name>:4024**.
    ::: moniker-end
    ::: moniker range="vs-2017"
    В Visual Studio 2017 должно отображаться **\<remote computer name>:4022**.
    ::: moniker-end
    Указывать порт обязательно. Если номер порта не отображается, добавьте его вручную.

4. Нажмите кнопку **Обновить**.
    В окне **Доступные процессы** должен появиться ряд процессов.

    Если вы не видите никаких процессов, попробуйте использовать IP-адрес вместо имени удаленного компьютера (указывать порт обязательно). Для получения IPv4-адреса можно использовать `ipconfig` в командной строке.

    Если вы хотите использовать кнопку **Найти**, может потребоваться [открыть UDP-порт 3702](#bkmk_openports) на сервере.

5. Установите флажок  **Показать процессы, запущенные всеми пользователями**.

6. Введите первую букву имени процесса, чтобы быстро найти приложение.

    * Если в службах IIS используется [модель внутрипроцессного размещения](/aspnet/core/host-and-deploy/aspnet-core-module?view=aspnetcore-3.1&preserve-view=true#hosting-models), выберите нужный процесс **w3wp.exe**. Начиная с .NET Core 3, это значение по умолчанию.

    * В противном случае выберите процесс **dotnet.exe**. (Это модель размещения вне процесса.)

    При наличии нескольких процессов, отображающих *w3wp.exe* или *dotnet.exe*, проверьте столбец **Имя пользователя**. В некоторых сценариях в столбце **Имя пользователя** отображается имя пула приложений, например **IIS APPPOOL\DefaultAppPool**. Если вы видите пул приложений, но он не уникален, создайте новый именованный пул приложений для отлаживаемого экземпляра приложения, после чего его можно будет найти в столбце **Имя пользователя**.

    ::: moniker range=">=vs-2019"
    ![RemoteDBG_AttachToProcess](../debugger/media/vs-2019/remotedbg-attachtoprocess-aspnetcore.png "RemoteDBG_AttachToProcess")
    ::: moniker-end
    ::: moniker range="vs-2017"
    ![RemoteDBG_AttachToProcess](../debugger/media/remotedbg-attachtoprocess-aspnetcore.png "RemoteDBG_AttachToProcess")
    ::: moniker-end

7. Нажмите кнопку **Присоединить**.

8. Откройте веб-сайт удаленного компьютера. Для этого откройте в браузере адрес **http://\<remote computer name>** .

    Должна открыться веб-страница ASP.NET.
9. В работающем приложении ASP.NET щелкните ссылку на страницу **Сведения**.

    В Visual Studio должна быть достигнута точка останова.

### <a name="troubleshooting-open-required-ports-on-windows-server"></a><a name="bkmk_openports"></a> Устранение неполадок. Откройте необходимые порты на Windows Server

В большинстве установок необходимые порты открываются при установке ASP.NET и удаленного отладчика. Однако при устранении неполадок, возникающих при развертывании, и при размещении приложения за брандмауэром может потребоваться проверить, открыты ли правильные порты.

На виртуальной машине Azure порты необходимо открывать через [группы безопасности сети](/azure/virtual-machines/windows/nsg-quickstart-portal).

Требуемые порты:

* 80 — требуется для IIS
::: moniker range=">=vs-2019"
* 4024 — требуется для удаленной отладки из Visual Studio 2019 (дополнительные сведения см. в разделе [Назначения портов удаленного отладчика](../debugger/remote-debugger-port-assignments.md)).
::: moniker-end
::: moniker range="vs-2017"
* 4022 — требуется для удаленной отладки из Visual Studio 2017 (дополнительные сведения см. в разделе [Назначения портов удаленного отладчика](../debugger/remote-debugger-port-assignments.md)).
::: moniker-end
* UDP 3702 — (необязательно) порт обнаружения позволяет использовать кнопку **Найти** при подключении к удаленному отладчику в Visual Studio.

Кроме того, эти порты уже должны быть открыты при установке ASP.NET:
- 8172 — (необязательно) требуется для веб-развертывания для развертывания приложения из Visual Studio
