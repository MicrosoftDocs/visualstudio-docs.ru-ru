---
title: Устранение неполадок отладки моментальных снимков | Документация Майкрософт
description: Сведения об устранении неполадок и известных проблемах с отладкой моментальных снимков в Visual Studio. Загрузите ICorProfiler, не вызывая простоев на рабочем сайте.
ms.custom: SEO-VS-2020
ms.date: 04/24/2019
ms.topic: troubleshooting
helpviewer_keywords:
- debugger
ms.assetid: 511a0697-c68a-4988-9e29-8d0166ca044a
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: aad883ac0c3f703b2d6a4e10d3a0ef2468cd8465
ms.sourcegitcommit: d4887ef2ca97c55e2dad9f179eec2c9631d91c95
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2021
ms.locfileid: "108798444"
---
# <a name="troubleshooting-and-known-issues-for-snapshot-debugging-in-visual-studio"></a>Устранение неполадок и известные проблемы отладки моментальных снимков в Visual Studio

Если действия, описанные в этой статье, не помогли устранить проблему, выполните поиск проблемы в [сообществе разработчиков](https://aka.ms/feedback/suggest?space=8) или сообщите о новой проблеме, выбрав **Справка** > **Отправить отзыв** > **Сообщить о проблеме** в Visual Studio.

## <a name="issue-attach-snapshot-debugger-encounters-an-http-status-code-error"></a>Проблема. При подключении Snapshot Debugger возникает ошибка кода состояния HTTP

Если во время попытки присоединения в окне **вывода** появляется приведенная ниже ошибка, возможно, это известная проблема, описанная ниже. Попробуйте предлагаемые решения, а если проблема сохранится, обратитесь по приведенному выше псевдониму.

`[TIMESTAMP] Error --- Unable to Start Snapshot Debugger - Attach Snapshot Debugger failed: System.Net.WebException: The remote server returned an error: (###) XXXXXX`

### <a name="401-unauthorized"></a>(401) Не авторизовано

Эта ошибка означает, что в вызове REST, выполняемом средой Visual Studio к Azure, используются недопустимые учетные данные. 

Выполните следующие шаги.

* Убедитесь в том, что у вашей учетной записи персонализации Visual Studio есть разрешения на доступ к подписке Azure и ресурсу, к которому вы присоединяетесь. Быстро определить это можно путем проверки доступности ресурса, выбрав в диалоговом окне пункт **Отладка** > **Подключить Snapshot Debugger** > **Ресурс Azure** > **Выбрать существующий** или в Cloud Explorer.
* Если ошибка сохраняется, используйте один из каналов обратной связи, указанных в начале этой статьи.

Если в вашей службе приложений подключены проверка подлинности и авторизация (EasyAuth), может возникать сообщение об ошибке стека вызовов с ошибкой 401 для LaunchAgentAsync. Убедитесь, что на портале Azure параметру **Предпринимаемое действие, если проверка подлинности для запроса не выполнена** присвоено значение **Разрешить анонимные запросы (нет действия)** и добавьте в каталог D:\Home\sites\wwwroot файл authorization.json со следующим содержимым. 

```
{
  "routes": [
    {
      "path_prefix": "/",
      "policies": {
        "unauthenticated_action": "RedirectToLoginPage"
      }
    },
    {
      "http_methods": [ "POST" ],
      "path_prefix": "/41C07CED-2E08-4609-9D9F-882468261608/api/agent",
      "policies": {
        "unauthenticated_action": "AllowAnonymous"
      }
    }
  ]
}
```

Первый маршрут эффективно защищает домен вашего приложения по аналогии с **входом с помощью [IdentityProvider]** . Второй маршрут предоставляет конечную точку AgentLaunch для SnapshotDebugger за рамками проверки подлинности, которая выполняет предварительно заданное действие, запуская агент диагностики SnapshotDebugger *только в том случае, если* для вашей службы приложений включено предварительно установленное расширение сайта SnapshotDebugger. Дополнительные сведения о конфигурации authorization.json см. в статье [Правила авторизации URL-адресов](https://azure.github.io/AppService/2016/11/17/URL-Authorization-Rules.html).

### <a name="403-forbidden"></a>(403) Запрещено

Эта ошибка означает, что разрешение отклонено. Причины могут быть разными.

Выполните следующие шаги.

* Убедитесь в том, что у вашей учетной записи Visual Studio есть допустимая подписка Azure с необходимыми для ресурса разрешениями управления доступом на основе ролей (RBAC). Для AppService проверьте наличие разрешений на [запрос](/rest/api/appservice/appserviceplans/get) плана Службы приложений, в котором размещается приложение.
* Проверьте правильность и актуальность метки времени на клиентском компьютере. Эта ошибка обычно возникает на серверах с метками времени, которые более чем на 15 минут отличаются от метки времени в запросе.
* Если ошибка сохраняется, используйте один из каналов обратной связи, указанных в начале этой статьи.

### <a name="404-not-found"></a>(404) Не найдено

Эта ошибка означает, что не удалось найти веб-сайт на сервере.

Выполните следующие шаги.

* Убедитесь в том, что в ресурсе Службы приложений, к которому вы подключаетесь, развернут и работает веб-сайт.
* Убедитесь в том, что сайт доступен по адресу https://\<resource\>.azurewebsites.net.
* Убедитесь в том, что правильно работающее пользовательское веб-приложение не возвращает код состояния 404 при доступе по адресу https://\<resource\>.azurewebsites.net.
* Если ошибка сохраняется, используйте один из каналов обратной связи, указанных в начале этой статьи.

### <a name="406-not-acceptable"></a>(406) Недопустимо

Эта ошибка означает, что сервер не может ответить на тип, указанный в заголовке Accept запроса.

Выполните следующие шаги.

* Убедитесь, что сайт доступен по адресу https://\<resource\>.azurewebsites.net.
* Убедитесь в том, что сайт не был перенесен в новые экземпляры. Snapshot Debugger использует понятие ARRAffinity для маршрутизации запросов в определенные экземпляры, которые могут периодически вызывать эту ошибку.
* Если ошибка сохраняется, используйте один из каналов обратной связи, указанных в начале этой статьи.

### <a name="409-conflict"></a>(409) Конфликт

Эта ошибка означает, что запрос конфликтует с текущим состоянием сервера.

Это известная проблема, возникающая, когда пользователь пытается присоединить Snapshot Debugger к AppService с включенной службой Application Insights. Application Insights задает для AppSettings регистр, отличный от используемого в Visual Studio, что приводит к возникновению этой проблемы.

::: moniker range=">= vs-2019"
В Visual Studio 2019 эта проблема устранена.
::: moniker-end

Выполните следующие шаги.

::: moniker range="vs-2017"

* На портале Azure проверьте, задан ли верхний регистр в AppSettings для SnapshotDebugger (SNAPSHOTDEBUGGER_EXTENSION_VERSION) и InstrumentationEngine (INSTRUMENTATIONENGINE_EXTENSION_VERSION). Если нет, измените параметры вручную, что приведет к перезапуску сайта.
::: moniker-end
* Если ошибка сохраняется, используйте один из каналов обратной связи, указанных в начале этой статьи.

### <a name="500-internal-server-error"></a>(500) Внутренняя ошибка сервера

Эта ошибка означает, что сайт полностью отключен или сервер не может обработать запрос. Snapshot Debugger работает только в выполняющихся приложениях. [Application Insights Snapshot Debugger](/azure/azure-monitor/app/snapshot-debugger) обеспечивает создание моментальных снимков при возникновении исключений и может быть более подходящим средством.

### <a name="502-bad-gateway"></a>(502) Недопустимый шлюз

Эта ошибка указывает на проблему сетевого взаимодействия на стороне сервера и может быть временной.

Выполните следующие шаги.

* Попробуйте подождать несколько минут, прежде чем снова присоединять Snapshot Debugger.
* Если ошибка сохраняется, используйте один из каналов обратной связи, указанных в начале этой статьи.

## <a name="issue-snappoint-does-not-turn-on"></a>Проблема. Точка моментальных снимков не включается

Если с точкой моментальных снимков вместо обычного значка точки моментальных снимков отображается значок предупреждения ![Значок предупреждения точки моментальных снимков](../debugger/media/snapshot-troubleshooting-snappoint-warning-icon.png "Значок предупреждения точки моментальных снимков"), значит, точка моментальных снимков не включена.

![Точка моментальных снимков не включается](../debugger/media/snapshot-troubleshooting-dont-turn-on.png "Точка моментальных снимков не включается")

Выполните следующие шаги.

1. Убедитесь в том, что у вас та же версия исходного кода, которая использовалась для сборки и развертывания приложения. Убедитесь, что вы загружаете правильные символы для развертывания. Для выполнения этого действия во время отладки моментальных снимков откройте окно **Модули** и убедитесь, что в столбце "Файл символов" отображается PDB-файл, загруженный для модуля, который вы отлаживаете. Snapshot Debugger попытается загрузить и использовать символы для вашего развертывания автоматически.

## <a name="issue-symbols-do-not-load-when-i-open-a-snapshot"></a>Проблема. при открытии моментального снимка не загружаются символы

Если отображается следующее окно, это означает, что символы не загрузились.

![Символы не загружаются](../debugger/media/snapshot-troubleshooting-symbols-wont-load.png "Символы не загружаются")

Выполните следующие шаги.

- Щелкните ссылку **Изменить параметры символов...** на этой странице. В параметрах **Отладка > Символ** добавьте каталог кэша символов. Перезапустите отладку моментального снимка после задания пути к символам.

   Символы или PDB-файлы, доступные в вашем проекте, должны соответствовать развертыванию Службы приложений. Большинство развертываний (развертывание через Visual Studio, CI/CD с помощью Azure Pipelines или Kudu и т. д.) опубликует ваши файлы символов вместе со Службой приложений. Установка каталога кэша символов позволяет Visual Studio использовать эти символы.

   ![Параметры символов](../debugger/media/snapshot-troubleshooting-symbol-settings.png "Параметры символов")

- В качестве альтернативы, если организация использует сервер символов или удаляет символы в другом пути, используйте параметры символов, чтобы загрузить правильные символы для своего развертывания.

## <a name="issue-i-cannot-see-the-attach-snapshot-debugger-option-in-the-cloud-explorer"></a>Проблема. параметр "Подключить Snapshot Debugger" не отображается в Cloud Explorer

Выполните следующие шаги.

- Убедитесь, что компонент Snapshot Debugger установлен. Откройте Visual Studio Installer и проверьте компонент **Snapshot Debugger** в рабочей нагрузке Azure.
::: moniker range="< vs-2019"
- Убедитесь, что ваше приложение поддерживается. В настоящее время поддерживаются только приложения ASP.NET (4.6.1+) и ASP.NET Core (2.0+), развернутые в Службах приложений Azure.
::: moniker-end
::: moniker range=">= vs-2019"
- Убедитесь, что ваше приложение поддерживается.
  - Служба приложений Azure. Приложения ASP.NET, выполняющиеся на платформе .NET Framework 4.6.1 или более поздней версии.
  - Служба приложений Azure. Приложения ASP.NET Core, выполняющиеся на платформе .NET Core 2.0 или более поздней версии под управлением Windows.
  - Виртуальные машины Azure (и масштабируемый набор виртуальных машин). Приложения ASP.NET, выполняющиеся на платформе .NET Framework 4.6.1 или более поздней версии.
  - Виртуальные машины Azure (и масштабируемый набор виртуальных машин). Приложения ASP.NET, выполняющиеся на платформе .NET Core 2.0 или более поздней версии под управлением Windows.
  - Служба Azure Kubernetes. Приложения ASP.NET Core, выполняющиеся на платформе .NET Core 2.2 или более поздней версии под управлением Debian 9.
  - Служба Azure Kubernetes. Приложения ASP.NET Core, выполняющиеся на платформе .NET Core 2.2 или более поздней версии под управлением Alpine 3.8.
  - Служба Azure Kubernetes. Приложения ASP.NET Core, выполняющиеся на платформе .NET Core 2.2 или более поздней версии под управлением Ubuntu 18.04.
::: moniker-end

## <a name="issue-i-only-see-throttled-snapshots-in-the-diagnostic-tools"></a>Проблема. в Средствах диагностики отображаются только регулируемые моментальные снимки

![Регулируемая точка моментальных снимков](../debugger/media/snapshot-troubleshooting-throttled-snapshots.png "Регулируемая точка моментальных снимков")

Выполните следующие шаги.

- Моментальные снимки занимают мало памяти, но для них выделяется фиксированное количество памяти. Если Snapshot Debugger обнаружит, что ваш сервер находится под большой нагрузкой памяти, он не будет делать снимки. Вы можете удалить уже полученные снимки, остановив сеанс Snapshot Debugger и повторив попытку.

::: moniker range=">= vs-2019"
## <a name="issue-snapshot-debugging-with-multiple-versions-of-the-visual-studio-gives-me-errors"></a>Проблема. отладка моментальных снимков в нескольких версиях Visual Studio выдает ошибки

Для Visual Studio 2019 необходима более новая версия расширения сайта Snapshot Debugger в Службе приложений Azure.  Эта версия несовместима с более старой версией расширения сайта Snapshot Debugger, используемой в Visual Studio 2017.  Попытка подключить Snapshot Debugger в Visual Studio 2019 к Службе приложений Azure, которая ранее была отлажена Snapshot Debugger в Visual Studio 2017, приведет к следующей ошибке.

![Несовместимое расширение сайта Snapshot Debugger для Visual Studio 2019](../debugger/media/snapshot-troubleshooting-incompatible-vs2019.png "Несовместимое расширение сайта Snapshot Debugger для Visual Studio 2019")

И наоборот, если вы используете Visual Studio 2017 для подключения Snapshot Debugger к Службе приложений Azure, которая ранее была отлажена Snapshot Debugger в Visual Studio 2019, это приведет к следующей ошибке:

![Несовместимое расширение сайта Snapshot Debugger для Visual Studio 2017](../debugger/media/snapshot-troubleshooting-incompatible-vs2017.png "Несовместимое расширение сайта Snapshot Debugger для Visual Studio 2017")

Чтобы устранить эту проблему, удалите следующие параметры приложения на портале Azure и подключите Snapshot Debugger повторно.

- INSTRUMENTATIONENGINE_EXTENSION_VERSION
- SNAPSHOTDEBUGGER_EXTENSION_VERSION
::: moniker-end

## <a name="issue-i-am-having-problems-snapshot-debugging-and-i-need-to-enable-more-logging"></a>Проблема. у меня возникают проблемы с отладкой снимков, и мне нужно включить ведение журнала

### <a name="enable-agent-logs"></a>Включение журналов агента

Чтобы включить и отключить ведение журнала агента, откройте Visual Studio и выберите *Средства > Параметры > Snapshot Debugger > Включить ведение журнала агента*. Обратите внимание, что если функция *Удалять старые журналы агента при запуске сеанса* также включена, каждое успешное вложение Visual Studio будет удалять предыдущие журналы агента.

Журналы агентов можно найти в следующей папке.

- Службы приложений.
  - Перейдите на сайт Kudu Службы приложений (то есть yourappservice.**scm**.azurewebsites.net), а затем на консоль отладки.
  - Журналы агентов хранятся в следующем каталоге:  D:\home\LogFiles\SiteExtensions\DiagnosticsAgentLogs\
- Виртуальная машина / Масштабируемые наборы виртуальных машин.
  - Войдите на виртуальную машину. Журналы агентов хранятся в следующем каталоге:  C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\<Version>\SnapshotDebuggerAgent_*.txt
- AKS
  - Перейдите к следующему каталогу: /tmp/diag/AgentLogs/*

### <a name="enable-profilerinstrumentation-logs"></a>Включите Profiler / Instrumentation Logs (журналы инструментирования)

Журналы инструментирования можно найти в следующей папке.

- Службы приложений.
  - Журналы ошибок автоматически отправляются в файл D:\Home\LogFiles\eventlog.xml. События отмечаются как `<Provider Name="Instrumentation Engine" />` или "Production Breakpoints".
- Виртуальная машина / Масштабируемые наборы виртуальных машин.
  - Войдите на виртуальную машину и откройте "Просмотр событий".
  - Откройте следующее представление: *Журналы Windows > Приложение*.
  - *Отфильтруйте текущий журнал* по *источнику события*, используя *производственные точки останова* или *ядро инструментирования*.
- AKS
  - Ведение журнала ядра инструментария происходит на /tmp/diag/log.txt (задается MicrosoftInstrumentationEngine_FileLogPath в DockerFile)
  - Ведение журнала ProductionBreakpoint происходит в /tmp/diag/shLog.txt

## <a name="known-issues"></a>Известные проблемы

- Отладка моментальных снимков с несколькими клиентами Visual Studio в одной и той же Службе приложений в настоящее время не поддерживается.
- Оптимизации Roslyn IL поддерживаются в проектах ASP.NET Core не полностью. В некоторых проектах ASP.NET Core вы не сможете увидеть некоторые переменные или использовать их в условных выражениях.
- Специальные переменные, такие как *$FUNCTION* или *$CALLER*, не могут выполняться в условных операторах или точках ведения журнала для проектов ASP.NET Core.
- Отладка моментальных снимков не работает в службах приложений, в которых включено [локальное кэширование](/azure/app-service/app-service-local-cache).
- Отладка моментальных снимков приложений API в настоящее время не поддерживается.

## <a name="site-extension-upgrade"></a>Обновление расширения сайта

Отладка моментальных снимков и Application Insights зависит от ICorProfiler, который загружается в процесс сайта и вызывает проблемы, состоящие в блокировке файлов во время обновления. Мы рекомендуем выполнить этот процесс, чтобы избежать простоя на производственном сайте.

- Создайте [слот развертывания](/azure/app-service/web-sites-staged-publishing) в Службе приложений и разверните свой сайт в слоте.
- Переключите слот с рабочей средой из Cloud Explorer в Visual Studio или с портала Azure.
- Остановите сайт слота. Завершение процесса сайта w3wp.exe во всех экземплярах займет несколько секунд.
- Обновите расширение сайта слота с сайта Kudu или портала Azure (*колонка "Служба приложений" > Средства разработки > Расширения > Обновление*).
- Запустите сайт слота. Мы рекомендуем посетить сайт, чтобы снова его подготовить.
- Переключите слот с рабочей средой.

## <a name="see-also"></a>См. также

- [Отладка в Visual Studio](../debugger/index.yml)
- [Отладка работающих приложений ASP.NET Azure с помощью Snapshot Debugger](../debugger/debug-live-azure-applications.md)
- [Отладка работающих приложений ASP.NET на Виртуальных машинах Azure и в Масштабируемых наборах виртуальных машин Azure с помощью Snapshot Debugger](../debugger/debug-live-azure-virtual-machines.md)
- [Отладка работающей службы Azure Kubernetes ASP.NET с помощью Snapshot Debugger](../debugger/debug-live-azure-kubernetes.md)
- [Ответы на часто задаваемые вопросы по отладке моментальных снимков](../debugger/debug-live-azure-apps-faq.yml)
