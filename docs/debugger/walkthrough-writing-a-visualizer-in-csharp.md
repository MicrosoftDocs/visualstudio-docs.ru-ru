---
title: Создание визуализатора на C# | Документация Майкрософт
description: Пошаговое руководство по созданию простого визуализатора на C#. Здесь приводятся шаги, выполняемые при использовании шаблона элемента визуализатора, а также без него.
ms.custom: SEO-VS-2020
ms.date: 07/02/2021
ms.topic: conceptual
dev_langs:
- CSharp
helpviewer_keywords:
- visualizers, writing
- walkthroughs [Visual Studio], visualizers
ms.assetid: 53467461-8e0f-45ee-9bc4-374bbaeaf00f
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.workload:
- dotnet
ms.openlocfilehash: 47c7fa8eaa5a735f05b338101a1aefe0601e9915
ms.sourcegitcommit: 4cd3eb514e9fa48e586279e38fe7c2e111ebb304
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/06/2021
ms.locfileid: "113298293"
---
# <a name="walkthrough-writing-a-visualizer-in-c"></a>Пошаговое руководство. Написание визуализатора на C\#

В данном пошаговом руководстве показано, как написать простой визуализатор, используя C#. Визуализатор, который будет создан в данном пошаговом руководстве, отображает содержимое строки с помощью Windows Forms. Этот простой визуализатор строки сам по себе не очень полезен, но он демонстрирует основные действия для создания более полезных визуализаторов других типов данных.

> [!NOTE]
> Отображаемые диалоговые окна и команды меню могут отличаться от описанных в справке в зависимости от действующих параметров или выпуска среды. Для изменения параметров выберите пункт **Импорт и экспорт параметров** в меню **Сервис**. Дополнительные сведения см. в разделе [Сброс параметров](../ide/environment-settings.md#reset-settings).

Код визуализатора должен быть помещен в библиотеку DLL, которая будет читаться отладчиком. Поэтому первым шагом является создание проекта библиотеки классов для библиотеки DLL.

## <a name="create-a-visualizer-manually"></a>Создание визуализатора вручную

Следуйте приведенным ниже задачам, чтобы создать визуализатор.

### <a name="to-create-a-class-library-project"></a>Создание проекта библиотеки классов

* Создайте новый проект библиотеки классов.

    ::: moniker range=">=vs-2019"
    Выберите **Файл** > **Создать** > **Проект**. В раскрывающемся списке языков выберите **C#** . В поле поиска введите **библиотека классов**, а затем выберите **Библиотека классов (.NET Framework)** . Щелкните **Далее**. В появившемся диалоговом окне введите имя `MyFirstVisualizer` и нажмите кнопку **Создать**.

    Для проекта визуализатора необходимо выбрать библиотеку классов .NET Framework, а не .NET. Несмотря на то что для работы визуализатора требуется .NET Framework, вызывающим приложением может быть .NET Core.
    ::: moniker-end
    ::: moniker range="vs-2017"
    В верхней строке меню последовательно выберите **Файл**  > **Создать**  > **Проект**. В левой области диалогового окна **Новый проект** в разделе **Visual C#** выберите **.NET Framework**, а затем в средней области выберите **Библиотека классов (.NET Framework)** .

    Введите соответствующее имя для библиотеки класса, например `MyFirstVisualizer`, а затем нажмите **Создать** или **ОК**.
    ::: moniker-end

   После создания библиотеки классов необходимо добавить ссылку на Microsoft.VisualStudio.DebuggerVisualizers.DLL, таким образом вы сможете использовать определенные там классы. Однако, перед добавлением ссылки, необходимо присвоить некоторым классам осмысленные имена.

### <a name="to-rename-class1cs-and-add-microsoftvisualstudiodebuggervisualizers"></a>Чтобы переименовать Class1.cs и добавить Microsoft.VisualStudio.DebuggerVisualizers

1. Щелкните правой кнопкой мыши Class1.cs в **обозревателе решений** и выберите команду **Переименовать** в контекстном меню.

2. Измените имя с Class1.cs на что-нибудь осмысленное, например, DebuggerSide.cs.

   > [!NOTE]
   > [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)] автоматически изменяет объявление класса в DebuggerSide.cs, чтобы оно соответствовало новому имени файла.

3. В **обозревателе решений** щелкните правой кнопкой мыши пункт **Ссылки** и в контекстном меню выберите команду **Добавить ссылку**.

4. В диалоговом окне **Добавление ссылки** на вкладке **Обзор** выберите **Обзор** и найдите Microsoft.VisualStudio.DebuggerVisualizers.DLL.

    Библиотеку DLL можно найти в подкаталоге *\<Visual Studio Install Directory>\Common7\IDE\PublicAssemblies* в каталоге установки Visual Studio.

5. Нажмите кнопку **ОК**.

6. В файле DebuggerSide.cs добавьте следующее в директивы `using`:

   ```csharp
   using Microsoft.VisualStudio.DebuggerVisualizers;
   ```

   Теперь можно приступить к написанию отладочной части кода. Этот код запускается отладчиком для отображения информации, которую требуется визуализировать. Прежде всего необходимо изменить объявление объекта `DebuggerSide` таким образом, чтобы он наследовал базовый класс `DialogDebuggerVisualizer`.

### <a name="to-inherit-from-dialogdebuggervisualizer"></a>Наследование от DialogDebuggerVisualizer

1. В DebuggerSide.cs перейдите к следующей строке кода:

   ```csharp
   public class DebuggerSide
   ```

2. Измените код на:

   ```csharp
   public class DebuggerSide : DialogDebuggerVisualizer
   ```

   `DialogDebuggerVisualizer` имеет один абстрактный метод — `Show` — который необходимо переопределить.

#### <a name="to-override-the-dialogdebuggervisualizershow-method"></a>Переопределение метода DialogDebuggerVisualizer.Show

- Добавьте следующий **метод** в класс `public class DebuggerSide`:

  ```csharp
  protected override void Show(IDialogVisualizerService windowService, IVisualizerObjectProvider objectProvider)
  {
  }
  ```

  Метод `Show` содержит код, который фактически создает диалоговое окно визуализатора или другой интерфейс пользователя и отображает сведения, которые были переданы визуализатору из отладчика. Необходимо вручную добавить код, который создает диалоговое окно и отображает информацию. В данном пошаговом руководстве для этого используется окно сообщения Windows Forms. Прежде всего необходимо добавить ссылку и директиву `using` для System.Windows.Forms.

### <a name="to-add-systemwindowsforms"></a>Добавление пространства имен System.Windows.Forms

1. В **обозревателе решений** щелкните правой кнопкой мыши пункт **Ссылки** и в контекстном меню выберите команду **Добавить ссылку**.

2. В диалоговом окне **Добавление ссылки** на вкладке **Обзор** выберите **Обзор** и найдите файл System.Windows.Forms.DLL.

    Библиотеку DLL можно найти в *C:\Windows\Microsoft.NET\Framework\v4.0.30319*.

3. Нажмите кнопку **ОК**.

4. В файле DebuggerSide.cs добавьте следующее в директивы `using`:

   ```csharp
   using System.Windows.Forms;
   ```

   Сейчас необходимо добавить некоторый код для создания и отображения пользовательского интерфейса визуализатора. Поскольку это первый визуализатор, то ограничимся написанием простого пользовательского интерфейса и используем окно сообщения.

### <a name="to-show-the-visualizer-output-in-a-dialog-box"></a>Чтобы отобразить выходные данные визуализатора в диалоговом окне

1. Добавьте следующую строку кода в метод `Show`:

   ```csharp
   MessageBox.Show(objectProvider.GetObject().ToString());
   ```

    В этом примере отсутствует код для обработки ошибок. Следует включать обработку ошибок в настоящем визуализаторе или в любом другом типе приложений.

2. В меню **Сборка** выберите команду **Собрать MyFirstVisualizer**. Построение проекта должно пройти без ошибок. Если при построении все же возникнут ошибки, исправьте их, прежде чем продолжить.

   Отладочная часть кода написана. Тем не менее, необходимо выполнить еще одно действие: добавить атрибут, который сообщает отлаживаемому объекту, какой набор классов формирует визуализатор.

### <a name="to-add-the-type-to-visualize-for-the-debuggee-side-code"></a>Добавление типа для визуализации кода на стороне отлаживаемого объекта

В коде на стороне отладчика тип для визуализации (источник объекта) для отлаживаемого кода указывается с помощью атрибута <xref:System.Diagnostics.DebuggerVisualizerAttribute>. Свойство `Target` задает тип для визуализации.

1. Добавьте следующий код атрибута в DebuggerSide.cs — после директив `using`, но перед `namespace MyFirstVisualizer`:

   ```csharp
   [assembly:System.Diagnostics.DebuggerVisualizer(
   typeof(MyFirstVisualizer.DebuggerSide),
   typeof(VisualizerObjectSource),
   Target = typeof(System.String),
   Description = "My First Visualizer")]
   ```

2. В меню **Сборка** выберите команду **Собрать MyFirstVisualizer**. Построение проекта должно пройти без ошибок. Если при построении все же возникнут ошибки, исправьте их, прежде чем продолжить.

   На этом написание вашего первого визуализатора окончено. Если вы правильно следовали описанной выше процедуре, можно построить визуализатор и установить его в [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)]. Однако перед установкой визуализатора в [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)] следует проверить, что он работает правильно. Для этого следует создать тестовое окружение, в котором визуализатор будет запускаться без установки в [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)].

### <a name="to-add-a-test-method-to-show-the-visualizer"></a>Чтобы добавить тестовый метод для запуска визуализатора

1. Добавьте следующий метод в класс `public DebuggerSide`:

   ```csharp
   public static void TestShowVisualizer(object objectToVisualize)
   {
      VisualizerDevelopmentHost visualizerHost = new VisualizerDevelopmentHost(objectToVisualize, typeof(DebuggerSide));
      visualizerHost.ShowVisualizer();
   }
   ```

2. В меню **Сборка** выберите команду **Собрать MyFirstVisualizer**. Построение проекта должно пройти без ошибок. Если при построении все же возникнут ошибки, исправьте их, прежде чем продолжить.

   Далее необходимо создать проект исполняемого файла, из которого будет вызваться библиотека DLL визуализатора. Для простоты выберите проект консольного приложения.

### <a name="to-add-a-console-application-project-to-the-solution"></a>Добавление проекта консольного приложения в решение

1. В обозревателе решений щелкните правой кнопкой мыши решение, выберите пункт **Добавить**, а затем щелкните **Новый проект**.

    ::: moniker range=">=vs-2019"

    Выберите **Файл** > **Создать** > **Проект**. В раскрывающемся списке языков выберите **C#** . В поле поиска введите **консоль** и выберите **Консольное приложение (.NET Framework)** или **Консольное приложение** для .NET. Щелкните **Далее**. В появившемся диалоговом окне введите имя `MyTestConsole` и нажмите кнопку **Создать**.

    > [!NOTE]
    > Чтобы протестировать визуализатор с помощью окружения теста, создайте консольное приложение .NET Framework. Вместо этого можно создать консольное приложение .NET, но описываемое в дальнейшем окружение теста еще не поддерживается для .NET, поэтому визуализатор необходимо будет установить, чтобы протестировать его. В этом сценарии сначала создайте консольное приложение, а затем выполните действия, описанные в разделе [Добавление объекта данных на стороне отлаживаемого объекта](#add-a-debuggee-side-data-object).
    ::: moniker-end
    ::: moniker range="vs-2017"
    В верхней строке меню последовательно выберите **Файл**  > **Создать**  > **Проект**. В левой области диалогового окна **Новый проект** в разделе **Visual C#** выберите **Рабочий стол Windows**, а затем в средней области выберите **Консольное приложение (.NET Framework)** .

    Введите соответствующее имя для библиотеки класса, например `MyTestConsole`, а затем нажмите **ОК**.
    ::: moniker-end

   Теперь необходимо добавить необходимые ссылки, чтобы программа MyTestConsole могла вызывать MyFirstVisualizer.

### <a name="to-add-necessary-references-to-mytestconsole"></a>Добавление необходимых ссылок в MyTestConsole

1. В **обозревателе решений** щелкните правой кнопкой мыши **MyTestConsole** и в контекстном меню выберите пункт **Добавить ссылку**.

2. В диалоговом окне **Добавление ссылки** на вкладке **Обзор** выберите Microsoft.VisualStudio.DebuggerVisualizers.DLL.

3. Нажмите кнопку **ОК**.

4. Щелкните правой кнопкой мыши **MyTestConsole** и выберите **Добавить ссылку** еще раз.

5. В диалоговом окне **Добавление ссылки** перейдите на вкладку **Проекты** и выберите MyFirstVisualizer.

6. Нажмите кнопку **ОК**.

   Теперь нужно добавить код, которым завершится создание тестового окружения.

### <a name="to-add-code-to-mytestconsole"></a>Добавление кода в MyTestConsole

1. Щелкните правой кнопкой мыши Program.cs в **обозревателе решений** и выберите команду **Переименовать** в контекстном меню.

2. Измените имя c Program.cs на что-нибудь более понятное, например на TestConsole.cs.

    > [!NOTE]
    > [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)] автоматически изменяет объявление класса в TestConsole.cs так, чтобы оно соответствовало новому имени файла.

3. В TestConsole.cs добавьте следующий код к директивам `using`:

   ```csharp
   using MyFirstVisualizer;
   ```

4. В метод `Main` добавьте следующий код:

   ```csharp
   String myString = "Hello, World";
   DebuggerSide.TestShowVisualizer(myString);
   ```

   Теперь все готово для проверки вашего первого визуализатора.

### <a name="to-test-the-visualizer"></a>Тестирование визуализатора

1. В **обозревателе решений** щелкните **MyTestConsole** правой кнопкой мыши и выберите в контекстном меню команду **Назначить запускаемым проектом**.

2. В меню **Отладка** выберите команду **Пуск**.

    Запускается консольное приложение, визуализатор появляется и отображает строку "Hello, World".

   Поздравляем! Вы только что создали и протестировали ваш первый визуализатор.

   Если вам удобнее вызывать визуализатор из [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)], а не из специально подготовленной тестовой программы, визуализатор необходимо установить. Дополнительные сведения см. в разделе [Практическое руководство. установить визуализатор](../debugger/how-to-install-a-visualizer.md).

::: moniker range=">=vs-2019"
## <a name="add-a-debuggee-side-data-object"></a>Добавление объекта данных на стороне отлаживаемого объекта

В этом разделе вы переключитесь с объекта данных `System.String` на пользовательский объект данных.  

1. Выберите **Файл** > **Создать** > **Проект**. В раскрывающемся списке языков выберите **C#** . В поле поиска введите **библиотека классов**, а затем выберите **Библиотека классов (.NET Framework)** или **Библиотека классов** для .NET Standard.

   >[!NOTE]
   >Если вы используете тестовое консольное приложение .NET Framework, убедитесь, что создан проект библиотеки классов .NET Framework.

1. Щелкните **Далее**. В появившемся диалоговом окне введите имя `MyDataObject` и нажмите кнопку **Создать**.

1. (Только для библиотеки классов .NET Standard) В обозревателе решений щелкните правой кнопкой мыши проект и выберите **Изменить файл проекта**. Измените значение `<TargetFramework>` на `netstandard2.0`.

1. В пространстве имен `MyDataObject` замените код по умолчанию следующим кодом.

   ```csharp
   [Serializable] 
   public class CustomDataObject
   {
      public CustomDataObject()
      {
         this.MyData = "MyTestData";
      }
      public string MyData { get; set; }
   }
   ```

   Для визуализатора, доступного только для чтения, как в этом примере, нет необходимости реализовывать методы [VisualizerObjectSource](/dotnet/api/microsoft.visualstudio.debuggervisualizers.visualizerobjectsource).

   Затем обновите проект MyFirstVisualizer, чтобы он использовал новый объект данных.

1. В обозревателе решений в проекте MyFirstVisualizer щелкните правой кнопкой мыши узел **Ссылки** и выберите команду **Добавить ссылку**.

1. В разделе **Проекты** выберите проект **MyDataObject**.

1. В коде атрибута файла DebuggerSide.cs обновите целевое значение, заменив `System.String` на `MyDataObject.CustomDataObject`.

   ```csharp
   Target = typeof(MyDataObject.CustomDataObject),
   ```

1. В проекте MyFirstVisualizer замените код метода `Show` следующим кодом.

   ```csharp
   var data = objectProvider.GetObject() as MyDataObject.CustomDataObject;

   // You can replace displayForm with your own custom Form or Control.  
   Form displayForm = new Form();
   displayForm.Text = data.MyData;
   windowService.ShowDialog(displayForm);
   ```

   Приведенный выше код использует свойство объекта данных для отображения в заголовке формы.

   Затем обновите консольное приложение, чтобы использовать пользовательский объект данных.

1. В обозревателе решений в проекте MyTestConsole щелкните правой кнопкой мыши узел **Ссылки** или **Зависимости** и добавьте ссылку на проект в `MyDataObject`.

1. В файле Program.cs замените код в методе `Main` следующим кодом.

   ```csharp
   // String myString = "Hello, World";
   CustomDataObject customDataObject = new CustomDataObject();

   DebuggerSide.TestShowVisualizer(customDataObject.MyData);
   ```

1. (Консольное приложение .NET) Заключите вызов `TestShowVisualizer` в инструкцию try-catch, поскольку окружение теста не поддерживается.

   ```csharp
   try
   {
         DebuggerSide.TestShowVisualizer(customDataObject.MyData);
   }
   catch (Exception) {
   }
   ```

   Отладчику требуется ссылка на визуализатор. Одним из способов обеспечения ссылки является сохранение предыдущего кода.

1. Для консольного приложения .NET Framework можно запустить окружение теста (нажать клавишу **F5**) или следовать инструкциям в разделе, посвященном [установке визуализатора](../debugger/how-to-install-a-visualizer.md).

   Если приложение запускается с помощью окружения теста, в приложении отображается форма Windows Forms.

1. Для консольного приложения .NET скопируйте `MyFirstVisualizer.dll` и `MyDataObject.dll` в папки, описанные в разделе, посвященном [установке визуализатора](../debugger/how-to-install-a-visualizer.md).

1. После установки визуализатора установите точку останова, запустите консольное приложение и наведите указатель мыши на `customDataObject`. Если все настроено правильно, отобразится значок лупы ![VisualizerIcon](../debugger/media/dbg-tips-visualizer-icon.png "Значок визуализатора").

   :::image type="content" source="../debugger/media/vs-2019/visualizer-csharp-data-object.png" alt-text="Значок лупы для визуализатора.":::

   При выборе **MyFirstVisualizer** с помощью значка лупы отобразится форма с текстом объекта данных в заголовке.

   ![Визуализатор с формой Windows Forms](../debugger/media/vs-2019/visualizer-csharp-windows-form.png)

::: moniker-end

::: moniker range="vs-2017"

## <a name="create-a-visualizer-using-the-visualizer-item-template"></a>Создание визуализатора с помощью шаблона элемента визуализатора

На данном пошаговом руководстве было рассмотрено, как создать визуализатор вручную. Это было сделано в качестве упражнения для обучения. Теперь, когда вы знаете, как работает простой визуализатор, можно создать его проще — с помощью шаблона элемента визуализатора.

Во–первых, необходимо создать новый проект библиотеки классов.

### <a name="to-create-a-new-class-library"></a>Чтобы создать новую библиотеку классов

1. В меню **Файл** выберите пункты **Создать > Проект**.

2. В диалоговом окне **Создание проекта** в меню **Visual C#** выберите пункт **.NET Framework**.

3. В средней области выберите **Библиотека классов**.

4. В поле **Имя** введите соответствующее имя для библиотеки класса, например MySecondVisualizer.

5. Нажмите кнопку **ОК**.

   Теперь можно добавить элемент визуализатора.

### <a name="to-add-a-visualizer-item"></a>Чтобы добавить элемент визуализатора

1. В **обозревателе решений** щелкните правой кнопкой мыши MySecondVisualizer.

2. В контекстном меню выберите команду **Добавить** и нажмите кнопку **Создать элемент**.

3. В диалоговом окне **Добавление нового элемента** в разделе **Элементы Visual C#** выберите **Визуализатор отладчика**.

4. В поле **Имя** введите соответствующее имя, например SecondVisualizer.cs.

5. Нажмите кнопку **Добавить**.

   Вот и все, что нужно! Просмотрите файл SecondVisualizer.cs для изучения кода, добавленного шаблоном. Можете поэкспериментировать с кодом. Теперь, когда вы изучили основы, вы сможете в будущем создавать свои собственные более сложные и полезные визуализаторы.
::: moniker-end

## <a name="see-also"></a>См. также

- [Архитектура визуализатора](../debugger/visualizer-architecture.md)
- [Практическое руководство. Установка визуализатора](../debugger/how-to-install-a-visualizer.md)
- [Создание настраиваемых визуализаторов](../debugger/create-custom-visualizers-of-data.md)
