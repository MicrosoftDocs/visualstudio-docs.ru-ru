---
title: Ведение журнала в многопроцессорной среде | Документы Майкрософт
description: Узнайте о новом средстве ведения журнала MSBuild с поддержкой многопроцессорных сред. Это средство также позволяет создавать пользовательские средства ведения журнала с перенаправлением.
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: conceptual
helpviewer_keywords:
- MSBuild, multi-processor logging
- MSBuild, logging
ms.assetid: dd4dae65-ed04-4883-b48d-59bcb891c4dc
author: ghogen
ms.author: ghogen
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: d58f9f29d88d7988b4ead3c2d96eadbbf95a8f46
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99966270"
---
# <a name="logging-in-a-multi-processor-environment"></a>Ведение журнала в многопроцессорной среде

Поддержка нескольких процессоров в MSBuild позволяет существенно сократить время сборки проекта, но усложняет ведение журнала. В среде с одним процессором средство ведения журнала может обрабатывать входящие события, сообщения, предупреждения и ошибки последовательно и вполне предсказуемо. Однако в многопроцессорной среде события из различных источников могут поступать одновременно или не по порядку. Система MSBuild предоставляет новое средство ведения журнала с поддержкой многопроцессорных сред, а также позволяет создавать пользовательские средства ведения журнала с переадресацией.

## <a name="log-multiple-processor-builds"></a>Ведение журнала для многопроцессорных сборок

Если выполняется сборка одного или нескольких проектов в многопроцессорной или многоядерной системе, события сборки MSBuild создаются одновременно для всех проектов. Множество данных о событиях может поступать в средство ведения журнала одновременно или не по порядку. Это может привести к переполнению средства ведения журнала и повлечь за собой увеличение времени сборки, появление неверных выходных данных или даже повреждение сборки. Для устранения этих проблем средство ведения журнала MSBuild может обрабатывать события, поступающие не по порядку, и сопоставлять события с их источниками.

Чтобы повысить эффективность функции ведения журнала, создайте пользовательское средство ведения журнала с перенаправлением. Оно действует как фильтр, позволяя выбрать перед сборкой те события, за которыми нужно вести наблюдение. Благодаря пользовательскому средству ведения журнала с переадресацией можно предотвратить переполнение средства ведения журнала ненужными событиями, загромождение журналов или замедление сборки.

### <a name="central-logging-model"></a>Централизованная модель ведения журналов

Для многопроцессорных сборок MSBuild используется "централизованную модель ведения журналов". В ней экземпляр *MSBuild.exe* выступает в качестве основного процесса сборки или "центрального узла". Дополнительные экземпляры *MSBuild.exe*, или "дополнительные узлы", присоединяются к центральному узлу. Любые основанные на ILogger средства ведения журнала, присоединенные к центральному узлу, называются "центральными средствами ведения журнала", а средства, присоединенные к дополнительным узлам, называются "дополнительными средствами ведения журнала".

В процессе сборки дополнительные средства ведения журнала перенаправляют свой трафик событий на центральные средства. Так как события исходят от нескольких дополнительных узлов, данные поступают на центральный узел одновременно, но с чередованием. Для разрешения ссылок из события на проект и из события на целевой объект аргументы событий содержат дополнительные сведения о контексте события сборки.

Хотя центральным средством ведения журнала должен реализовываться только интерфейс <xref:Microsoft.Build.Framework.ILogger>, рекомендуется также реализовать интерфейс <xref:Microsoft.Build.Framework.INodeLogger> для инициализации центрального средства ведения журнала с учетом числа узлов, участвующих в сборке. При инициализации средства ведения журнала в системе вызывается следующая перегрузка метода <xref:Microsoft.Build.Framework.ILogger.Initialize%2A>:

```csharp
public interface INodeLogger: ILogger
{
    public void Initialize(IEventSource eventSource, int nodeCount);
}
```

### <a name="distributed-logging-model"></a>Распределенная модель ведения журнала

В централизованной модели ведения журналов слишком большой трафик входящих сообщений, например при одновременном выполнении сборки множества проектов, может вызывать переполнение центрального узла, из-за чего повышается нагрузка на систему и снижается производительность сборки.

Чтобы снизить влияние этой проблемы, MSBuild также реализует "распределенную модель ведения журналов", которая расширяет централизованную модель, позволяя создавать средства ведения журнала с переадресацией. Средство ведения журнала с переадресацией подключается к дополнительному узлу и принимает от него входящие события сборки. Средство ведения журнала с переадресацией отличается от обычного лишь тем, что может фильтровать события и переадресовывать на центральный узел только нужные из них. В результате уменьшается трафик сообщений, отправляемых в центральный узел, и повышается общая производительность.

 Вы можете создать средство ведения журнала с переадресацией, реализовав интерфейс <xref:Microsoft.Build.Framework.IForwardingLogger>, который является производным от <xref:Microsoft.Build.Framework.ILogger>. Этот интерфейс определяется следующим образом:

```csharp
public interface IForwardingLogger: INodeLogger
{
    public IEventRedirector EventRedirector { get; set; }
    public int NodeId { get; set; }
}
```

Для переадресации событий в средстве ведения журнала с переадресацией вызовите метод <xref:Microsoft.Build.Framework.IEventRedirector.ForwardEvent%2A> интерфейса <xref:Microsoft.Build.Framework.IEventRedirector>. В качестве параметра передайте соответствующий <xref:Microsoft.Build.Framework.BuildEventArgs> или производный от него.

Дополнительные сведения см. в разделе [Создание средства ведения журнала с перенаправлением](../msbuild/creating-forwarding-loggers.md).

### <a name="attaching-a-distributed-logger"></a>Присоединение распределенного средства ведения журнала

Чтобы присоединить распределенное средство ведения журнала для сборки из командной строки, используйте параметр `-distributedlogger` (сокращенно `-dl`). Для указания имен типов и классов средства ведения журнала используется тот же формат, что и для параметра `-logger`, с той лишь разницей, что распределенное средство ведения журнала всегда включает два класса: средство ведения журнала с переадресацией и центральное средство ведения журнала. Ниже приведен пример присоединения распределенного средства ведения журнала:

```cmd
msbuild.exe *.proj -distributedlogger:XMLCentralLogger,MyLogger,Version=1.0.2,
Culture=neutral*XMLForwardingLogger,MyLogger,Version=1.0.2,
Culture=neutral
```

В параметре `-dl` имена двух средств ведения журнала разделены звездочкой (*).

## <a name="see-also"></a>См. также

- [Средства ведения журнала сборки](../msbuild/build-loggers.md)
- [Создание средства ведения журнала с перенаправлением](../msbuild/creating-forwarding-loggers.md)
