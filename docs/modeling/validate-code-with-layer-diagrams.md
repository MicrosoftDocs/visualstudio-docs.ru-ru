---
title: Проверка кода по схемам зависимостей
description: Сведения о том, что код не конфликтует с его конструкцией, необходимо проверить код с помощью схем зависимостей в Visual Studio.
ms.custom: SEO-VS-2020
ms.date: 09/28/2018
ms.topic: conceptual
helpviewer_keywords:
- dependency diagrams, validating
- validation, dependency diagrams
- validation, code
- code exploration, validating
- architecture, validating
- Visual Studio Ultimate, validating code
- validation, architecture
- validation, dependencies
- MSBuild, tasks
- MSBuild, dependency diagrams
- MSBuild, validating code
author: mgoertz-msft
ms.author: mgoertz
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: 1f2d62433d150f61e9a7e21cceb20eb715a0767a
ms.sourcegitcommit: e3a364c014ccdada0860cc4930d428808e20d667
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/19/2021
ms.locfileid: "112388364"
---
# <a name="validate-code-with-dependency-diagrams"></a>Проверка кода по схемам зависимостей

## <a name="why-use-dependency-diagrams"></a>Зачем использовать схемы зависимостей?

Чтобы убедиться в том, что код не конфликтует со своим дизайном, проверьте код с помощью схем зависимостей в Visual Studio. Это может помочь:

- Поиск конфликтов между зависимостями в коде и зависимостями на схеме зависимостей.

- Найти зависимости, на которые могут повлиять предложенные изменения.

   Например, можно изменить схему зависимостей, чтобы показать потенциальные изменения архитектуры, а затем проверить код, чтобы увидеть затронутые зависимости.

- Выполнить рефакторинг или миграцию кода в другую структуру.

   Найти код или зависимости, с которыми потребуется выполнить определенные действия даже после перемещения кода в другую архитектуру.

**Требования**

- Visual Studio

  Чтобы создать схему зависимостей для проекта .NET Core, необходимо установить Visual Studio 2019 версии 16,2 или более поздней.

- Решение, имеющее проект моделирования с диаграммой зависимостей. Эта схема зависимостей должна быть связана с артефактами в проектах C# или Visual Basic, которые необходимо проверить. См. раздел [Создание схем зависимостей из кода](../modeling/create-layer-diagrams-from-your-code.md).

Чтобы узнать, какие выпуски Visual Studio поддерживают эту функцию, см. раздел [Поддержка инструментов моделирования и архитектуры в различных выпусках](../modeling/analyze-and-model-your-architecture.md#VersionSupport).

Код можно проверить вручную с помощью открытой схемы зависимостей в Visual Studio или из командной строки. Вы также можете проверить код автоматически при выполнении локальных сборок или сборок Azure Pipelines. См. [видео Channel 9: проектирование и проверка архитектуры с помощью схем зависимостей](https://channel9.msdn.com/Series/Visual-Studio-2012-Premium-and-Ultimate-Overview/Visual-Studio-Ultimate-2012-Using-layer-diagrams-to-design-and-validate-your-architecture).

> [!IMPORTANT]
> Если вы хотите выполнить проверку слоев с помощью Team Foundation Server (TFS), необходимо также установить на сервере сборки ту же версию Visual Studio.

## <a name="live-dependency-validation"></a>Динамическая проверка зависимостей

Проверка зависимостей происходит в режиме реального времени, и ошибки отображаются сразу в **Список ошибок**.

* Динамическая проверка поддерживается для C# и Visual Basic.

* Чтобы включить полный анализ решения при использовании динамической проверки зависимостей, откройте параметры в строке Gold, которая отображается в **Список ошибок**.

  - Вы можете навсегда отклонить строку Gold, если вы не хотите видеть все проблемы архитектуры в решении.
  - Если не включить полный анализ решений, анализ выполняется только для редактируемых файлов.

* При обновлении проектов для включения динамической проверки в диалоговом окне отображается ход выполнения преобразования.

* При обновлении проекта для динамической проверки зависимостей версия пакета NuGet обновляется так же, как и для всех проектов, и является самой высокой используемой версией.

* Добавление нового проекта проверки зависимостей активирует обновление проекта.

## <a name="see-if-an-item-supports-validation"></a>Определение, поддерживает ли элемент проверку

Слои можно связывать с веб-сайтами, документами Office, обычными текстовыми файлами и файлами в проектах, которые являются общими для нескольких приложений, но в процессе проверки их не включаются. Ошибки проверки для ссылок на проекты или сборки, связанные с отдельными слоями, отображаются только в том случае, если между этими слоями отображаются зависимости. Эти ссылки считаются зависимостями, только если используются в коде.

1. На схеме зависимостей выберите один или несколько слоев, щелкните правой кнопкой мыши выделенный фрагмент и выберите пункт **Просмотреть ссылки**.

2. В **обозревателе слоев** просмотрите столбец **поддерживает проверку** . Если значение равно false, элемент не поддерживает проверку.

## <a name="include-other-net-assemblies-and-projects-for-validation"></a>Включение других сборок и проектов .NET для проверки

При перетаскивании элементов на схему зависимостей ссылки на соответствующие сборки или проекты .NET автоматически добавляются в папку «ссылки на **слой** » в проекте моделирования. Эта папка содержит ссылки на сборки и проекты, которые анализируются во время проверки. Можно включать другие сборки и проекты .NET для проверки, не перетаскивая их вручную на схему зависимостей.

1. В **Обозреватель решений** щелкните правой кнопкой мыши проект моделирования или папку **ссылки на слой** , а затем выберите команду **Добавить ссылку**.

2. В диалоговом окне **Добавление ссылки** выберите сборки или проекты, а затем нажмите кнопку **ОК**.

## <a name="validate-code-manually"></a>Проверка кода вручную

При наличии открытой схемы зависимостей, связанной с элементами решения, можно выполнить команду **проверить** ярлык на схеме. Можно также использовать командную строку для выполнения команды **MSBuild** с настраиваемым свойством **/p: validatearchitectureonbuild** , установленным в **значение true**. Например, при внесении изменений в код регулярно выполняйте проверку слоев, чтобы заранее обнаруживать конфликты зависимостей.

### <a name="validate-code-from-an-open-dependency-diagram"></a>Проверка кода на основе открытой схемы зависимостей

1. Щелкните правой кнопкой мыши поверхность схемы и выберите пункт **Проверить архитектуру**.

    > [!NOTE]
    > По умолчанию свойству **действие сборки** в файле схемы зависимостей (. LAYERDIAGRAM) присваивается значение **Проверка** , чтобы схема включалась в процесс проверки.

     Окно **Список ошибок** сообщает о любых произошедших ошибках. Дополнительные сведения об ошибках проверки см. в разделе [Устранение неполадок при проверке слоев](#troubleshoot-layer-validation-issues).

2. Чтобы просмотреть источник каждой ошибки, дважды щелкните ошибку в окне **Список ошибок** .

    > [!NOTE]
    > Visual Studio может отобразить карту кода вместо источника ошибки. Это происходит, когда либо код имеет зависимость от сборки, которая не указана схемой зависимостей, либо в коде отсутствует зависимость, указанная схемой зависимостей. Просмотрите карту кода или код, чтобы определить, должна ли существовать зависимость. Дополнительные сведения о картах кода см. в статье [сопоставление зависимостей в решениях](../modeling/map-dependencies-across-your-solutions.md).

3. Сведения об управлении ошибками см. в разделе [разрешение ошибок проверки слоев](#resolve-layer-validation-errors).

### <a name="validate-code-at-the-command-prompt"></a>Проверка кода в командной строке

1. Откройте командную строку Visual Studio.

2. Выберите один из следующих вариантов.

   - Чтобы проверить код для конкретного проекта моделирования в решении, запустите MSBuild со следующим пользовательским свойством.

       ```
       msbuild <FilePath+ModelProjectFileName>.modelproj /p:ValidateArchitecture=true
       ```

     - или

       Перейдите в папку, содержащую файл проекта моделирования (modelproj) и схему зависимостей, а затем запустите MSBuild со следующим пользовательским свойством:

       ```
       msbuild /p:ValidateArchitecture=true
       ```

   - Чтобы проверить код для всех проектов моделирования в решении, запустите MSBuild со следующим пользовательским свойством:

       ```
       msbuild <FilePath+SolutionName>.sln /p:ValidateArchitecture=true
       ```

     - или

       Перейдите к папке решения, которая должна содержать проект моделирования, содержащий схему зависимостей, а затем запустите MSBuild со следующим пользовательским свойством:

       ```
       msbuild /p:ValidateArchitecture=true
       ```

     Отобразятся любые возникающие ошибки. Дополнительные сведения о MSBuild см. в разделе задача [MSBuild](../msbuild/msbuild.md) и [MSBuild](../msbuild/msbuild-task.md).

   Дополнительные сведения об ошибках проверки см. в разделе [Устранение неполадок при проверке слоев](#troubleshoot-layer-validation-issues).

### <a name="manage-validation-errors"></a>Управление ошибками проверки

В процессе разработки может понадобиться подавить некоторые конфликты, выявленные в ходе проверки. Например, можно подавлять ошибки, над которыми уже ведется работа, а также ошибки, не имеющие отношения к конкретному сценарию. При подавлении ошибки рекомендуется вести журнал рабочего элемента в Team Foundation.

> [!WARNING]
> Вы должны быть уже подключены к управлению исходным кодом (SCC) TFS для создания рабочего элемента или связи с ним. При попытке открыть соединение с другим SCC TFS Visual Studio автоматически закрывает текущее решение. Убедитесь, что вы уже подключены соответствующему SCC, перед попыткой создания рабочего элемента или связи с ним. В последних выпусках Visual Studio команды меню недоступны, если вы не подключены к SCC.

#### <a name="create-a-work-item-for-a-validation-error"></a>Создание рабочего элемента для ошибки проверки

- В окне **Список ошибок** щелкните ошибку правой кнопкой мыши, наведите указатель на пункт **создать рабочий элемент**, а затем выберите тип рабочего элемента, который требуется создать.

Используйте эти задачи для управления ошибками проверки в окне **Список ошибок** :

|**Чтобы**|**Выполните эти действия**|
|-|-|
|Подавить выбранные ошибки во время проверки|Щелкните правой кнопкой мыши одну или несколько выбранных ошибок, наведите указатель на пункт **Управление ошибками проверки**, а затем выберите пункт **подавлять ошибки**.<br /><br /> Отобразятся подавленные ошибки с форматированием в виде зачеркивания. При выполнении проверки в следующий раз эти ошибки отображаться не будут.<br /><br /> Подавленные ошибки отправляются в файле. подавлений для соответствующего файла схемы зависимостей.|
|Остановить подавление выбранных ошибок|Щелкните правой кнопкой мыши выбранную подавленную ошибку или ошибки, наведите указатель на пункт **Управление ошибками проверки** и выберите команду **отменить подавление ошибок**.<br /><br /> При выполнении проверки в следующий раз выбранные подавленные ошибки будут отображаться.|
|Восстановление всех подавленных ошибок в окне **Список ошибок**|Щелкните правой кнопкой мыши в любом месте окна **Список ошибок** , наведите указатель на пункт **Управление ошибками проверки** и выберите команду **отобразить все подавленные ошибки**.|
|Скрыть все подавленные ошибки в окне **Список ошибок**|Щелкните правой кнопкой мыши в любом месте окна **Список ошибок** , наведите указатель на пункт **Управление ошибками проверки**, а затем выберите команду **Скрыть все подавленные ошибки**.|

## <a name="validate-code-automatically"></a>Автоматическая проверка кода

Проверку слоев можно выполнять при каждом выполнении локальной сборки. Если ваша команда использует Azure DevOps, можно выполнить проверку слоев с помощью условных возвратов, которые можно указать путем создания пользовательской задачи MSBuild и использования отчетов построения для получения сведений об ошибках проверки. Сведения о создании сборок с условным возвратом см. [в разделе TFVC с проверкой изменений](/azure/devops/pipelines/build/triggers).

### <a name="to-validate-code-automatically-during-a-local-build"></a>Автоматическая проверка кода во время локальной сборки

Откройте файл проекта моделирования (.modelproj) в текстовом редакторе и включите следующее свойство.

```xml
<ValidateArchitecture>true</ValidateArchitecture>
```

\- или -

1. В **Обозреватель решений** щелкните правой кнопкой мыши проект моделирования, содержащий диаграмму зависимостей или диаграммы, и выберите пункт **свойства**.

2. В окне **Свойства** задайте для свойства **Проверить архитектуру** проекта моделирования **значение true**.

    Это позволяет включить проект моделирования в процесс проверки.

3. В **Обозреватель решений** щелкните файл схемы зависимостей (. LAYERDIAGRAM), который вы хотите использовать для проверки.

4. В окне **Свойства** убедитесь, что для свойства **действие построения** схемы задано значение **Проверка**.

    Сюда входит схема зависимостей в процессе проверки.

Сведения об управлении ошибками в окне список ошибок см. в разделе [разрешение ошибок проверки слоев](#resolve-layer-validation-errors).

## <a name="troubleshoot-layer-validation-issues"></a>Устранение неполадок проверки слоев

Следующая таблица описывает проблемы проверки слоев и способы их устранения. Эти проблемы отличаются от ошибок, возникающих из-за несоответствия между кодом и структурой. Дополнительные сведения об этих ошибках см. в разделе [Устранение неполадок при проверке слоев](#troubleshoot-layer-validation-issues).

|**Проблема**|**Возможная причина**|**Решение**|
|-|-|-|
|Ошибки проверки не возникают так, как это ожидается.|Проверка не работает на схемах зависимостей, скопированных из других схем зависимостей в обозреватель решений и которые находятся в одном и том же проекте моделирования. схемы зависимостей, скопированные таким образом, содержат те же ссылки, что и исходная схема зависимостей.|Добавьте новую диаграмму зависимостей в проект моделирования.<br /><br /> Скопируйте элементы из исходной диаграммы зависимостей в новую диаграмму.|

## <a name="resolve-layer-validation-errors"></a>Разрешение ошибок проверки слоев

При проверке кода на соответствие схеме зависимостей ошибки проверки возникают, когда код конфликтует с конструкцией. Например, ошибки проверки могут происходить по следующим причинам:

- Артефакт назначен неправильному слою. В этом случае следует переместить артефакт.

- Способ использования артефактом (например, классом) другого класса конфликтует с имеющейся архитектурой. В этом случае необходимо выполнить рефакторинг кода, чтобы устранить зависимость.

Для устранения этих ошибок следует обновлять код до тех пор, пока в процессе проверки не перестанут происходить ошибки. Эту процедуру можно выполнить методом итераций.

В следующем разделе описывается синтаксис, используемый в этих ошибках, объясняется значение этих ошибок и предлагаются пути решения или управления ими.

|**Синтаксис**|**Описание**|
|-|-|
|*Артифактн*(*артифакттипен*)|*Артифактн* — это артефакт, связанный с слоем на схеме зависимостей.<br /><br /> *Артифакттипен* — это тип *Артифактн*, например **класс** или **метод**, например:<br /><br /> MySolution.MyProject.MyClass.MyMethod(Method)|
|*NamespaceNameN*|Имя пространства имен.|
|*LayerNameN*|Имя слоя на схеме зависимостей.|
|*DependencyType*|Тип отношения зависимости между *Артефакт1* и *Артефакт2*. Например, метод *Артефакт1* имеет связь  с *Артефакт2*.|

| **Синтаксис ошибки** | **Описание ошибки** |
|-|-|
| DV0001: **Недопустимая зависимость** | Эта проблема возникает, когда элемент кода (пространство имен, тип, элемент), сопоставленный слою, ссылается на элемент кода, сопоставленный с другим слоем, но в схеме проверки зависимостей, содержащей эти слои, отсутствует стрелка зависимостей между этими слоями. Это нарушение ограничения зависимости. |
| DV1001: **недопустимое имя пространства имен** | Эта проблема сообщается об элементе кода, связанном с слоем, в котором свойство "разрешенные имена пространств имен" не содержит пространство имен, в котором определен этот элемент кода. Это нарушение ограничения именования. Обратите внимание, что синтаксис "разрешенные имена пространств имен" — это разделенный точками с запятой список пространств имен, в которых разрешено определение элементов кода, связанных с слоем. |
| DV1002: **зависимость от нессылающегося пространства имен** | Эта проблема сообщается об элементе кода, связанном с слоем, и ссылается на другой элемент кода, определенный в пространстве имен, который определен в свойстве "нессылающееся пространство имен" слоя. Это нарушение ограничения именования. Обратите внимание, что свойство "нессылочные пространства имен" определено как список пространств имен, разделенных точкой с запятой, на которые не должны ссылаться элементы кода, связанные с этим слоем. |
| DV1003: **неразрешенное имя пространства имен** | Эта проблема сообщается об элементе кода, связанном с слоем, в котором свойство "запрещенные имена пространств имен" содержит пространство имен, в котором определен этот элемент кода. Это нарушение ограничения именования. Обратите внимание, что свойство "неразрешенное имя пространства имен" определено как список пространств имен, разделенных точкой с запятой, в которых не следует определять элементы кода, связанные с этим слоем. |
| DV2001: **присутствие схемы слоев** | Эта проблема сообщается о проекте, который не содержит файл схемы зависимостей, но относится к анализаторам проверки зависимостей. Если проверка зависимостей не используется, можно удалить "Microsoft. Проверка зависимостей. Analyzers" непосредственно из обозреватель решений или подавить это предупреждение. Чтобы добавить схему зависимостей, см. раздел [Создание схем зависимостей из кода](../modeling/create-layer-diagrams-from-your-code.md). |
| DV2002: **базовый тип несопоставленных типов** | Эта проблема возникает, когда элемент кода не сопоставлен ни с одним слоем. |
| DV3001: **отсутствует ссылка** | Слой "*Имя_слоя*" ссылается на "*артефакт*", который не удается найти. Отсутствует ссылка на сборку? |
| DV9001: **Анализ архитектуры обнаружил внутренние ошибки** | Результат может быть неполным. Для получения дополнительных сведений см. подробный журнал событий построения или окно вывода. |

## <a name="see-also"></a>См. также

- [Динамическая проверка зависимостей в Visual Studio](https://devblogs.microsoft.com/devops/live-dependency-validation-in-visual-studio-2017/)
- [Проверка системы в ходе разработки](../modeling/validate-your-system-during-development.md)
- [Видео. Проверка зависимостей архитектуры в режиме реального времени](https://sec.ch9.ms/sessions/69613110-c334-4f25-bb36-08e5a93456b5/170ValidateArchitectureDependenciesWithVisualStudio.mp4)
