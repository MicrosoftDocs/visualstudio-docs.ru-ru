---
title: Развертывание пользовательского обработчика директив
description: Сведения о методах, доступных для развертывания пользовательского обработчика директив в Visual Studio или на любом компьютере.
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: how-to
helpviewer_keywords:
- text templates, custom directive processors
author: mgoertz-msft
ms.author: mgoertz
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: 30233bf34f523ef53d95cef153fd604cef0b6447
ms.sourcegitcommit: e3a364c014ccdada0860cc4930d428808e20d667
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/19/2021
ms.locfileid: "112384906"
---
# <a name="deploying-a-custom-directive-processor"></a>Развертывание пользовательского обработчика директив

Чтобы использовать пользовательский обработчик директив в Visual Studio на любом компьютере, его необходимо зарегистрировать одним из методов, описанных в этом разделе.

Альтернативные методы таковы:

- [Расширения Visual Studio](../extensibility/shipping-visual-studio-extensions.md). Предоставляет способ установки и удаления процессора директив на вашем и других компьютерах. Обычно можно упаковывать другие функции в тот же VSIX.

- [VSPackage](../extensibility/internals/vspackages.md). Вы определяете VSPackage, содержащий помимо процессора директив и другие функции; это удобный метод регистрации процессора директив.

- Определить раздел реестра. При использовании данного метода вы добавляете для процессора директив раздел реестра.

Один из этих методов необходимо использовать только в том случае, если требуется преобразовать текстовый шаблон в Visual Studio или MSBuild. Если используется в вашем собственном приложении, это пользовательское основное приложение отвечает за поиск процессора директив для каждой директивы.

## <a name="deploying-a-directive-processor-in-a-vsix"></a>Развертывание процессора директив в VSIX

Вы можете добавить пользовательский обработчик директив в [расширение Visual Studio (VSIX)](../extensibility/starting-to-develop-visual-studio-extensions.md).

 Необходимо убедиться, что следующие два элемента содержатся в файле с расширением vsix:

- Сборка (dll), содержащая класс пользовательского процессора директив.

- Файл pkgdef, регистрирующий процессор директив. Корневое имя файла сборки должно совпадать с именем сборки. Например, файлы могут называться CDP.dll и CDP.pkgdef.

Чтобы просмотреть или изменить содержимое файла vsix, измените расширение его имени на zip и откройте этот файл. После изменения содержимого снова поменяйте расширение имени файла на vsix.

Файл vsix можно создать несколькими способами. Следующая процедура представляет один из них.

#### <a name="to-develop-a-custom-directive-processor-in-a-vsix-project"></a>Разработка пользовательского процессора директив в проекте VSIX

1. Создание нового проекта **VSIX** .

2. В **source. extension. vsixmanifest** задайте тип содержимого и поддерживаемые выпуски.

    1. В редакторе манифестов VSIX на вкладке **активы** выберите **создать** и задайте свойства нового элемента:

         **Тип содержимого**  =  Пакет **VSPackage**

         **Исходный проект** = \<*the current project*>

    2. Щелкните **Выбранные выпуски** и проверьте типы установки, для которых необходимо использовать процессор директив.

3. Добавьте файл pkgdef и установит его свойства для включения в VSIX.

    1. Создайте текстовый файл и назовите его \<*assemblyName*> . pkgdef.

         \<*assemblyName*> обычно совпадает с именем проекта.

    2. Выберите его в обозревателе решений и задайте его свойства следующим образом:

         **Build Action** = **Content** (Действие при сборке > Содержимое);

         **Копировать в выходной каталог**  =  **Всегда копировать**

         **Включить в VSIX**  =  **Значение true**

    3. Задайте имя VSIX и убедитесь, что этот идентификатор уникален.

4. Добавьте в pkgdef-файл следующий текст:

    ```
    [$RootKey$\TextTemplating]
    [$RootKey$\TextTemplating\DirectiveProcessors]
    [$RootKey$\TextTemplating\DirectiveProcessors\ CustomDirectiveProcessorName]
    @="Custom Directive Processor description"
    "Class"="NamespaceName.ClassName"
    "CodeBase"="$PackageFolder$\AssemblyName.dll"
    ```

     Замените следующие имена собственными именами: `CustomDirectiveProcessorName`, `NamespaceName`, `ClassName`, `AssemblyName`.

5. В проекте добавьте ссылки на следующее:

    - **Microsoft. VisualStudio. TextTemplating. \* . 0,0**

    - **Microsoft. VisualStudio. TextTemplating. interfaces. \* . 0,0**

    - **Microsoft. VisualStudio. TextTemplating. VSHost. \* . 0,0**

6. Добавьте в проект класс вашего пользовательского процессора директив.

     Это открытый класс, который должен реализовывать тип <xref:Microsoft.VisualStudio.TextTemplating.DirectiveProcessor> или <xref:Microsoft.VisualStudio.TextTemplating.RequiresProvidesDirectiveProcessor>.

#### <a name="to-install-the-custom-directive-processor"></a>Установка пользовательского процессора директив

1. В проводнике Windows откройте каталог Build (обычно это bin\Debug или bin\Release).

2. Если требуется установить процессор директив на другой компьютер, скопируйте vsix-файл на другой компьютер.

3. Дважды щелкните vsix-файл. Откроется установщик расширения Visual Studio.

4. Перезапустите Visual Studio. Теперь вы сможете запускать текстовые шаблоны, содержащие директивы со ссылками на ваш пользовательский процессор директив. Каждая директива имеет следующую форму:

     `<#@ CustomDirective Processor="CustomDirectiveProcessorName" parameter1="value1" ... #>`

#### <a name="to-uninstall-or-temporarily-disable-the-custom-directive-processor"></a>Удаление или временное отключение пользовательского процессора директив

1. В меню **Сервис** Visual Studio выберите пункт **Диспетчер расширений**.

2. Выберите VSIX, содержащий процессор директив, а затем нажмите кнопку **Удалить** или **Отключить**.

### <a name="troubleshooting-a-directive-processor-in-a-vsix"></a>Устранение неполадок процессора директив в VSIX
 Если процессор директив не работает, этому могут быть следующие причины:

- Имя процессора, заданное в пользовательской директиве, должно соответствовать значению `CustomDirectiveProcessorName`, заданному в pkgdef-файле.

- Метод `IsDirectiveSupported` должен возвращать значение `true`, когда ему передается имя `CustomDirective`.

- Если расширение не отображается в диспетчере расширений, но система не позволяет его установить, удалите расширение из **%локалаппдата%\микрософт\висуалстудио \\ \* 0 \ Extensions \\**.

- Откройте vsix-файл и проверьте его содержимое. Чтобы его открыть, смените расширение имени файла на zip. Убедитесь, что он содержит файлы с расширениями dll, pkgdef и файл extension.vsixmanifest. Файл extension.vsixmanifest должен содержать соответствующий список в узле SupportedProducts, а также содержать узел VsPackage, расположенный в иерархии ниже узла Content.

     `<Content>`

     `<VsPackage>CustomDirectiveProcessor.dll</VsPackage>`

     `</Content>`

## <a name="deploying-a-directive-processor-in-a-vspackage"></a>Развертывание процессора директив в VSPackage
 Если процессор директив является частью VSPackage, который будет установлен в глобальный кэш сборок, можно сделать так, чтобы система сама сгенерировала pkgdef-файл.

 Поместите в класс пакета следующий атрибут.

```csharp
[ProvideDirectiveProcessor(typeof(DirectiveProcessorClass), "DirectiveProcessorName", "Directive processor description.")]
```

> [!NOTE]
> Этот атрибут следует поместить в класс пакета, не в класс процессора директив.

 Файл pkgdef будет автоматически создан во время построения проекта. При установке VSPackage pkgdef-файл будет регистрировать процессор директив.

 Убедитесь, что pkgdef-файл содержится в папке построения, которой обычно является bin\Debug или bin\Release. Если там нет этого файла, откройте CSPROJ-файл в текстовом редакторе и удалите следующий узел: `<GeneratePkgDefFile>false</GeneratePkgDefFile>`.

 Дополнительные сведения см. в разделе [VSPackages](../extensibility/internals/vspackages.md).

## <a name="setting-a-registry-key"></a>Создание раздела реестра
 Данный способ установки пользовательского процессора директив рекомендуется использовать в последнюю очередь. Он не предусматривает удобного способа включения и отключения процессора директив и способа передачи процессора директив другим пользователям.

> [!CAUTION]
> Неправильное изменение реестра может вызвать серьезные проблемы. Перед внесением изменений в реестр необходимо выполнить резервное копирование всех ценных данных на компьютере.

#### <a name="to-register-a-directive-processor-by-setting-a-registry-key"></a>Регистрация процессора директив путем создания раздела реестра

1. Выполните команду `regedit`.

2. В программе regedit перейдите следующему разделу:

    **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\VisualStudio\\ \* . 0 \ тексттемплатинг\директивепроцессорс**

    Если вы хотите установить процессор директив в экспериментальной версии Visual Studio, вставьте "EXP" после "11,0".

3. Добавьте раздел реестра с именем, совпадающим с именем класса процессора директив.

   - В дереве реестра щелкните правой кнопкой мыши узел **директивепроцессорс** , наведите указатель на пункт **создать** и выберите пункт **ключ**.

4. Добавьте в новый узел строковые значения для параметров Class и CodeBase либо Assembly согласно указаниям, приведенным в следующих таблицах.

   1. Щелкните правой кнопкой мыши созданный узел, наведите указатель на пункт **создать** и выберите пункт **строковое значение**.

   2. Отредактируйте имя значения.

   3. Дважды щелкните имя и отредактируйте данные.

   Если пользовательский процессор директив не находится в глобальном кэше сборок, подраздел реестра должен выглядеть, как в следующей таблице:

|Имя|Тип|Данные|
|-|-|-|
|(по умолчанию)|REG_SZ|(значение не задано)|
|Class|REG_SZ|**\<Namespace Name>.\<Class Name>**|
|CodeBase|REG_SZ|**\<Your Path>\\<имя сборки\>**|

 Если сборка находится в глобальном кэше сборок, подраздел реестра должен выглядеть, как в следующей таблице:

|Имя|Тип|Данные|
|-|-|-|
|(по умолчанию)|REG_SZ|(значение не задано)|
|Class|REG_SZ|\<**Your Fully Qualified Class Name**>|
|Сборка|REG_SZ|\<**Your Assembly Name in the GAC**>|

## <a name="see-also"></a>См. также

- [Создание пользовательских обработчиков директив для текстовых шаблонов T4](../modeling/creating-custom-t4-text-template-directive-processors.md)
