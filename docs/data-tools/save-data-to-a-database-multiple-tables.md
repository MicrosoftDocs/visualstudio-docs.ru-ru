---
title: Сохранение данных в базе данных (несколько таблиц)
description: В этом пошаговом руководстве данные из нескольких таблиц сохраняются в базе данных с помощью средств набора данных в Visual Studio.
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: how-to
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- updating datasets, walkthroughs
- data [Visual Studio], saving
- saving data, walkthroughs
- data [Visual Studio], updating
ms.assetid: 7ebe03da-ce8c-4cbc-bac0-a2fde4ae4d07
author: ghogen
ms.author: ghogen
manager: jmartens
ms.workload:
- data-storage
ms.openlocfilehash: 6f4b174e10eae63044c547d8ed87c46db03d23c6
ms.sourcegitcommit: 80fc9a72e9a1aba2d417dbfee997fab013fc36ac
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2021
ms.locfileid: "106216050"
---
# <a name="save-data-to-a-database-multiple-tables"></a>Сохранение данных в базе данных (несколько таблиц)

Одним из наиболее распространенных сценариев в разработке приложений является отображение данных на форме в приложении Windows, изменение этих данных и отправка обновленных данных обратно в базу данных. Это пошаговое руководство описывает создание формы, отображающей данные из двух связанных таблиц, правку записей и сохранение изменений в базе данных. В данном примере используются таблицы `Customers` и `Orders` из учебной базы данных "Борей".

Вы можете сохранить данные из приложения в базе данных, вызвав метод `Update` адаптера таблицы. При перетаскивании таблиц из окна **Источники данных** на форму автоматически добавляется код, необходимый для сохранения данных. Для всех дополнительных таблиц, добавляемых в форму, требуется добавление этого кода вручную. Это пошаговое руководство описывает добавление кода для сохранения обновлений из нескольких таблиц.

В данном пошаговом руководстве представлены следующие задачи.

- Создание и Настройка источника данных в приложении с помощью [мастера настройки источника данных](../data-tools/media/data-source-configuration-wizard.png).

- Установка элементов управления для элементов в [окне Источники данных](add-new-data-sources.md#data-sources-window). Дополнительные сведения см. в разделе [Установка элемента управления, создаваемого при перетаскивании из окна Источники данных](../data-tools/set-the-control-to-be-created-when-dragging-from-the-data-sources-window.md).

- Создание элементов управления с привязкой к данным с помощью перетаскивания элементов из окна **Источники данных** на форму.

- Изменение нескольких записей в каждой таблице в наборе данных.

- Изменение кода для отправки обновленных данных в наборе данных обратно в базу данных.

## <a name="prerequisites"></a>Предварительные требования

В этом пошаговом руководстве используется SQL Server Express LocalDB и образец базы данных Northwind.

1. Если у вас нет SQL Server Express LocalDB, установите его на [странице загрузки SQL Server Express](https://www.microsoft.com/sql-server/sql-server-editions-express)или с помощью **Visual Studio Installer**. В **Visual Studio Installer** можно установить SQL Server Express LocalDB как часть рабочей нагрузки **хранения и обработки данных** или как отдельный компонент.

2. Установите учебную базу данных Northwind, выполнив следующие действия.

    1. В Visual Studio откройте окно **Обозреватель объектов SQL Server** . (Обозреватель объектов SQL Server устанавливается как часть рабочей нагрузки **хранения и обработки данных** в Visual Studio Installer.) Разверните узел **SQL Server** . Щелкните правой кнопкой мыши экземпляр LocalDB и выберите **создать запрос**.

       Откроется окно редактора запросов.

    2. Скопируйте [скрипт Transact-SQL Northwind](https://github.com/MicrosoftDocs/visualstudio-docs/blob/master/docs/data-tools/samples/northwind.sql?raw=true) в буфер обмена. Этот сценарий T-SQL создает базу данных Northwind с нуля и заполняет ее данными.

    3. Вставьте скрипт T-SQL в редактор запросов, а затем нажмите кнопку **выполнить** .

       По истечении короткого времени выполнение запроса завершается и создается база данных Northwind.

## <a name="create-the-windows-forms-application"></a>Создание приложения Windows Forms

Создайте новый проект **Windows Forms приложения** для C# или Visual Basic. Присвойте проекту имя **UpdateMultipleTablesWalkthrough**.

## <a name="create-the-data-source"></a>Создание источника данных

На этом шаге **Мастер настройки источника данных** используется для создания источника данных из базы данных Northwind. Для создания подключения необходимо иметь доступ к учебной базе данных "Борей". Сведения о настройке образца базы данных Northwind см. в разделе [как установить образцы баз](../data-tools/installing-database-systems-tools-and-samples.md)данных.

1. В меню **Данные** выберите пункт **Показать источники данных**.

   Открывается окно **Источники данных**.

2. В окне **Источники данных** выберите **Добавить новый источник данных** , чтобы запустить **Мастер настройки источника данных**.

3. На экране **Выбор типа источника данных** выберите **база данных**, а затем нажмите кнопку **Далее**.

4. На экране **Выбор подключения к данным** выполните одно из следующих действий.

    - Если подключение к учебной базе данных Northwind доступно в раскрывающемся списке, то выберите его.

         -или-

    - Выберите **Новое подключение** для открытия диалогового окна **Добавить/изменить подключение**.

5. Если базе данных требуется пароль, выберите параметр, чтобы включить конфиденциальные данные, а затем нажмите кнопку **Далее**.

6. В **строке сохранить подключение в файл конфигурации приложения** нажмите кнопку **Далее**.

7. На экране **Выбор объектов базы данных** разверните узел **таблицы** .

8. Выберите таблицы **Customers** и **Orders** , а затем нажмите кнопку **Готово**.

     Объект **NorthwindDataSet** добавляется в проект, и таблицы отображаются в окне **Источники данных**.

## <a name="set-the-controls-to-be-created"></a>Задание создаваемых элементов управления

В этом пошаговом руководстве данные в `Customers` таблице находятся в макете **сведений** , где данные отображаются в отдельных элементах управления. Данные из `Orders` таблицы находятся в макете **сетки** , который отображается в <xref:System.Windows.Forms.DataGridView> элементе управления.

### <a name="to-set-the-drop-type-for-the-items-in-the-data-sources-window"></a>Установка типа удаления для элементов в окне "Источники данных"

1. В окне **Источники данных** разверните узел **Клиенты** .

2. В узле **Клиенты** выберите **сведения** из списка управления, чтобы изменить элемент управления таблицы **Customers** на отдельные элементы управления. Дополнительные сведения см. в разделе [Установка элемента управления, создаваемого при перетаскивании из окна Источники данных](../data-tools/set-the-control-to-be-created-when-dragging-from-the-data-sources-window.md).

## <a name="create-the-data-bound-form"></a>Создание формы с привязкой к данным

Вы можете создавать элементы управления с привязкой к данным с помощью перетаскивания элементов из окна **Источники данных** на форму.

1. Перетащите главный узел **Customers** из окна **Источники данных** на форму **Form1**.

     Привязанные к данным элементы управления с метками описания отображаются на форме вместе с панелью инструментов (<xref:System.Windows.Forms.BindingNavigator>) для перемещения по записям. [](../data-tools/dataset-tools-in-visual-studio.md) `CustomersTableAdapter` <xref:System.Windows.Forms.BindingSource> <xref:System.Windows.Forms.BindingNavigator> В области компонентов появятся NorthwindDataSet,, и.

2. Перетащите связанный узел **Заказы** из окна **Источники данных** на **Form1**.

    > [!NOTE]
    > Связанный узел **Заказы** расположен под столбцом **Факс** и является дочерним для узла **Клиенты**.

     На форме появляется элемент <xref:System.Windows.Forms.DataGridView> и панель инструментов (<xref:System.Windows.Forms.BindingNavigator>) для перемещения по записям. `OrdersTableAdapter`И <xref:System.Windows.Forms.BindingSource> появятся в области компонентов.

## <a name="add-code-to-update-the-database"></a>Добавление кода для обновления базы данных

Вы можете обновить базу данных, вызвав методы `Update` адаптеров таблицы **Клиенты** и **Заказы**. По умолчанию обработчик событий для кнопки **сохранить** <xref:System.Windows.Forms.BindingNavigator> добавляется в код формы для отправки обновлений в базу данных. Эта процедура изменяет код для отправки обновлений в правильном порядке. Это устраняет возможность возникновения ошибок ссылочной целостности. Этот код также реализует обработку ошибок, упаковывая вызов обновления в блок try-catch. Вы можете изменить этот код в соответствии с потребностями своего приложения.

> [!NOTE]
> Для ясности в этом пошаговом руководстве не используется транзакция. Однако при обновлении двух или более связанных таблиц включите всю логику обновления в рамках транзакции. Транзакция — это процесс, который гарантирует, что все связанные изменения базы данных будут успешными до фиксации каких-либо изменений. Дополнительные сведения см. в разделе [Transactions and Concurrency](/dotnet/framework/data/adonet/transactions-and-concurrency).

### <a name="to-add-update-logic-to-the-application"></a>Добавление логики обновления в приложение

1. Нажмите кнопку **сохранить** в <xref:System.Windows.Forms.BindingNavigator> . Откроется редактор кода для `bindingNavigatorSaveItem_Click` обработчика событий.

2. Замените код в обработчике событий на вызов методов `Update` связанных адаптеров таблицы. Следующий код сначала создает три временные таблицы данных для хранения обновленной информации для каждого <xref:System.Data.DataRowState> (<xref:System.Data.DataRowState.Deleted>, <xref:System.Data.DataRowState.Added> и <xref:System.Data.DataRowState.Modified>). Обновления выполняются в правильном порядке. Код должен выглядеть следующим образом:

     :::code language="vb" source="../snippets/visualbasic/VS_Snippets_VBCSharp/VbRaddataSaving/VB/Form4.vb" id="Snippet10":::
     :::code language="csharp" source="../snippets/csharp/VS_Snippets_VBCSharp/VbRaddataSaving/CS/Form4.cs" id="Snippet10":::

## <a name="test-the-application"></a>Тестирование приложения

1. Нажмите клавишу **F5**.

2. Внесите изменения в данные одной или нескольких записей в каждой таблице.

3. Нажмите кнопку **Сохранить**.

4. Проверьте значения в базе данных и убедитесь, что изменения были сохранены.

## <a name="see-also"></a>См. также раздел

- [Сохранение данных обратно в базу данных](../data-tools/save-data-back-to-the-database.md)
