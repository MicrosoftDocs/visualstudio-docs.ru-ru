---
title: Создание связи "основной/подробности" с помощью кэшированного набора данных
description: Узнайте о создании связи "основной/подробности" на листе и кэшировании данных, чтобы решение можно было использовать в автономном режиме.
ms.custom: SEO-VS-2020
ms.date: 02/02/2017
ms.topic: conceptual
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- master-detail tables [Office development in Visual Studio], walkthroughs
- data caching [Office development in Visual Studio], Master/Detail Relation
author: John-Hart
ms.author: johnhart
manager: jmartens
ms.workload:
- office
ms.openlocfilehash: 177b21e2278153693601adf7b7dc18b751cf184e
ms.sourcegitcommit: 4b40aac584991cc2eb2186c3e4f4a7fcd522f607
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2021
ms.locfileid: "107824852"
---
# <a name="walkthrough-create-a-master-detail-relation-using-a-cached-dataset"></a>Пошаговое руководство. Создание связи "основной/подробности" с помощью кэшированного набора данных
  В этом пошаговом руководстве демонстрируется создание связи "основной/подробности" на листе и кэширование данных, чтобы решение можно было использовать в автономном режиме.

 [!INCLUDE[appliesto_xlalldoc](../vsto/includes/appliesto-xlalldoc-md.md)]

 В этом пошаговом руководстве описаны следующие процедуры.

- Добавление элементов управления на лист.

- Настройте набор данных для кэширования на листе.

- Добавьте код для включения прокрутки записей.

- Протестируйте проект.

> [!NOTE]
> Отображаемые на компьютере имена или расположения некоторых элементов пользовательского интерфейса Visual Studio могут отличаться от указанных в следующих инструкциях. Это зависит от имеющегося выпуска Visual Studio и используемых параметров. Дополнительные сведения см. в разделе [Персонализация интегрированной среды разработки Visual Studio](../ide/personalizing-the-visual-studio-ide.md).

## <a name="prerequisites"></a>Предварительные требования
 Для выполнения этого пошагового руководства требуются следующие компоненты:

- [!INCLUDE[vsto_vsprereq](../vsto/includes/vsto-vsprereq-md.md)]

- [!INCLUDE[Excel_15_short](../vsto/includes/excel-15-short-md.md)] или [!INCLUDE[Excel_14_short](../vsto/includes/excel-14-short-md.md)].

- Доступ к образцу базы данных Northwind SQL Server. База данных может находиться на компьютере разработчика или на сервере.

- Разрешения на чтение и запись в базу данных SQL Server.

## <a name="create-a-new-project"></a>Создание нового проекта
 На этом шаге вы создадите проект книги Excel.

### <a name="to-create-a-new-project"></a>Создание нового проекта

1. Создайте проект книги Excel с именем My " **основной — подробности**", используя Visual Basic или C#. Убедитесь, что выбрано **Создание нового документа** . Дополнительные сведения см. в разделе [How to: Create Office Projects in Visual Studio](../vsto/how-to-create-office-projects-in-visual-studio.md).

   Visual Studio откроет новую книгу Excel в конструкторе и добавит проект " **основной-подробности** " в **Обозреватель решений**.

## <a name="create-the-data-source"></a>Создание источника данных
 С помощью окна **Источники данных** добавьте типизированный набор данных в свой проект.

### <a name="to-create-the-data-source"></a>Создание источника данных

1. Если окно **Источники данных** не отображается, отобразите его с помощью команды **Просмотреть**  >  **другие**  >  **Источники данных** Windows в строке меню.

2. Выберите команду **Добавить новый источник данных** , чтобы запустить **Мастер настройки источника данных**.

3. Выберите **база данных** и нажмите кнопку **Далее**.

4. Выберите подключение данных к образцу базы данных Northwind SQL Server или добавьте новое соединение с помощью кнопки **создать подключение** .

5. После выбора или создания соединения нажмите кнопку **Далее**.

6. Снимите флажок сохранить соединение, если он установлен, а затем нажмите кнопку **Далее**.

7. Разверните узел **таблицы** в окне **объекты базы данных** .

8. Выберите таблицу **заказы** и таблицу **Order Details** .

9. Нажмите кнопку **Готово**.

   Мастер добавит две таблицы в окно **Источники данных** . Он также добавляет в проект типизированный набор данных, видимый в **Обозреватель решений**.

## <a name="add-controls-to-the-worksheet"></a>Добавление элементов управления на лист
 На этом шаге вы добавите именованный диапазон, объект списка и две кнопки на первый лист. Сначала добавьте именованный диапазон и объект списка из окна **Источники данных** , чтобы они автоматически привязываются к источнику данных. Затем добавьте кнопки из **панели элементов**.

### <a name="to-add-a-named-range-and-a-list-object"></a>Добавление именованного диапазона и объекта List

1. Убедитесь, что книга " **мои Master-Detail.xlsx** " открыта в конструкторе Visual Studio, и отображается **Лист1** .

2. Откройте окно **Источники данных** и разверните узел **заказы** .

3. Выберите столбец **OrderID** , а затем щелкните появившуюся стрелку раскрывающегося списка.

4. Щелкните элемент **NamedRange** в раскрывающемся списке и перетащите столбец **OrderID** в ячейку **a2**.

     <xref:Microsoft.Office.Tools.Excel.NamedRange>Элемент управления с именем `OrderIDNamedRange` создается в ячейке **a2**. В то же время в <xref:System.Windows.Forms.BindingSource> `OrdersBindingSource` проект добавляются именованный, адаптер таблицы и <xref:System.Data.DataSet> экземпляр. Элемент управления привязан к <xref:System.Windows.Forms.BindingSource> , который, в свою очередь, привязан к <xref:System.Data.DataSet> экземпляру.

5. Прокрутите вниз столбцы, находящиеся под таблицей **Orders** . В нижней части списка находится таблица **Order Details** . здесь это так, потому что это дочерний элемент таблицы **Orders** . Выберите таблицу **сведения о заказе** , а не ту, которая находится на том же уровне, что и таблица **Orders** , а затем щелкните появившуюся стрелку раскрывающегося списка.

6. В раскрывающемся списке выберите элемент **ListObject** , а затем перетащите таблицу **OrderDetails** в ячейку **A6**.

7. <xref:Microsoft.Office.Tools.Excel.ListObject>Элемент управления с именем **Order_DetailsListObject** создается в ячейке **A6** и привязывается к <xref:System.Windows.Forms.BindingSource> .

### <a name="to-add-two-buttons"></a>Добавление двух кнопок

1. На вкладке **Общие элементы управления** **панели элементов** добавьте <xref:System.Windows.Forms.Button> элемент управления в ячейку **a3** листа.

    Эта кнопка называется `Button1` .

2. Добавьте еще один <xref:System.Windows.Forms.Button> элемент управления в ячейку **B3** листа.

    Эта кнопка называется `Button2` .

   Затем пометьте набор данных для кэширования в документе.

## <a name="cache-the-dataset"></a>Кэширование набора данных
 Пометьте набор данных как кэшированный в документе, сделав его открытым и задав свойство **CacheInDocument** .

### <a name="to-cache-the-dataset"></a>Кэширование набора данных

1. Выберите **NorthwindDataSet** в области компонентов.

2. В окне **Свойства** измените значение свойства **модификаторы** на **Public**.

    Перед включением кэширования наборы данных должны быть открытыми.

3. Измените значение свойства **CacheInDocument** на **true**.

   Следующим шагом является добавление текста к кнопкам, а в C# добавляется код для подключения обработчиков событий.

## <a name="initialize-the-controls"></a>Инициализация элементов управления
 Задайте текст кнопки и добавьте обработчики событий во время <xref:Microsoft.Office.Tools.Excel.Workbook.Startup> события.

### <a name="to-initialize-the-data-and-the-controls"></a>Инициализация данных и элементов управления

1. В **Обозреватель решений** щелкните правой кнопкой мыши **Лист1. vb** или **Sheet1. CS** и выберите в контекстном меню пункт **Просмотреть код** .

2. Добавьте следующий код в метод, `Sheet1_Startup` чтобы задать текст для кнопок.

     :::code language="vb" source="../vsto/codesnippet/VisualBasic/Trin_VstcoreDataExcelVB/Sheet2.vb" id="Snippet15":::
     :::code language="csharp" source="../vsto/codesnippet/CSharp/Trin_VstcoreDataExcelCS/Sheet2.cs" id="Snippet15":::

3. Для только C# добавьте обработчики событий для событий нажатия кнопки в `Sheet1_Startup` метод.

     :::code language="csharp" source="../vsto/codesnippet/CSharp/Trin_VstcoreDataExcelCS/Sheet2.cs" id="Snippet16":::

## <a name="add-code-to-enable-scrolling-through-the-records"></a>Добавление кода для включения прокрутки записей
 Добавьте код в <xref:System.Windows.Forms.Control.Click> обработчик событий каждой кнопки, чтобы перемещаться по записям.

### <a name="to-scroll-through-the-records"></a>Прокрутка записей

1. Добавьте обработчик событий для <xref:System.Windows.Forms.Control.Click> события `Button1` и добавьте следующий код для перемещения назад по записям:

     :::code language="vb" source="../vsto/codesnippet/VisualBasic/Trin_VstcoreDataExcelVB/Sheet2.vb" id="Snippet17":::
     :::code language="csharp" source="../vsto/codesnippet/CSharp/Trin_VstcoreDataExcelCS/Sheet2.cs" id="Snippet17":::

2. Добавьте обработчик событий для <xref:System.Windows.Forms.Control.Click> события `Button2` и добавьте следующий код для перехода по записям:

     :::code language="vb" source="../vsto/codesnippet/VisualBasic/Trin_VstcoreDataExcelVB/Sheet2.vb" id="Snippet18":::
     :::code language="csharp" source="../vsto/codesnippet/CSharp/Trin_VstcoreDataExcelCS/Sheet2.cs" id="Snippet18":::

## <a name="test-the-application"></a>Тестирование приложения
 Теперь можно протестировать книгу, чтобы убедиться, что данные отображаются должным образом, и вы можете использовать решение в автономном режиме.

### <a name="to-test-the-data-caching"></a>Тестирование кэширования данных

1. Нажмите клавишу **F5**.

2. Убедитесь, что именованный диапазон и объект списка заполнены данными из источника данных.

3. Прокрутите некоторые записи, нажав кнопки.

4. Сохраните книгу, а затем закройте книгу и Visual Studio.

5. Отключите соединение с базой данных. Отключите сетевой кабель от компьютера, если база данных находится на сервере, или завершите работу службы SQL Server, если база данных находится на компьютере разработчика.

6. Откройте Excel, а затем откройте **мой Master-Detail.xlsx** из каталога *\bin* (\ \ мои *Мастер-детаил\бин* в Visual Basic или \ *Мастер-детаил\бин\дебуг* в C#).

7. Прокрутите некоторые записи, чтобы убедиться, что лист работает нормально при отключении.

8. Повторно подключитесь к базе данных. Снова подключите компьютер к сети, если база данных находится на сервере, или запустите службу SQL Server, если база данных находится на компьютере разработчика.

## <a name="next-steps"></a>Дальнейшие действия
 В этом пошаговом руководстве показаны основные сведения о создании связи данных "основной/подробности" на листе и кэшировании набора данных. Ниже приводятся некоторые из возможных последующих задач.

- Разверните решение. Дополнительные сведения см. в статье [развертывание решения Office](../vsto/deploying-an-office-solution.md) .

## <a name="see-also"></a>См. также статью
- [Привязка данных к элементам управления в решениях Office](../vsto/binding-data-to-controls-in-office-solutions.md)
- [Данные в решениях Office](../vsto/data-in-office-solutions.md)
- [Кэширование данных](../vsto/caching-data.md)
- [Общие сведения о ведущих элементах и элементах управления ведущего приложения](../vsto/host-items-and-host-controls-overview.md)
