---
title: Критические изменения в расширяемости Visual Studio 2017
description: Ознакомьтесь с техническими сведениями о критических изменениях, внесенных в модель расширяемости в Visual Studio 2017, и о том, что можно сделать для их устранения.
ms.custom: SEO-VS-2020
titleSuffix: ''
ms.date: 11/09/2016
ms.topic: conceptual
ms.assetid: 54d5af60-0b44-4ae1-aa57-45aa03f89f3d
author: leslierichardson95
ms.author: lerich
manager: jmartens
ms.workload:
- vssdk
ms.openlocfilehash: c07d48eb63c727701c3b6fcde9d405f9c96abec1
ms.sourcegitcommit: f2916d8fd296b92cc402597d1d1eecda4f6cccbf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/25/2021
ms.locfileid: "105068197"
---
# <a name="changes-in-visual-studio-2017-extensibility"></a>Изменения в расширяемости Visual Studio 2017

Visual Studio 2017 предоставляет более [Быстрый и облегченный процесс установки Visual Studio](https://devblogs.microsoft.com/visualstudio/faster-leaner-visual-studio-installer) , который сокращает влияние Visual Studio на системы пользователей, позволяя пользователям больше выбирать о рабочих нагрузках и установленных компонентах. Для поддержки этих улучшений мы внесли изменения в модель расширяемости, включая некоторые критические изменения. В этой статье описаны технические подробности об этих изменениях и действия, которые можно выполнить для их устранения.

> [!NOTE]
> Некоторые сведения являются сведениями о реализации на определенный момент времени и могут быть изменены позже.

## <a name="changes-affecting-vsix-format-and-installation"></a>Изменения, затрагивающие формат VSIX и его установку

В Visual Studio 2017 появился формат VSIX v3 (версия 3) для поддержки упрощенного процесса установки.

Изменения в формате VSIX включают:

* Объявление необходимых компонентов для установки. Для предоставления в качестве средства упрощенной, быстрой установки Visual Studio установщик теперь предлагает пользователям больше возможностей настройки. В результате, чтобы убедиться в том, что компоненты и компоненты, необходимые для расширения, установлены, расширениям необходимо объявить свои зависимости.

  * Установщик Visual Studio 2017 автоматически предлагает получить и установить необходимые компоненты для пользователя в процессе установки расширения.
  * Пользователи также предупреждаются при попытке установить расширение, которое не было создано с помощью нового формата VSIX v3, даже если они были помечены в манифесте как нацеливание на версию 15,0.

* Расширенные возможности для формата VSIX. Чтобы обеспечить немедленную [установку](https://devblogs.microsoft.com/visualstudio/anatomy-of-a-low-impact-visual-studio-install) Visual Studio, которая также поддерживает параллельную установку, мы больше не будем сохранять большинство данных конфигурации в системном реестре и переместили сборки, относящиеся к Visual Studio, из глобального кэша сборок. Мы также увеличили возможности формата VSIX и модуля установки VSIX, что позволяет использовать его вместо MSI или EXE для установки расширений для некоторых типов установки.

К новым возможностям относятся:

* Регистрация в указанном экземпляре Visual Studio.
* Установка за пределами [папки Extensions](set-install-root.md).
* Обнаружение архитектуры процессора.
* Зависимость от языковых пакетов, разделенных языком.
* Установка с [поддержкой NGen](ngen-support.md).

## <a name="build-an-extension-for-visual-studio-2017"></a>Создание расширения для Visual Studio 2017

В Visual Studio 2017 доступен инструментарий конструктора для создания нового формата манифеста VSIX v3. Дополнительные сведения об использовании средств конструктора или внесении ручных обновлений в проект и манифест для разработки расширений VSIX v3 см. в сопроводительном документе [руководство. Миграция проектов расширяемости в Visual Studio 2017](how-to-migrate-extensibility-projects-to-visual-studio-2017.md) .

## <a name="change-visual-studio-user-data-path"></a>Изменение: путь к данным пользователя Visual Studio

Ранее на каждом компьютере может существовать только одна установка каждого основного выпуска Visual Studio. Для поддержки параллельной установки Visual Studio 2017 на компьютере пользователя может существовать несколько путей к данным пользователя для Visual Studio.

Код, выполняющийся в процессе Visual Studio, должен быть обновлен для использования диспетчера параметров Visual Studio. Код, выполняемый за пределами процесса Visual Studio, может найти путь пользователя определенной установки Visual Studio [, следуя указаниям здесь](locating-visual-studio.md).

## <a name="change-global-assembly-cache-gac"></a>Изменение: глобальный кэш сборок (GAC)

Большинство основных сборок Visual Studio больше не устанавливаются в глобальный кэш сборок. Были внесены следующие изменения, чтобы код, выполняемый в процессе Visual Studio, по-прежнему мог найти необходимые сборки во время выполнения.

> [!NOTE]
> [INSTALLDIR] ниже ссылается на корневой каталог установки Visual Studio. *VSIXInstaller.exe* заполнит это автоматически, но для написания пользовательского кода развертывания ознакомьтесь с [разрасположением Visual Studio](locating-visual-studio.md).

* Сборки, которые были установлены только в глобальный кэш сборок:

  Теперь эти сборки установлены в папке <em>[INSTALLDIR] \Common7\IDE \* , * [INSTALLDIR] \Common7\IDE\PublicAssemblies</em> или *[INSTALLDIR] \Common7\IDE\PrivateAssemblies*. Эти папки являются частью путей поиска в процессе Visual Studio.

* Сборки, которые были установлены в непроверенный путь и в глобальный кэш сборок:

  * Копия в глобальном кэше сборок была удалена из программы установки.
  * Был добавлен *pkgdef* -файл для указания записи базы кода для сборки.

    Пример:

    ```
    [$RootKey$\RuntimeConfiguration\dependentAssembly\codeBase\{UniqueGUID}]
    "name"="AssemblyName" "codeBase"="$PackageFolder$\AssemblyName.dll"
    "publicKeyToken"="Public Key Token"
    "culture"="neutral"
    "version"=15.0.0.0
    ```

    Во время выполнения подсистема pkgdef Visual Studio объединяет эти записи в файл конфигурации среды выполнения процесса Visual Studio (в разделе *[всаппдата] \devenv.exe.config*) как [`<codeBase>`](/dotnet/framework/configure-apps/file-schema/runtime/codebase-element) элементы. Это рекомендуемый способ разрешить процессу Visual Studio найти сборку, так как она позволяет избежать поиска по путям поиска.

### <a name="reacting-to-this-breaking-change"></a>Реагирование на это критическое изменение

* Если расширение выполняется в рамках процесса Visual Studio:

  * Код сможет находить основные сборки Visual Studio.
  * При необходимости можно использовать файл *pkgdef* для указания пути к сборкам.

* Если расширение выполняется вне процесса Visual Studio, выполните следующие действия.

  Рассмотрите возможность поиска основных сборок Visual Studio в <em>[INSTALLDIR] \Common7\IDE \* , * [INSTALLDIR] \Common7\IDE\PublicAssemblies</em> или *[INSTALLDIR] \Common7\IDE\PrivateAssemblies* с помощью файла конфигурации или сопоставителя сборок.

## <a name="change-reduce-registry-impact"></a>Изменение: снижение влияния реестра

### <a name="global-com-registration"></a>Глобальная регистрация COM

* Ранее Visual Studio установила множество разделов реестра в HKEY_CLASSES_ROOT и HKEY_LOCAL_MACHINE Hive для поддержки собственной регистрации COM. Чтобы устранить это воздействие, Visual Studio теперь использует [активацию без регистрации для COM-компонентов](/previous-versions/dotnet/articles/ms973913(v=msdn.10)).
* В результате большинство файлов TLB/OLB/DLL в папке% ProgramFiles (x86)% \ Common Files\Microsoft Шаред\мсенв больше не устанавливаются Visual Studio по умолчанию. Теперь эти файлы устанавливаются в папке [INSTALLDIR] с соответствующими Registration-Free манифестами COM, используемыми ведущим процессом Visual Studio.
* В результате внешний код, который использует глобальную регистрацию COM для COM-интерфейсов Visual Studio, больше не будет находить эти регистрации. Код, выполняющийся в процессе Visual Studio, не будет видеть разницу.

### <a name="visual-studio-registry"></a>Реестр Visual Studio

* Ранее Visual Studio установила множество разделов реестра в **HKEY_LOCAL_MACHINE** системы и **HKEY_CURRENT_USER** Hive в разделе, относящемся к Visual Studio:

  * **Хклм\софтваре\микрософт\висуалстудио \{ Версия}**: разделы реестра, созданные установщиками MSI и расширениями для компьютера.
  * **Хкку\софтваре\микрософт\висуалстудио \{ Версия}**: разделы реестра, созданные Visual Studio для хранения пользовательских параметров.
  * **Хкку\софтваре\микрософт\висуалстудио \{ Версия} _Config**: копия ключа HKLM Visual Studio выше, а также разделы реестра, Объединенные из файлов *pkgdef* по расширениям.

* Чтобы снизить влияние на реестр, Visual Studio теперь использует функцию [реглоадаппкэй](/windows/desktop/api/winreg/nf-winreg-regloadappkeya) для хранения разделов реестра в частном двоичном файле в разделе *[всаппдата] \приватерегистри.бин*. В системном реестре остается лишь небольшое количество разделов, относящихся к Visual Studio.
* Существующий код, выполняющийся в процессе Visual Studio, не затрагивается. Visual Studio перенаправит все операции реестра, относящиеся к разделу HKCU Visual Studio, в частный реестр. Чтение и запись в другие расположения реестра будут продолжать использовать системный реестр.
* Внешний код должен загрузить и прочитать этот файл для записей реестра Visual Studio.

### <a name="react-to-this-breaking-change"></a>Реакция на это критическое изменение

* Внешний код следует преобразовать, чтобы использовать активацию Registration-Free для COM-компонентов.
* Внешние компоненты могут найти расположение Visual Studio [, следуя указаниям здесь](https://devblogs.microsoft.com/setup/changes-to-visual-studio-15-setup).
* Рекомендуется, чтобы внешние компоненты использовали [Диспетчер внешних параметров](/dotnet/api/microsoft.visualstudio.settings.externalsettingsmanager) вместо чтения и записи непосредственно в разделы реестра Visual Studio.
* Проверьте, могут ли компоненты, которые использует расширение, реализовать еще один метод регистрации. Например, расширения отладчика могут воспользоваться преимуществами новой [регистрации COM-файла msvsmon JSON](migrate-debugger-COM-registration.md).