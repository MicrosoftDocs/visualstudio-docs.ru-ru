---
title: Прерывание изменений API в предварительной версии Visual Studio 2022
description: Сведения об изменениях API, которые приводят к сбою компиляции существующих расширений VS при переносе расширений в предварительную версию Visual Studio 2022.
ms.date: 06/08/2021
ms.topic: reference
author: leslierichardson95
ms.author: lerich
manager: jmartens
monikerRange: vs-2022
ms.workload:
- vssdk
ms.openlocfilehash: 9427b7a75ad53fc9a0795b249d96431113aba36d
ms.sourcegitcommit: 5fb4a67a8208707e79dc09601e8db70b16ba7192
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/17/2021
ms.locfileid: "112308625"
---
# <a name="breaking-api-changes-in-visual-studio-2022"></a>Прерывание изменений API в Visual Studio 2022

[!INCLUDE [preview-note](../includes/preview-note.md)]

Если вы переносите расширение в Visual Studio 2022, здесь могут повлиять критические изменения.

## <a name="reference-assemblies-no-longer-installed"></a>Ссылочные сборки больше не устанавливаются

Многие из сборок, которые могли быть связаны с тем, что MSBuild, разрешенный из каталога установки Visual Studio, больше не устанавливаются. Для получения необходимых справочных сборок пакета SDK для Visual Studio необходимо использовать NuGet. Подробные инструкции по выполнению этой задачи см. в разделе [проекты модернизировать](update-visual-studio-extension.md#modernize-your-vsix-project) .

## <a name="removed-apis"></a>Удаленные API

В Visual Studio 2022 в процессе перемещения Visual Studio были удалены некоторые API-интерфейсы. Список удаленных API-интерфейсов можно найти на странице [список удаленных API](removed-api-list.md) .

## <a name="interop-breaking-changes"></a>Критические изменения во взаимодействии

Многие наши API изменились в Visual Studio 2022, обычно с простыми изменениями, которые достаточно просты для размещения кода.

Для управления критическими изменениями мы планируем предоставить новый механизм распространения сборок взаимодействия. В частности, для Visual Studio 2022 и более поздних версиях мы предоставляем одну сборку взаимодействия с определениями для многих распространенных общедоступных интерфейсов Visual Studio. Эта сборка содержит управляемые определения для многих интерфейсов Visual Studio, перемещаемых из нескольких сборок взаимодействия. Новая сборка взаимодействия распространяется с помощью `Microsoft.VisualStudio.Interop` пакета NuGet.

Однако компоненты Visual Studio, которые в основном используются в собственных контекстах и имеют небольшое количество критических изменений, по-прежнему будут иметь свои собственные сборки взаимодействия (например, сборка отладчика будет VisualStudio.Debugger.Interop.dll, как это делается сегодня). В любом случае на сборки можно ссылаться из приложения так же, как и сегодня.

Это существенное изменение и означает, что расширения, использующие интерфейсы API в и сборки, созданные в этом новом подходе, несовместимы с более старыми версиями Visual Studio, используя предыдущую сборку взаимодействия.

Это дает несколько очень важных преимуществ, которые упрощают обновление расширения до Visual Studio 2022:

- Все неработающие интерфейсы API становятся ошибками во время сборки, что упрощает их поиск и исправление.
- Вам нужно только обновить код, использующий API, который был нарушен в Visual Studio 2022.
- Вы не сможете случайно использовать старый, уже неработающий API.

В целом эти изменения приведут к более стабильной версии Visual Studio для всех пользователей. Главным недостатком этого подхода является то, что управляемые сборки не смогут работать в Visual Studio 2019 и Visual Studio 2022, не выполняя компиляцию кода один раз для каждой целевой версии Visual Studio.

При работе с ошибками компиляции из-за различий API между Visual Studio 2019 и Visual Studio 2022 вы можете найти приведенный ниже API или шаблон с рекомендациями по их устранению.

### <a name="int-or-uint-where-intptr-is-expected"></a>`int` или `uint` `IntPtr` , где ожидается

Мы планируем, что это будет очень распространенной ошибкой. Чтобы сделать Visual Studio 2022 64-битным процессом, некоторые из наших интерфейсов API взаимодействия пришлось исправить, когда предполагается, что указатель помещается в 32-разрядное целое число для фактического использования значения размера указателя.

Пример сообщения об ошибке:

> Аргумент 3: не удается преобразовать из "uint" в "out System. IntPtr"

Просто обновите код, чтобы `IntPtr` `UIntPtr` `int` `uint` он заменялся или был использован для устранения перерыва.

Пример исправления:

```diff
-shell.LoadLibrary(myGuid, myFlags, out uint ptrLib);
+shell.LoadLibrary(myGuid, myFlags, out IntPtr ptrLib);
```

### <a name="an-interop-type-defined-in-two-assemblies"></a>Тип взаимодействия, определенный в двух сборках

Когда компилятор C# сообщает об ошибке, что тип, который вы используете, определен в двух сборках, возможно, вы ссылаетесь на сборку из версии пакета SDK для Visual Studio 2019, которая больше не должна ссылаться на нее.

Пример сообщения об ошибке:

> Ошибка CS0433: тип "Ивсдпиаваре" существует как в обоих "Microsoft. VisualStudio. Interop, Version = 17.0.0.0, Culture = Neutral, PublicKeyToken = b03f5f7f11d50a3a", так и в Microsoft. VisualStudio. Shell. Interop. видимости. DesignTime, Version = 16.0.0.0, культуре = Neutral, PublicKeyToken = b03f5f7f11d50a3a "

Сведения о том, какое имя сборки является предпочтительным в Visual Studio 2022, см. в таблице повторного [сопоставления ссылочной сборки](migrated-assemblies.md) .
Учитывая две сборки, названные в приведенной выше ошибке примера, и просмотрев эту таблицу, обратите внимание, что `Microsoft.VisualStudio.Interop` это новое имя сборки. После этого исправление будет удалено `Microsoft.VisualStudio.Shell.Interop.16.0.DesignTime` из проекта.

В некоторых случаях мы предлагаем пакет Visual Studio версии 2022 для устаревшей сборки, содержащей серверы пересылки типов. При наличии такой возможности можно *Обновить* ссылку на пакет до версии Visual Studio 2022, а не удалять ее. Серверы пересылки типов будут разрешать ошибку от компилятора.

Помните, что иногда эти ссылки могут поступать из транзитного справочника по пакетам, поэтому их удаление может быть сложнее, чем прямая ссылка, сделанная в файле проекта. В таких случаях убедитесь, что все прямые ссылки на пакеты используют сами пакеты SDK для Visual Studio 2022. Чтобы найти цепочку пакетов, ответственных за подключение к устаревшей сборке, можно обратиться к *project.assets.json* . Обновление транзитной ссылки на пакет в Visual Studio 2022 — это просто установка в качестве прямой ссылки.

Если невозможно изменить дерево зависимостей (например, из-за наличия зависимости от стороннего разработчика), можно добавить прямую ссылку на пакет для пакета предварительной версии Visual Studio 2022 и добавить `ExcludeAssets="compile"` в этот `PackageReference` элемент метаданные для устранения ошибки компилятора. Но помните, что при использовании этого метода расширение может хранить зависимость от предварительной версии сборки 2022 в Visual Studio, и расширение может не работать во время выполнения.

### <a name="missing-reference-to-an-interop-assembly"></a>Отсутствует ссылка на сборку взаимодействия

При ссылке на сборку, скомпилированную для предварительной версии пакета SDK для Visual Studio 2022, может появиться сообщение об ошибке об отсутствующей ссылке на сборку.

Пример сообщения об ошибке:

> Ошибка CS0012. тип "Ивстекствиевфилтер" определен в сборке, на которую нет ссылок. Необходимо добавить ссылку на сборку "Microsoft. VisualStudio. TextManager. Interop, версия = 7.1.40304.0, язык и региональные параметры = нейтральный, PublicKeyToken = b03f5f7f11d50a3a"

С помощью [таблицы сопоставления ссылочной сборки](migrated-assemblies.md)можно убедиться, что запрошенная сборка на самом деле не является таковой.

Самое лучшее решение — обновить зависимость до версии, которая была скомпилирована для пакета SDK для Visual Studio 2022, чтобы удаленная сборка взаимодействия больше не запрашивалась компилятором.

В некоторых случаях мы предлагаем пакет Visual Studio версии 2022 для устаревшей сборки, содержащей серверы пересылки типов. Если эта возможность доступна, можно добавить ссылку на пакет для версии Visual Studio 2022 устаревшего пакета, чтобы серверы пересылки могли разрешить эту ошибку из компилятора.

### <a name="iasyncserviceprovider-is-missing"></a>`IAsyncServiceProvider` отсутствует

Существует два определения этого интерфейса в двух пространствах имен. Только один из них предназначен для управляемого потребления.

Пространство имен Visual Studio 2019 | Пространство имен Visual Studio 2022 | предполагаемое использование;
--|--|--
Microsoft. VisualStudio. Shell. Иасинксервицепровидер | Microsoft. VisualStudio. Shell. Иасинксервицепровидер | Потребление управляемого кода
Microsoft. VisualStudio. Shell. Interop. Иасинксервицепровидер | Microsoft. VisualStudio. Shell. Комасинксервицепровидер. Иасинксервицепровидер | только низкий уровень взаимодействия

Если отображается сообщение об ошибке `IAsyncServiceProvider` , *возможно* , вы использовали тот, который был предназначен для машинного кода (вторая строка).
Если это так, можно обновить новое пространство имен или переключиться на более управляемый интерфейс.

### <a name="dte-and-_dte-type-cast-failures"></a>`DTE` и `_DTE` ошибки приведения типов

`DTE` и `_DTE` являются интерфейсами. Один из них является производным от другого. Однако в Visual Studio 2022 базовый и производные типы меняются местами.
Это приводит к сбою определенных назначений или приведения типов.

Это также означает, где вы использовали для использования `new DTE()` , теперь необходимо использовать `new _DTE()` .

### <a name="missing-argument-on-a-method-invocation"></a>Отсутствует аргумент для вызова метода

Несколько методов больше не объявляют аргументы по умолчанию для необязательных параметров в API взаимодействия.
Если вы получаете ошибку о пропущенном аргументе для вызова COM-взаимодействия и параметр вызывается для `object` типа, предыдущее значение по умолчанию, которое было определено в интерфейсе API взаимодействия Visual Studio 2019 `""` , возможно, стоит добавить в `""` качестве аргумента для разрешения ошибки компиляции.

Если вы сомневаетесь в том, что использует аргумент по умолчанию, попробуйте переключить контекст языковой службы с Visual Studio 2022 на Visual Studio 2019, чтобы получить возможность IntelliSense с более старыми сборками взаимодействия, чтобы увидеть, какой аргумент по умолчанию был, а затем добавить его в код явным образом. Он будет работать нормально при компиляции для Visual Studio 2019, но теперь будет компилироваться для Visual Studio 2022.

Пример исправления:

```diff
-process4.Attach2();
+process4.Attach2("");
```
