---
title: Учебник по Docker. Часть 6. Мультиконтейнерные приложения
description: Настройка сети между контейнерами и добавление контейнера для базы данных MySQL.
ms.date: 08/04/2020
author: nebuk89
ms.author: ghogen
manager: jmartens
ms.topic: conceptual
ms.workload:
- azure
ms.openlocfilehash: d23d1f5d94729741630ee76263fd5b32041e9cfd
ms.sourcegitcommit: 8b75524dc544e34d09ef428c3ebbc9b09f14982d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2021
ms.locfileid: "113222920"
---
# <a name="multi-container-apps"></a>Создание многоконтейнерного приложения

До этого момента вы работали с одноконтейнерными приложениями. Теперь же вы добавите MySQL в стек приложений. Часто возникает следующий вопрос: "Где будет выполняться MySQL? Следует ли устанавливать его в том же контейнере или выполнять его отдельно?" В целом **каждый контейнер должен выполнять одно и то же действие.** Несколько причин:

- Есть шанс, что вам придется масштабировать API и внешние интерфейсы по-другому, чем базы данных.
- Отдельные контейнеры позволяют изолировать и обновлять версии.
- Хотя контейнер для базы данных можно использовать локально, может потребоваться использовать управляемую службу для базы данных в рабочей среде. Вы не хотите поставлять ядро СУБД вместе с приложением.
- Для выполнения нескольких процессов потребуется диспетчер процессов (контейнер запускает только один процесс), что усложняет запуск и завершение контейнера.

И это далеко не все причины. Поэтому вы обновите приложение так, чтобы оно работало следующим образом:

![Приложение Todo, подключенное к контейнеру MySQL](media/multi-app-architecture.png)

## <a name="container-networking"></a>Работа с контейнерами в сети

Помните, что контейнеры по умолчанию работают изолированно и не имеют никакого представления о других процессах или контейнерах на одном компьютере. Итак, как организовать взаимодействие одного контейнера с другим? Ответ — **через сеть**. Вам не нужно быть сетевым инженером (ура!). Просто запомните это правило...

> [!NOTE]
> Если два контейнера находятся в одной сети, они могут взаимодействовать друг с другом. В противном случае они не могут.

## <a name="start-mysql"></a>Запустите MySQL.

Существует два способа размещения контейнера в сети: назначить его при запуске или подключить существующий контейнер. Сейчас вы создадите сеть и присоедините контейнер MySQL при запуске.

1. Создайте сеть.

    ```bash
    docker network create todo-app
    ```

1. Запустите контейнер MySQL и подключите его к сети. Мы также определим несколько переменных среды, которые база данных будет использовать для инициализации (см. раздел "Переменные среды" в [перечне MySQL Docker Hub](https://hub.docker.com/_/mysql/)) (замените символы ` \ ` на `` ` `` в Windows PowerShell).

    ```bash
    docker run -d \
        --network todo-app --network-alias mysql \
        -v todo-mysql-data:/var/lib/mysql \
        -e MYSQL_ROOT_PASSWORD=secret \
        -e MYSQL_DATABASE=todos \
        mysql:5.7
    ```

    Вы также увидите, что указали флаг `--network-alias`. Мы вернемся к этому чуть позже.

    > [!TIP]
    > Вы увидите, что вы используете имя тома `todo-mysql-data` и подключаете его к `/var/lib/mysql`, где MySQL хранит свои данные. Однако вы никогда не выполняли команду `docker volume create`. Docker распознает, что вы хотите использовать именованный том, и автоматически создает его.

1. Чтобы убедиться, что база данных работает, подключитесь к базе данных и убедитесь, что она подключена.

    ```bash
    docker exec -it <mysql-container-id> mysql -p
    ```

    Когда появится запрос на ввод пароля, введите **secret**. В интерпретаторе MySQL выведите список баз данных и убедитесь, что вы видите базу данных `todos`.

    ```cli
    mysql> SHOW DATABASES;
    ```

    Вы должны получить следующий результат:

    ```plaintext
    +--------------------+
    | Database           |
    +--------------------+
    | information_schema |
    | mysql              |
    | performance_schema |
    | sys                |
    | todos              |
    +--------------------+
    5 rows in set (0.00 sec)
    ```

    Поздравляем! У вас есть база данных `todos` и она готова к использованию!

## <a name="connect-to-mysql"></a>Подключение к MySQL

Теперь, когда вы умеете работать с MySQL, давайте использовать его! Но как? Если запущен другой контейнер в той же сети, как найти контейнер (помните, что каждый контейнер имеет свой собственный IP-адрес)?

Чтобы выяснить это, воспользуемся контейнером [nicolaka/netshoot](https://github.com/nicolaka/netshoot), который входит в состав *многих* средств, полезных для устранения неполадок или отладки сетевых проблем.

1. Запустите новый контейнер с помощью образа `nicolaka/netshoot`. Обязательно подключите его к той же сети.

    ```bash
    docker run -it --network todo-app nicolaka/netshoot
    ```

1. В контейнере используйте команду `dig`, которая является полезным средством DNS. Найдите IP-адрес для имени узла `mysql`.

    ```bash
    dig mysql
    ```

    И вы получите вывод, подобный этому...

    ```text
    ; <<>> DiG 9.14.1 <<>> mysql
    ;; global options: +cmd
    ;; Got answer:
    ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 32162
    ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

    ;; QUESTION SECTION:
    ;mysql.             IN  A

    ;; ANSWER SECTION:
    mysql.          600 IN  A   172.23.0.2

    ;; Query time: 0 msec
    ;; SERVER: 127.0.0.11#53(127.0.0.11)
    ;; WHEN: Tue Oct 01 23:47:24 UTC 2019
    ;; MSG SIZE  rcvd: 44
    ```

    В разделе "ANSWER SECTION" вы увидите запись `A` для `mysql`, которая разрешается в `172.23.0.2` (ваш IP-адрес, скорее всего, будет иметь другое значение). Хотя `mysql` не является допустимым именем узла, Docker удалось разрешить его IP-адресу контейнера, который имел этот сетевой псевдоним (вспомните флаг `--network-alias`, который использовался ранее).

    Это означает, что ваше приложение просто должно подключаться к узлу с именем `mysql` и обращаться к базе данных. На самом деле нет ничего проще!

## <a name="run-your-app-with-mysql"></a>Запуск приложения с помощью MySQL

Приложение Todo поддерживает настройку нескольких переменных среды для указания параметров подключения MySQL. К ним относятся:

- `MYSQL_HOST` — имя узла для работающего сервера MySQL.
- `MYSQL_USER` — имя пользователя, используемое для подключения.
- `MYSQL_PASSWORD` — пароль, используемый для подключения.
- `MYSQL_DB` — база данных, которая будет использоваться после подключения.

> [!WARNING]
> **Настройка параметров подключения с помощью переменных среды**. Использование переменных среды для установки параметров подключения обычно подходит для разработки, тогда как при запуске приложений в рабочей среде это не рекомендуется. Чтобы понять причину, см. раздел [Почему не следует использовать переменные среды для данных секрета](https://diogomonica.com/2017/03/27/why-you-shouldnt-use-env-variables-for-secret-data/).
> Более безопасный механизм заключается в использовании поддержки секрета, предоставляемой платформой оркестрации контейнеров. В большинстве случаев эти секреты подключаются как файлы в работающем контейнере. Вы увидите, что многие приложения (включая образ MySQL и приложение Todo) также поддерживают переменные среды с суффиксом `_FILE`, который указывает на файл, содержащий файл.
> Например, установка переменной `MYSQL_PASSWORD_FILE` приведет к тому, что приложение будет использовать содержимое файла, на который указывает ссылка, в качестве пароля подключения. Docker не делает ничего для поддержки этих переменных среды. Приложение должно знать, что нужно найти переменную и получить содержимое файла.

Используя все эти объяснения, запустите контейнер, готовый для разработки.

1. Укажите каждую из переменных среды, приведенных выше, и подключите контейнер к сети приложений (замените символы ` \ ` на `` ` `` в Windows PowerShell).

    ```bash hl_lines="3 4 5 6 7"
    docker run -dp 3000:3000 \
      -w /app -v ${PWD}:/app \
      --network todo-app \
      -e MYSQL_HOST=mysql \
      -e MYSQL_USER=root \
      -e MYSQL_PASSWORD=secret \
      -e MYSQL_DB=todos \
      node:12-alpine \
      sh -c "yarn install && yarn run dev"
    ```

1. Если просмотреть журналы для контейнера (`docker logs <container-id>`), вы увидите сообщение, указывающее, что используется база данных MySQL.

    ```plaintext hl_lines="7"
    # Previous log messages omitted
    $ nodemon src/index.js
    [nodemon] 1.19.2
    [nodemon] to restart at any time, enter `rs`
    [nodemon] watching dir(s): *.*
    [nodemon] starting `node src/index.js`
    Connected to mysql db at host mysql
    Listening on port 3000
    ```

1. Откройте приложение в браузере и добавьте несколько элементов в список дел.

1. Подключитесь к базе данных MySQL и подтвердите, что элементы записываются в базу данных. Помните, что пароль — **secret**.

    ```bash
    docker exec -ti <mysql-container-id> mysql -p todos
    ```

    В оболочке MySQL выполните следующую команду:

    ```plaintext
    mysql> select * from todo_items;
    +--------------------------------------+--------------------+-----------+
    | id                                   | name               | completed |
    +--------------------------------------+--------------------+-----------+
    | c906ff08-60e6-44e6-8f49-ed56a0853e85 | Do amazing things! |         0 |
    | 2912a79e-8486-4bc3-a4c5-460793a575ab | Be awesome!        |         0 |
    +--------------------------------------+--------------------+-----------+
    ```

    Очевидно, что таблица будет выглядеть иначе, так как она содержит элементы. Но вы должны увидеть, что они хранятся!

Если взглянуть на расширение Docker, вы увидите, что у вас работают два контейнера приложений. Но нет никакой реальной индикации того, что они сгруппированы в одном приложении. Вы узнаете, как сделать это лучше в ближайшее время!

![Расширение Docker, демонстрирующее два несгруппированных контейнера приложений](media/vs-multi-container-app.png)

## <a name="recap"></a>Резюме

На этом этапе у вас есть приложение, которое теперь хранит свои данные во внешней базе данных, работающей в отдельном контейнере. Вы узнали немного о сетях контейнеров и увидели, как можно выполнять обнаружение служб с помощью DNS.

Однако существует вероятность того, что запуск этого приложения может показаться вам достаточно сложным. Необходимо создать сеть, запустить контейнеры, указать все переменные среды, предоставить порты и многое другое. Много чего нужно запомнить, и, безусловно, это затрудняет передачу другим людям.

В следующем разделе мы поговорим о Docker Compose. С помощью Docker Compose можно значительно упростить общий доступ к стекам приложений и позволить другим запускать их с помощью одной (и простой) команды.

## <a name="next-steps"></a>Дальнейшие действия

Продолжайте изучать учебник.

> [!div class="nextstepaction"]
> [Использование Docker Compose](use-docker-compose.md)
